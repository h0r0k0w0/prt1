name: Claude AI Assistant Debug

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  claude-response:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug Environment
      run: |
        echo "=== ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ ==="
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "APIã‚­ãƒ¼å­˜åœ¨: ${{ secrets.ANTHROPIC_API_KEY != '' }}"
        echo "GitHubãƒˆãƒ¼ã‚¯ãƒ³å­˜åœ¨: ${{ secrets.GITHUB_TOKEN != '' }}"
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        echo "=== ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ==="
        npm init -y
        npm install @anthropic-ai/sdk
        echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
        
    - name: Simple Test
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: |
        echo "=== ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ ==="
        cat << 'EOF' > test-script.js
        console.log('ğŸš€ ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹');
        
        // ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
        console.log('Node.js version:', process.version);
        console.log('APIã‚­ãƒ¼è¨­å®š:', process.env.ANTHROPIC_API_KEY ? 'ã‚ã‚Š' : 'ãªã—');
        console.log('GitHubãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š:', process.env.GITHUB_TOKEN ? 'ã‚ã‚Š' : 'ãªã—');
        
        // GitHub Contextã®ç¢ºèª
        try {
          const context = JSON.parse(process.env.GITHUB_CONTEXT || '{}');
          console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', context.event_name);
          console.log('ãƒªãƒã‚¸ãƒˆãƒª:', context.repository?.full_name);
          
          let issueBody = '';
          if (context.event_name === 'issues') {
            issueBody = context.event.issue?.body || '';
            console.log('Issueæœ¬æ–‡ï¼ˆæœ€åˆã®50æ–‡å­—ï¼‰:', issueBody.substring(0, 50));
          } else if (context.event_name === 'issue_comment') {
            issueBody = context.event.comment?.body || '';
            console.log('ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼ˆæœ€åˆã®50æ–‡å­—ï¼‰:', issueBody.substring(0, 50));
          }
          
          if (!issueBody.includes('@claude')) {
            console.log('âŒ @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãªã— - å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—');
            process.exit(0);
          }
          
          console.log('âœ… @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç™ºè¦‹');
          
        } catch (error) {
          console.error('âŒ GitHub Contextè§£æã‚¨ãƒ©ãƒ¼:', error.message);
          process.exit(1);
        }
        
        // Anthropic SDKã®ãƒ†ã‚¹ãƒˆ
        try {
          console.log('ğŸ“¦ Anthropic SDKèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ...');
          const Anthropic = require('@anthropic-ai/sdk');
          console.log('âœ… SDKèª­ã¿è¾¼ã¿æˆåŠŸ');
          
          if (!process.env.ANTHROPIC_API_KEY) {
            throw new Error('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          }
          
          const anthropic = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
          });
          console.log('âœ… Anthropicã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æˆåŠŸ');
          
          // ç°¡å˜ãªAPIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
          console.log('ğŸ¤– Claude APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ...');
          const response = await anthropic.messages.create({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 100,
            messages: [{
              role: 'user',
              content: 'ã“ã‚“ã«ã¡ã¯ï¼çŸ­ãæŒ¨æ‹¶ã—ã¦ãã ã•ã„ã€‚'
            }]
          });
          
          console.log('âœ… APIå‘¼ã³å‡ºã—æˆåŠŸ');
          console.log('è¿”ç­”:', response.content[0].text);
          
        } catch (error) {
          console.error('âŒ Anthropic SDK ã‚¨ãƒ©ãƒ¼:', error.message);
          console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
          process.exit(1);
        }
        
        console.log('ğŸ‰ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆå®Œäº†ï¼');
        EOF
        
        node test-script.js
