name: Claude AI Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  claude-response:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install @anthropic-ai/sdk
        
    - name: Run Claude AI Assistant
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: |
        cat << 'EOF' > claude-assistant.js
        const Anthropic = require('@anthropic-ai/sdk');
        const https = require('https');
        
        async function main() {
          try {
            console.log('ğŸš€ Claude Assistant é–‹å§‹');
            
            // ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
            console.log('APIã‚­ãƒ¼å­˜åœ¨ç¢ºèª:', !!process.env.ANTHROPIC_API_KEY);
            console.log('GitHubãƒˆãƒ¼ã‚¯ãƒ³å­˜åœ¨ç¢ºèª:', !!process.env.GITHUB_TOKEN);
            
            if (!process.env.ANTHROPIC_API_KEY) {
              throw new Error('âŒ ANTHROPIC_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            if (!process.env.GITHUB_CONTEXT) {
              throw new Error('âŒ GITHUB_CONTEXT ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            const context = JSON.parse(process.env.GITHUB_CONTEXT);
            console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—:', context.event_name);
            
            let issueBody = '';
            let issueNumber = null;
            
            if (context.event_name === 'issues') {
              issueBody = context.event.issue?.body || '';
              issueNumber = context.event.issue?.number;
              console.log('Issueã‚¤ãƒ™ãƒ³ãƒˆ - ç•ªå·:', issueNumber);
            } else if (context.event_name === 'issue_comment') {
              issueBody = context.event.comment?.body || '';
              issueNumber = context.event.issue?.number;
              console.log('ã‚³ãƒ¡ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ - ç•ªå·:', issueNumber);
            }
            
            console.log('æœ¬æ–‡ï¼ˆæŠœç²‹ï¼‰:', issueBody.substring(0, 100));
            
            // @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            if (!issueBody.includes('@claude')) {
              console.log('âŒ @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - å‡¦ç†çµ‚äº†');
              return;
            }
            
            console.log('âœ… @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç™ºè¦‹');
            
            // Anthropic ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });
            
            const message = issueBody.replace(/@claude/g, '').trim();
            console.log('Claudeã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·:', message.length);
            
            console.log('ğŸ¤– Claude APIå‘¼ã³å‡ºã—é–‹å§‹...');
            const response = await anthropic.messages.create({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              messages: [{
                role: 'user',
                content: `ä»¥ä¸‹ã®GitHubã®èª²é¡Œã«ã¤ã„ã¦ã€æŠ€è¡“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š\n\n${message}`
              }]
            });
            
            const reply = response.content[0].text;
            console.log('âœ… Claude ã‹ã‚‰ã®è¿”ç­”ã‚’å–å¾—ï¼ˆé•·ã•: ' + reply.length + 'æ–‡å­—ï¼‰');
            
            // GitHub APIã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            const repoFullName = context.repository.full_name;
            console.log('ãƒªãƒã‚¸ãƒˆãƒª:', repoFullName);
            
            const commentData = JSON.stringify({
              body: `ğŸ¤– **Claude AI Assistant**\n\n${reply}`
            });
            
            const options = {
              hostname: 'api.github.com',
              port: 443,
              path: `/repos/${repoFullName}/issues/${issueNumber}/comments`,
              method: 'POST',
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(commentData),
                'User-Agent': 'Claude-Assistant'
              }
            };
            
            console.log('ğŸ“¤ GitHub APIã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ä¸­...');
            
            await new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => data += chunk);
                res.on('end', () => {
                  console.log('GitHub API ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', res.statusCode);
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    console.log('âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æˆåŠŸï¼');
                    resolve();
                  } else {
                    console.error('âŒ GitHub API ã‚¨ãƒ©ãƒ¼:', data);
                    reject(new Error(`GitHub API ã‚¨ãƒ©ãƒ¼: ${res.statusCode} - ${data}`));
                  }
                });
              });
              
              req.on('error', (error) => {
                console.error('âŒ HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error.message);
                reject(error);
              });
              
              req.write(commentData);
              req.end();
            });
            
            console.log('ğŸ‰ å‡¦ç†å®Œäº†ï¼');
            
          } catch (error) {
            console.error('âŒ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼:', error.message);
            console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            process.exit(1);
          }
        }
        
        main();
        EOF
        
        node claude-assistant.js
