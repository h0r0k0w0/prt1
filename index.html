<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>メンタライズ訓練システム</title>

  <!-- ① Import Map  : 裸インポートをブラウザで解決  -->
  <script type="importmap">
  {
  "imports": {
    "@supabase/supabase-js"  : "https://esm.sh/@supabase/supabase-js@2",
    "@supabase/auth-js"      : "https://esm.sh/@supabase/auth-js@2",
    "@supabase/postgrest-js" : "https://esm.sh/@supabase/postgrest-js@1",
    "@supabase/realtime-js"  : "https://esm.sh/@supabase/realtime-js@2",
    "@supabase/storage-js"   : "https://esm.sh/@supabase/storage-js@2",
    "@supabase/functions-js" : "https://esm.sh/@supabase/functions-js@2"
  }
}

  </script>
<!--   <div id="surveyContainer" style="display: none; padding: 1em; background: #f9f9f9;"></div> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .mode-selector {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }

        .mode-btn.participant {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .nav {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .nav.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .admin-config {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .admin-config h3 {
            color: #856404;
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .participant-interface {
            max-width: 800px;
            margin: 0 auto;
        }

        .participant-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .experiment-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .scenario-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .scenario-card p {
            line-height: 1.6;
            color: #6c757d;
        }

        .chat-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background: #e9ecef;
            color: #495057;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            background: #f8f9fa;
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #e9ecef;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .mode-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
    <div id="surveyContainer" style="display: none; padding: 1em; background: #f9f9f9;"></div>
        <div class="header">
            <h1>🧠 メンタライズ訓練システム</h1>
            <p>他者の認知と感情を理解する能力を向上させましょう</p>
        </div>

        <!-- モード選択画面 -->
        <div id="modeSelector" class="mode-selector">
            <h2 style="margin-bottom: 20px; color: #495057;">実験参加者の方へ</h2>
            <p style="margin-bottom: 30px; color: #6c757d; font-size: 18px;">
                メンタライズ訓練実験にご参加いただき、ありがとうございます。<br>
                下のボタンから実験を開始してください。
            </p>
            <div class="mode-buttons">
                <button id="participantBtn" class="mode-btn participant" style="transform: scale(1.1); margin-bottom: 30px;">
                    🎯 実験を開始する<br>
                    <small>メンタライズ訓練実施</small>
                </button>
            </div>
            
            <!-- 管理者アクセス -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e9ecef;">
                <details style="text-align: left; max-width: 400px; margin: 0 auto;">
                    <summary style="cursor: pointer; color: #6c757d; font-size: 14px; text-align: center;">
                        研究者・管理者の方はこちら
                    </summary>
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <div class="form-group">
                            <label for="adminPassword" style="font-size: 14px;">管理者パスワード</label>
                            <input type="password" id="adminPassword" placeholder="パスワードを入力" style="margin-bottom: 15px;">
                        </div>
                        <button id="adminAccessBtn" class="btn" style="width: 100%; font-size: 14px; padding: 10px;">
                            🔧 管理者モードにアクセス
                        </button>
                        <div id="adminAccessError" style="margin-top: 10px;"></div>
                    </div>
                </details>
            </div>
        </div>

        <!-- 管理者ナビゲーション -->
        <div id="adminNav" class="nav">
            <div class="nav-buttons">
                <button id="adminConfigNav" class="nav-btn active">🔧 システム設定</button>
                <button id="adminScenariosNav" class="nav-btn">📝 シナリオ管理</button>
                <button id="adminLogsNav" class="nav-btn">📋 データ閲覧</button>
                <button id="adminSurveysNav" class="nav-btn">アンケート</button>

            </div>
        </div>

        <!-- 被験者ナビゲーション -->
        <div id="participantNav" class="nav">
            <div class="nav-buttons">
                <button id="participantStartNav" class="nav-btn active">🚀 実験開始</button>
            </div>
        </div>

        <div class="content">
            <!-- 管理者画面 -->
            <div id="adminConfig" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn" class="back-btn">← ログアウト</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        🔐 管理者モード
                    </div>
                </div>
                <h2>🔧 システム設定</h2>
                
                <div class="admin-config">
                    <h3>🔒 セキュリティ設定</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="newAdminPassword">管理者パスワードを変更</label>
                            <input type="password" id="newAdminPassword" placeholder="新しいパスワード">
                        </div>
                        <div class="form-group">
                            <label for="confirmAdminPassword">パスワード確認</label>
                            <input type="password" id="confirmAdminPassword" placeholder="パスワードを再入力">
                        </div>
                    </div>
                    <button id="changePasswordBtn" class="btn" style="background: #dc3545;">パスワードを変更</button>
                </div>

                <div class="admin-config">
                    <h3>🤖 AI API 設定</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="apiProvider">APIプロバイダー</label>
                            <select id="apiProvider">
                                <option value="openai">OpenAI</option>
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="custom">カスタムURL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adminApiKey">API キー</label>
                            <input type="password" id="adminApiKey" placeholder="APIキーを入力...">
                        </div>
                        <div class="form-group" id="customUrlGroup" style="display: none;">
                            <label for="customApiUrl">カスタムAPI URL</label>
                            <input type="text" id="customApiUrl" placeholder="https://api.example.com/v1/chat/completions">
                        </div>
                        <div class="form-group">
                            <label for="modelSelect">使用モデル</label>
                            <select id="modelSelect">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            </select>
                        </div>
                        <div class="form-group">
                          <label for="maxTokens">最大トークン数</label>
                          <input type="number" id="maxTokens" value="300" min="1">
                        </div>
                        <div class="form-group">
                          <label for="temperature">Temperature</label>
                          <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2">
                        </div>
                        <div class="form-group">
                          <label for="sessionTimeout">セッションタイムアウト (分)</label>
                          <input type="number" id="sessionTimeout" value="30" min="1">
                        </div>
                        <div class="form-group">
                          <label for="showTimer">セッション経過時間の表示</label><br>
                          <input type="checkbox" id="showTimer" checked>
                          <span>表示する</span>
                         </div>

                    </div>
                    <button id="saveConfigBtn" class="btn">設定を保存</button>
                </div>
                
                <div class="admin-config">
                    <h3>💬 システムプロンプト</h3>
                    <div class="form-group">
                        <label for="systemPrompt">基本指示</label>
                        <textarea id="systemPrompt" style="height: 150px;"></textarea>
                    </div>
                    <button id="savePromptBtn" class="btn">プロンプトを保存</button>
                </div>

                <div class="admin-config">
                    <h3>👥 セッション管理</h3>
                    <button id="showUserSessionsBtn" class="btn">ユーザーセッション一覧を表示</button>
                    <div id="userSessionsSection" style="display: none; margin-top: 20px;">
                        <h4>📋 ユーザーセッション一覧</h4>
                        <table id="userSessionsTable" border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">ユーザーID</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">開始日</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">最終更新</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="configStatus"></div>
            </div>

            <div id="adminScenarios" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn2" class="back-btn">← ログアウト</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        🔐 管理者モード
                    </div>
                </div>
                <h2>📝 シナリオ管理</h2>
                
                <div class="admin-config">
                    <h3>新しいシナリオを追加</h3>
                    <div class="form-group">
                        <label for="scenarioTitle">シナリオタイトル</label>
                        <input type="text" id="scenarioTitle" placeholder="例: 友人同士の会話">
                    </div>
                    <div class="form-group">
                        <label for="scenarioContent">シナリオ内容</label>
                        <textarea id="scenarioContent" placeholder="登場人物、状況、対話内容を詳細に記述してください"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="scenarioPromptQuestions">プロンプト用想定質問（改行区切り）</label>
                        <textarea id="scenarioPromptQuestions" placeholder="想定される質問1\n想定される質問2\n想定される質問3" style="height: 120px;"></textarea>
                        <small style="color: #6c757d;">エージェントが参考にする想定質問を入力してください</small>
                    </div>
                    <div class="form-group">
                        <label for="scenarioHiddenContext">隠れたコンテキスト・ニュアンス（自由記述）</label>
                        <textarea id="scenarioHiddenContext" placeholder="文章中には書かれていないが読み取れる背景情報、登場人物の心理状態、状況の詳細、暗黙の前提など、AIが理解すべき隠れた情報を自由に記述してください。" style="height: 100px;"></textarea>
                        <small style="color: #6c757d;">シナリオの深層的な意味やニュアンスを柔軟に記述できます</small>
                    </div>
                    <div class="form-group">
                        <label for="scenarioAnalysisPoints">分析時の着目点（自由記述）</label>
                        <textarea id="scenarioAnalysisPoints" placeholder="感情変化、人間関係の動き、コミュニケーションパターン、心理的メカニズムなど、特に注意深く分析すべき要素を自由に記述してください。" style="height: 100px;"></textarea>
                        <small style="color: #6c757d;">AIが分析する際に重点的に考慮すべきポイントを指定できます</small>
                    </div>
                    <button id="addScenarioBtn" class="btn">シナリオを追加</button>
                </div>

                <div id="scenarioList">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">シナリオを読み込み中...</div>
                </div>
            </div>

            <div id="adminSurveys" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn4" class="back-btn">← ログアウト</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        🔐 管理者モード
                    </div>
                </div>
                <h2>📊 アンケート管理</h2>
                
                <div class="admin-config">
                    <h3>新しいアンケートを追加</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="surveyDay">実験日</label>
                            <select id="surveyDay">
                                <option value="1">1日目</option>
                                <option value="2">2日目</option>
                                <option value="3">3日目</option>
                                <option value="4">4日目</option>
                                <option value="5">5日目</option>
                                <option value="6">6日目</option>
                                <option value="7">7日目</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>タイミング</label><br>
                            <input type="radio" name="surveyTiming" value="start" checked> 実験開始時<br>
                            <input type="radio" name="surveyTiming" value="end"> 実験終了時
                        </div>
                    </div>
                    
                    <div id="questionsContainer">
                        <h4>質問設定</h4>
                        <div class="question-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <div class="form-group">
                                <label>質問内容</label>
                                <textarea class="question-text" placeholder="質問を入力してください" style="height: 60px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label>回答形式</label>
                                <select class="question-type">
                                    <option value="text">自由記述</option>
                                    <option value="radio">単一選択</option>
                                    <option value="checkbox">複数選択</option>
                                    <option value="scale">数段階評価</option>
                                </select>
                            </div>
                            <div class="options-container" style="display: none;">
                                <label>選択肢（改行区切り）</label>
                                <textarea class="question-options" placeholder="選択肢1\n選択肢2\n選択肢3" style="height: 80px;"></textarea>
                            </div>
                            <div class="scale-container" style="display: none;">
                                <label>評価範囲</label>
                                <select class="scale-range">
                                    <option value="1-5">1-5段階</option>
                                    <option value="1-7">1-7段階</option>
                                    <option value="1-10">1-10段階</option>
                                </select>
                            </div>
                            <button type="button" class="btn remove-question" style="background: #dc3545; margin-top: 10px;">質問を削除</button>
                        </div>
                    </div>
                    
                    <button id="addQuestionBtn" class="btn" style="background: #28a745;">質問を追加</button>
                    <button id="saveSurveyBtn" class="btn">アンケートを保存</button>
                </div>
                
                <div class="admin-config">
                    <h3>既存のアンケート</h3>
                    <div id="surveysList"></div>
                </div>
                
                <div class="admin-config">
                    <h3>アンケート結果</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="resultParticipant">参加者ID</label>
                            <select id="resultParticipant">
                                <option value="">全ての参加者</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultDay">実験日</label>
                            <select id="resultDay">
                                <option value="">全ての日</option>
                                <option value="1">1日目</option>
                                <option value="2">2日目</option>
                                <option value="3">3日目</option>
                                <option value="4">4日目</option>
                                <option value="5">5日目</option>
                                <option value="6">6日目</option>
                                <option value="7">7日目</option>
                            </select>
                        </div>
                    </div>
                    <button id="loadSurveyResultsBtn" class="btn">結果を読み込み</button>
                    <div id="surveyResults" style="margin-top: 20px;"></div>
                </div>
            </div>
            <div id="adminLogs" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn3" class="back-btn">← ログアウト</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        🔐 管理者モード
                    </div>
                </div>
                <h2>📋 実験データ閲覧</h2>
                
                <div class="admin-config">
                    <h3>データフィルター</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="filterParticipant">参加者ID</label>
                            <select id="filterParticipant">
                                <option value="">全ての参加者</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterDay">実験日</label>
                            <select id="filterDay">
                                <option value="">全ての日</option>
                                <option value="1">1日目</option>
                                <option value="2">2日目</option>
                                <option value="3">3日目</option>
                                <option value="4">4日目</option>
                                <option value="5">5日目</option>
                                <option value="6">6日目</option>
                                <option value="7">7日目</option>
                            </select>
                        </div>
                    </div>
                    <button id="exportDataBtn" class="btn">📁 データをCSV出力</button>
                </div>

                <div id="experimentLogsList">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">実験データを読み込み中...</div>
                </div>
            </div>

            <!-- 被験者画面 -->
            <div id="participantStart" class="screen">
                <button id="backToModeBtn" class="back-btn">← モード選択に戻る</button>
                <div class="participant-interface">
                    <div class="participant-header">
                        <h2>🎯 メンタライズ訓練実験</h2>
                        <p>他者の心を理解する力を一緒に向上させましょう</p>
                    </div>

                    <div class="experiment-card">
                        <div id="participantSetup">
                            <h3>実験の設定</h3>
                            <div class="form-group">
                                <label for="participantId">参加者ID</label>
                                <input type="text" id="participantId" placeholder="例: P001">
                            </div>
                            <div class="form-group">
                                <label for="experimentDay">実験日</label>
                                <select id="experimentDay">
                                    <option value="1">1日目（自力メンタライズ）</option>
                                    <option value="2">2日目（エージェント支援）</option>
                                    <option value="3">3日目（エージェント支援）</option>
                                    <option value="4">4日目（エージェント支援）</option>
                                    <option value="5">5日目（エージェント支援）</option>
                                    <option value="6">6日目（エージェント支援）</option>
                                    <option value="7">7日目（自力メンタライズ）</option>
                                </select>
                            </div>
                            <button id="startExperimentBtn" class="btn">実験開始</button>
                        </div>

                        <!-- 実験実行中の画面 -->
                        <div id="experimentContent" style="display: none;">
                            <!-- セッション経過時間表示 -->
                            <div id="sessionTimer" style="display: none; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; font-family: monospace; font-size: 16px; font-weight: bold; color: #495057;">
                                ⏱️ 経過時間: <span id="timerDisplay">00:00:00</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            
                            <!-- シナリオ表示 -->
                            <div id="scenarioDisplay" class="scenario-card" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 id="currentScenarioTitle" style="margin: 0;"></h3>
                                    <button onclick="goBackToExperimentSetup()" class="btn" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">◀ 戻る</button>
                                </div>
                                <p id="currentScenarioContent"></p>
                            </div>

                            <!-- 自力分析画面 -->
                            <div id="selfMentalize" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">あなたの分析</h3>
                                    <button onclick="goBackToExperimentSetup()" class="btn" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">◀ 戻る</button>
                                </div>
                                <div class="form-group">
                                    <label for="userAnalysis">登場人物の気持ちや考えを分析してください</label>
                                    <textarea id="userAnalysis" placeholder="登場人物の感情、考え、動機などを自由に記述してください"></textarea>
                                </div>
                                <button id="submitAnalysisBtn" class="btn">分析を提出</button>
                            </div>

                            <!-- エージェント対話画面 -->
                            <div id="agentChat" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">エージェントとの対話</h3>
                                    <button onclick="goBackToExperimentSetup()" class="btn" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">◀ 戻る</button>
                                </div>
                                <div class="chat-container">
                                    <div class="chat-messages" id="chatMessages"></div>
                                    <div class="chat-input">
                                        <input type="text" id="chatInput" placeholder="メッセージを入力...">
                                        <button id="sendMessageBtn">送信</button>
                                    </div>
                                </div>
                                <button id="finishChatBtn" class="btn" style="margin-top: 15px; background: #28a745;">対話を終了する</button>
                            </div>
                            
                            <!-- 実験完了画面 -->
                            <div id="experimentComplete" style="display: none; text-align: center;">
                                <h3>🎉 実験完了</h3>
                                <p>本日の実験が完了しました。ご参加いただき、ありがとうございました。</p>
                                <button id="resetExperimentBtn" class="btn">新しい実験を開始</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    // グローバル変数
    let currentMode = 'none';
    let isAdminAuthenticated = false;
    let scenarios = [];
    let experimentLogs = [];
    let supabase = null;
    let isSupabaseAvailable = false;
    
    let adminConfig = {
        adminPassword: 'MentalizeAdmin2024!',
        apiProvider: 'openai',
        apiKey: '',
        customApiUrl: '',
        model: 'gpt-3.5-turbo',
        systemPrompt: 'あなたは心理学の専門家として、メンタライズ（他者の心の理解）を教えるエージェントです。学生の考えを肯定的に受け止め、より深い分析を促す質問をしてください。温かく支援的な口調で話してください。'
    };
    
    let currentScenarioIndex = 0;
    let currentDay = 1;
    let participantId = '';

    // デフォルトシナリオ
    const defaultScenarios = [
        {
            title: "友人同士の会話",
            content: "大学の図書館で、太郎と花子が期末試験について話している。太郎：「もう全然分からない。このままじゃ絶対に落ちる」花子：「大丈夫だよ、一緒に勉強しよう」太郎：「君は頭いいからそう言えるんだ」太郎は机に突っ伏し、花子は困った表情を浮かべている。",
            promptQuestions: [
                "太郎はなぜ不安になっているのでしょうか？",
                "花子の支援に対して太郎はどう反応すると思いますか？",
                "この状況で両者の関係はどう変化するでしょうか？"
            ],
            hiddenContext: "太郎は過去にテストで失敗した経験があり、自信を失っている。花子は太郎の性格を理解しており、優しくサポートしたいと思っている。花子は自分の努力を過小評価しがちで、太郎のコンプレックスを無意識に刺激してしまうことがある。",
            analysisPoints: "登場人物の感情変化、自尊心とコンプレックスの相互作用、支援の意図と受け手の反応のズレ、友人関係におけるコミュニケーションの困難さ"
        },
        {
            title: "職場での会話", 
            content: "オフィスで新入社員のA子と先輩のB男が話している。A子：「すみません、まだ理解できていません」B男：「もう3回説明したよね」A子は下を向き、B男は少しイライラした様子で腕を組んでいる。周りの同僚たちはその様子をちらちらと見ている。",
            promptQuestions: [
                "A子はなぜ理解できないのでしょうか？",
                "B男のイライラの背景には何があると思いますか？",
                "周りの同僚たちはどんな気持ちでしょうか？"
            ],
            hiddenContext: "A子は新卒で緊張しやすく、理解力が人よりも時間がかかるタイプだが、頑張り屋である。B男は中堅手で教えるのが上手ではないが、プレッシャーを感じている。周りの同僚たちは両者を心配しているが、介入すべきか迷っている。",
            analysisPoints: "新人特有のストレスと学習プロセス、指導する側のプレッシャーと教育スキルの不一致、職場の雰囲気と第三者の心理、権力関係が与える影響"
        }
    ];
    
    // サーベイデータ格納用
    let surveys = [];
    let surveyResults = [];


    // Supabase初期化
    // --- 方法B：ES Modules を import() で読み込む版 ---
   
//     async function initializeSupabase () {
//       if (globalThis.__supabase) {
//         supabase = globalThis.__supabase;          // すでに作成済み
//         return loadDataFromSupabase();
//       }
//       try {
//         const mod          = await import('@supabase/supabase-js');
//         // ImportMap により URL が解決される
        
//         const createClient =
//               mod.createClient           // 通常の名前付き
//            ?? mod.default?.createClient  // default がオブジェクト
//            ?? mod.default;               // default が関数
//         if (typeof createClient !== 'function') {
//           throw new Error('createClient not found in module');
//         }
        
//         const supabaseUrl  = 'https://ivlmmqsdnmvzermlrger.supabase.co';
//         const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bG1tcXNkbm12emVybWxyZ2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTg3MjMsImV4cCI6MjA2ODczNDcyM30.vAxSpIuxd2qQKGDM358Qlun1q0Tbh3919DLrawCB1M8'; // ★ anon キーを必ず使用

//         supabase            = createClient(supabaseUrl, supabaseAnonKey);

        
//         globalThis.__supabase = supabase; 
        
//         isSupabaseAvailable = true;
//         console.log('✅ Supabase 初期化成功');
// // ✅ admin_configのリアルタイム監視設定
// // ✅ 各設定のリアルタイム監視設定
//         const settingsToWatch = ['admin_config', 'scenarios', 'surveys'];
        
//         settingsToWatch.forEach((settingId) => {
//           supabase
//             .channel(`watch-${settingId}`)
//             .on(
//               'postgres_changes',
//               {
//                 event: '*',
//                 schema: 'public',
//                 table: 'admin_settings',
//                 filter: `id=eq.${settingId}`
//               },
//               async (payload) => {
//                 console.log(`🔄 ${settingId} が更新されました`);
//                 await loadDataFromSupabase(); // すべて再取得・再反映
//               }
//             )
//             .subscribe();
//         });



        

    //     await loadDataFromSupabase();
    //   } catch (err) {
    //     console.error('❌ Supabase 初期化エラー:', err);
    //     loadFromLocalStorage();
    //   }
    // }



    // Supabaseからデータを読み込み
    async function loadDataFromSupabase() {
        if (!supabase) {
            loadFromLocalStorage();
            return;
        }
        
        try {
            await loadAdminSettings();
            await loadScenarios();
            await loadExperimentLogs();
            
            loadAdminConfigUI();
            updateScenarioList();
            updateLogsList();
            
            console.log('✅ Supabaseからデータ読み込み完了');
        } catch (error) {
            console.error('❌ Supabaseデータ読み込みエラー:', error);
            loadFromLocalStorage();
        }
    }
    async function initializeSupabase () {
      if (globalThis.__supabase) {
        supabase = globalThis.__supabase;
        return loadDataFromSupabase();
      }
    
      try {
        const mod = await import('@supabase/supabase-js');
    
        const createClient =
              mod.createClient
           ?? mod.default?.createClient
           ?? mod.default;
    
        if (typeof createClient !== 'function') {
          throw new Error('createClient not found in module');
        }
    
        const supabaseUrl = 'https://ivlmmqsdnmvzermlrger.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bG1tcXNkbm12emVybWxyZ2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTg3MjMsImV4cCI6MjA2ODczNDcyM30.vAxSpIuxd2qQKGDM358Qlun1q0Tbh3919DLrawCB1M8'; // anon key を使用
    
        supabase = createClient(supabaseUrl, supabaseAnonKey);
        globalThis.__supabase = supabase;
        isSupabaseAvailable = true;
    
        console.log('✅ Supabase 初期化成功');
    
        // 🎯 3種類の設定を購読
        const settingsToWatch = ['admin_config', 'scenarios', 'surveys'];
    
        settingsToWatch.forEach((settingId) => {
          supabase
            .channel(`watch-${settingId}`)
            .on(
              'postgres_changes',
              {
                event: '*',
                schema: 'public',
                table: 'admin_settings',
                filter: `id=eq.${settingId}`
              },
              async (payload) => {
                console.log(`🔄 ${settingId} が更新されました`);
                await loadDataFromSupabase(); // 最新状態を再読み込み
              }
            )
            .subscribe();
        });
    
        await loadDataFromSupabase(); // 初期読み込み
      } catch (err) {
        console.error('❌ Supabase 初期化エラー:', err);
        loadFromLocalStorage();
      }
    }

      //ユーザーセッションの読み込み
    async function loadUserSessionsUI() {
      if (!supabase) {
        console.log('⚠️ Supabase未接続のため、ユーザーセッション一覧をスキップします');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('user_sessions')
          .select('*')
          .order('updated_at', { ascending: false }); // 最新更新順に変更
      
        if (error) {
          console.error('❌ ユーザーセッション取得失敗:', error);
          return;
        }
      
        const tbody = document.getElementById('userSessionsTable')?.querySelector('tbody');
        if (!tbody) {
          console.warn('⚠️ ユーザーセッションテーブルが見つかりません');
          return;
        }
        
        tbody.innerHTML = ''; // 一度クリア
      
        if (data && data.length > 0) {
          data.forEach(session => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="padding: 8px; border: 1px solid #ddd;">${session.user_id}</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${new Date(session.start_date).toLocaleString()}</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${new Date(session.updated_at).toLocaleString()}</td>
            `;
            tbody.appendChild(row);
          });
          console.log(`✅ ${data.length}件のユーザーセッションを表示しました`);
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="3" style="padding: 20px; text-align: center; color: #6c757d; border: 1px solid #ddd;">まだセッションデータがありません</td>
          `;
          tbody.appendChild(row);
        }
      } catch (err) {
        console.error('❌ ユーザーセッション読み込み中にエラー:', err);
      }
    }

    // 管理者設定を取得（fetchAdminConfigのエイリアス）
    async function fetchAdminConfig() {
        return await loadAdminSettings();
    }

    // Supabaseから管理者設定を読み込み
    async function loadAdminSettings() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'admin_config')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
                adminConfig = { ...adminConfig, ...data.settings };
              } else {
                console.log('admin_config 行が存在しないため、デフォルト設定を使用します');
            }
        } catch (error) {
            console.error('管理者設定読み込みエラー:', error);
        }
    }

    // Supabaseに管理者設定を保存
    async function saveAdminSettings() {
        if (!supabase) {
            localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'admin_config',
                    settings: adminConfig,
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('管理者設定保存エラー:', error);
            localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
        }
    }

    // Supabaseからシナリオを読み込み
    async function loadScenarios() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'scenarios')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
     // 行がある → 取得したシナリオを使用
              scenarios = data.settings.scenarios;
            } else {
       // 行が無い → デフォルトシナリオで初期化し、DB に保存
              scenarios = [...defaultScenarios];
              await saveScenarios();   // ここで行が作成される
            }
            
        } catch (error) {
            console.error('シナリオ読み込みエラー:', error);
            scenarios = [...defaultScenarios];
        }
    }

    // Supabaseにシナリオを保存
    async function saveScenarios() {
        if (!supabase) {
            localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'scenarios',
                    settings: { scenarios },
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('シナリオ保存エラー:', error);
            localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
        }
    }

    // Supabaseから実験ログを読み込み
    async function loadExperimentLogs() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('experiment_logs')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            experimentLogs = data || [];
        } catch (error) {
            console.error('実験ログ読み込みエラー:', error);
        }
    }

    // Supabaseに実験ログを保存
    async function saveExperimentLog(logData) {
        if (!supabase) {
            // ローカルストレージに保存
            const logs = JSON.parse(localStorage.getItem('mentalizeExperimentLogs') || '[]');
            const newLog = {
                id: Date.now(),
                participant_id: logData.participantId,
                day: logData.day,
                experiment_type: logData.experimentType,
                scenario_title: logData.scenarioTitle,
                data: {
                    analysis: logData.analysis,
                    chatHistory: logData.chatHistory,
                    model: adminConfig.model,
                    scenarioIndex: logData.scenarioIndex
                },
                created_at: new Date().toISOString()
            };
            logs.unshift(newLog);
            localStorage.setItem('mentalizeExperimentLogs', JSON.stringify(logs));
            experimentLogs = logs;
            updateLogsList();
            return;
        }
        
        try {
            await supabase
                .from('participants')
                .upsert({
                    id: logData.participantId,
                    last_access: new Date().toISOString()
                });

            const { error } = await supabase
                .from('experiment_logs')
                .insert({
                    participant_id: logData.participantId,
                    day: logData.day,
                    experiment_type: logData.experimentType,
                    scenario_title: logData.scenarioTitle,
                    data: {
                        analysis: logData.analysis,
                        chatHistory: logData.chatHistory,
                        model: adminConfig.model,
                        scenarioIndex: logData.scenarioIndex
                    }
                });
            
            if (error) throw error;
            await loadExperimentLogs();
            updateLogsList();
        } catch (error) {
            console.error('実験ログ保存エラー:', error);
            alert('データの保存に失敗しました。');
        }
    }

    // ローカルストレージから読み込み
    function loadFromLocalStorage() {
        // 管理者設定
        const savedConfig = localStorage.getItem('mentalizeAdminConfig');
        if (savedConfig) {
            try {
                adminConfig = { ...adminConfig, ...JSON.parse(savedConfig) };
            } catch (error) {
                console.warn('管理者設定読み込みエラー:', error);
            }
        }
        
        // シナリオ
        const savedScenarios = localStorage.getItem('mentalizeScenarios');
        if (savedScenarios) {
            try {
                scenarios = JSON.parse(savedScenarios);
            } catch (error) {
                scenarios = [...defaultScenarios];
            }
        } else {
            scenarios = [...defaultScenarios];
        }
        
        // 実験ログ
        const savedLogs = localStorage.getItem('mentalizeExperimentLogs');
        if (savedLogs) {
            try {
                experimentLogs = JSON.parse(savedLogs);
            } catch (error) {
                experimentLogs = [];
            }
        }
        
        // UIを更新
        loadAdminConfigUI();
        updateScenarioList();
        updateLogsList();
    }

    // モード選択
    function selectMode(mode) {
        if (mode === 'admin' && !isAdminAuthenticated) {
            alert('管理者認証が必要です');
            return;
        }
        
        currentMode = mode;
        document.getElementById('modeSelector').style.display = mode === 'none' ? 'block' : 'none';
        document.getElementById('adminNav').classList.toggle('active', mode === 'admin');
        document.getElementById('participantNav').classList.toggle('active', mode === 'participant');


        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });

        if (mode === 'admin') {
            showAdminScreen('adminConfig');
        } else if (mode === 'participant') {
            showParticipantScreen('participantStart');
        }
    }

    // 画面切り替え
    function showAdminScreen(screenId) {
        document.querySelectorAll('#adminNav .nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    function showParticipantScreen(screenId) {
        document.querySelectorAll('#participantNav .nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    // 管理者認証
    function attemptAdminAccess() {
        const inputPassword = document.getElementById('adminPassword').value;
        const errorDiv = document.getElementById('adminAccessError');
        
        if (!inputPassword) {
            errorDiv.innerHTML = '<div class="status error">パスワードを入力してください</div>';
            return;
        }
        
        if (inputPassword === adminConfig.adminPassword) {
            isAdminAuthenticated = true;
            errorDiv.innerHTML = '<div class="status success">認証成功！</div>';
            document.getElementById('adminPassword').value = '';
            setTimeout(() => selectMode('admin'), 1000);
        } else {
            errorDiv.innerHTML = '<div class="status error">パスワードが間違っています</div>';
            setTimeout(() => errorDiv.innerHTML = '', 3000);
        }
    }

    function adminLogout() {
        isAdminAuthenticated = false;
        selectMode('none');
    }

    // 管理者パスワード変更
    async function changeAdminPassword() {
        const newPassword = document.getElementById('newAdminPassword').value;
        const confirmPassword = document.getElementById('confirmAdminPassword').value;
        
        if (!newPassword || !confirmPassword) {
            alert('両方のパスワード欄を入力してください');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('パスワードが一致しません');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('パスワードは6文字以上で設定してください');
            return;
        }
        
        adminConfig.adminPassword = newPassword;
        await saveAdminSettings();
        
        document.getElementById('newAdminPassword').value = '';
        document.getElementById('confirmAdminPassword').value = '';
        
        alert('パスワードが変更されました！');
    }

    // 管理者設定保存
    async function saveAdminConfig() {
        adminConfig.apiProvider = document.getElementById('apiProvider').value;
        adminConfig.apiKey = document.getElementById('adminApiKey').value;
        adminConfig.customApiUrl = document.getElementById('customApiUrl').value;
        adminConfig.model = document.getElementById('modelSelect').value;
        adminConfig.maxTokens = Number(document.getElementById('maxTokens').value);
        adminConfig.temperature = Number(document.getElementById('temperature').value);
        adminConfig.sessionTimeout = Number(document.getElementById('sessionTimeout').value);
        adminConfig.showSessionTimer = document.getElementById('showTimer').checked;
        await saveAdminSettings();
        
        document.getElementById('configStatus').innerHTML = '<div class="status success">設定が保存されました！</div>';
        setTimeout(() => document.getElementById('configStatus').innerHTML = '', 3000);
    }


    //アンケートロード、保存
    async function loadSurveyConfig() {
      const { data, error } = await supabase
        .from('admin_settings')
        .select('settings')
        .eq('id', 'surveys')
        .single();
  
      if (error) {
          console.error('アンケート設定読み込みエラー:', error);
          return;
      }
  
      document.getElementById('surveyJsonEditor').value = JSON.stringify(data.settings, null, 2);
    }

    async function saveSurveyConfig() {
        const newSettings = document.getElementById('surveyJsonEditor').value;
        try {
            const parsed = JSON.parse(newSettings);
            const { error } = await supabase
                .from('admin_settings')
                .upsert({ id: 'surveys', settings: parsed });
    
            if (error) throw error;
    
            alert('アンケート設定を保存しました！');
        } catch (e) {
            alert('JSON形式が正しくありません: ' + e.message);
        }
    }

    // プロンプト設定保存
    async function savePromptConfig() {
        adminConfig.systemPrompt = document.getElementById('systemPrompt').value;
        await saveAdminSettings();
        alert('プロンプト設定が保存されました！');
    }

    // 管理者設定UIに読み込み
    function loadAdminConfigUI() {
        const apiProviderSelect = document.getElementById('apiProvider');
        if (apiProviderSelect) {
            apiProviderSelect.value = adminConfig.apiProvider || 'openai';
            updateApiProviderUI();
        }

        const apiKeyInput = document.getElementById('adminApiKey');
        if (apiKeyInput) apiKeyInput.value = adminConfig.apiKey || '';
        
        const customUrlInput = document.getElementById('customApiUrl');
        if (customUrlInput) customUrlInput.value = adminConfig.customApiUrl || '';

        const modelSelect = document.getElementById('modelSelect');
        if (modelSelect) {
            modelSelect.value = adminConfig.model || 'gpt-3.5-turbo';
            updateModelOptions();
        }

        const maxTokensInput = document.getElementById('maxTokens');
        if (maxTokensInput) maxTokensInput.value = adminConfig.maxTokens ?? 300;

        const tempInput = document.getElementById('temperature');
        if (tempInput) tempInput.value = adminConfig.temperature ?? 0.7;

        const timeoutInput = document.getElementById('sessionTimeout');
        if (timeoutInput) timeoutInput.value = adminConfig.sessionTimeout ?? 30;

        const showTimerCheckbox = document.getElementById('showTimer');
        if (showTimerCheckbox) showTimerCheckbox.checked = adminConfig.showSessionTimer ?? true;
        
        const systemPromptInput = document.getElementById('systemPrompt');
        if (systemPromptInput) systemPromptInput.value = adminConfig.systemPrompt || '';
    }
    
    // APIプロバイダーUIの更新
    function updateApiProviderUI() {
        const provider = document.getElementById('apiProvider')?.value;
        const customUrlGroup = document.getElementById('customUrlGroup');
        
        if (customUrlGroup) {
            customUrlGroup.style.display = provider === 'custom' ? 'block' : 'none';
        }
        
        updateModelOptions();
    }
    
    // モデル選択肢の更新
    function updateModelOptions() {
        const provider = document.getElementById('apiProvider')?.value;
        const modelSelect = document.getElementById('modelSelect');
        
        if (modelSelect) {
            modelSelect.innerHTML = '';
            
            if (provider === 'openai') {
                const openaiModels = [
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' },
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4o', text: 'GPT-4o' },
                    { value: 'gpt-4o-mini', text: 'GPT-4o Mini' }
                ];
                openaiModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            } else if (provider === 'claude') {
                const claudeModels = [
                    { value: 'claude-3-5-sonnet-20241022', text: 'Claude 3.5 Sonnet' },
                    { value: 'claude-3-sonnet-20240229', text: 'Claude 3 Sonnet' },
                    { value: 'claude-3-opus-20240229', text: 'Claude 3 Opus' },
                    { value: 'claude-3-haiku-20240307', text: 'Claude 3 Haiku' }
                ];
                claudeModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            } else {
                // カスタムの場合は基本モデルを表示
                const basicModels = [
                    { value: 'custom-model', text: 'カスタムモデル' }
                ];
                basicModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            }
            
            // 保存されたモデルがある場合はそれを選択
            if (adminConfig.model) {
                modelSelect.value = adminConfig.model;
            }
        }
    }

    async function addSurvey() {
        const day = Number(document.getElementById('surveyDay').value);
        const position = document.querySelector('input[name="surveyPosition"]:checked').value;
        const questions = collectQuestionInputs();  // 複数質問をオブジェクト配列に整形
        surveys.push({ day, position, questions });
        await saveSurveys();  // admin_settingsにアップサート
        updateSurveyList();
       
    }

    // シナリオ管理
    async function addScenario() {
        const title = document.getElementById('scenarioTitle').value;
        const content = document.getElementById('scenarioContent').value;
        const promptQuestionsText = document.getElementById('scenarioPromptQuestions').value;
        const hiddenContext = document.getElementById('scenarioHiddenContext').value;
        const analysisPoints = document.getElementById('scenarioAnalysisPoints').value;

        if (!title || !content) {
            alert('タイトルと内容を入力してください');
            return;
        }
        
        const promptQuestions = promptQuestionsText ? promptQuestionsText.split('\n').filter(q => q.trim()) : [];
        const newScenario = {
            title,
            content,
            promptQuestions,
            hiddenContext: hiddenContext || '',
            analysisPoints: analysisPoints || ''
        };
        
        scenarios.push(newScenario);
        await saveScenarios();
        updateScenarioList();
        
        // 入力フィールドをクリア
        document.getElementById('scenarioTitle').value = '';
        document.getElementById('scenarioContent').value = '';
        document.getElementById('scenarioPromptQuestions').value = '';
        document.getElementById('scenarioHiddenContext').value = '';
        document.getElementById('scenarioAnalysisPoints').value = '';
        
        alert('シナリオが追加されました！');
    }

    function updateScenarioList() {
        const list = document.getElementById('scenarioList');
        if (!list) return;
        
        list.innerHTML = '';
        
        if (scenarios.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">シナリオがありません</p>';
            return;
        }
        
        scenarios.forEach((scenario, index) => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            // 隠れたコンテキストや分析ポイントの表示
            let additionalInfo = '';
            if (scenario.hiddenContext && scenario.hiddenContext.trim()) {
                additionalInfo += `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;"><strong>隠れたコンテキスト:</strong> ${scenario.hiddenContext.slice(0, 100)}${scenario.hiddenContext.length > 100 ? '...' : ''}</div>`;
            }
            if (scenario.analysisPoints && scenario.analysisPoints.trim()) {
                additionalInfo += `<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;"><strong>分析ポイント:</strong> ${scenario.analysisPoints.slice(0, 100)}${scenario.analysisPoints.length > 100 ? '...' : ''}</div>`;
            }
            
            item.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #495057;">${scenario.title}</h4>
                <p style="margin-bottom: 15px; color: #6c757d; line-height: 1.5;">${scenario.content.slice(0, 200)}${scenario.content.length > 200 ? '...' : ''}</p>
                ${additionalInfo}
                <button class="btn deleteBtn" data-index="${index}"  style="background: #dc3545; font-size: 14px; padding: 8px 16px;">削除</button>
            `;
            list.appendChild(item);
        });
        list.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', e => {
            deleteScenario(Number(e.currentTarget.dataset.index));
          });
        });
    }

    async function deleteScenario(index) {
        if (!confirm('このシナリオを削除しますか？')) return;

        scenarios.splice(index, 1);
        await saveScenarios();
        updateScenarioList();
        alert('シナリオを削除しました');
    }

    // ログ管理
    function updateLogsList() {
        updateParticipantFilter();
        displayFilteredLogs();
    }

    function updateParticipantFilter() {
        const filterSelect = document.getElementById('filterParticipant');
        if (!filterSelect) return;
        
        const participants = [...new Set(experimentLogs.map(log => log.participant_id))];
        filterSelect.innerHTML = '<option value="">全ての参加者</option>';
        
        participants.forEach(participant => {
            const option = document.createElement('option');
            option.value = participant;
            option.textContent = participant;
            filterSelect.appendChild(option);
        });
    }

    function displayFilteredLogs() {
        const list = document.getElementById('experimentLogsList');
        if (!list) return;
        
        const participantFilter = document.getElementById('filterParticipant')?.value || '';
        const dayFilter = document.getElementById('filterDay')?.value || '';
        
        let filteredLogs = experimentLogs.filter(log => {
            return (!participantFilter || log.participant_id === participantFilter) &&
                   (!dayFilter || log.day?.toString() === dayFilter);
        });
        
        list.innerHTML = '';
        
        if (filteredLogs.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">条件に合致するデータがありません</p>';
            return;
        }
        
        filteredLogs.forEach(log => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const date = new Date(log.created_at).toLocaleString('ja-JP');
            const typeLabels = {
                'self_analysis': '自力分析',
                'agent_assisted': 'エージェント支援'
            };
            
            let content = '';
            if (log.experiment_type === 'self_analysis') {
                content = `<div><strong>分析内容:</strong><br>${log.data?.analysis || ''}</div>`;
            } else if (log.experiment_type === 'agent_assisted') {
                const chatHistory = log.data?.chatHistory || [];
                content = `<div><strong>会話履歴:</strong><br>${chatHistory.map(msg => `${msg.sender}: ${msg.content}`).join('<br>')}</div>`;
            }
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <span style="font-weight: 600;">参加者: ${log.participant_id}</span>
                        <span style="margin-left: 10px; background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${typeLabels[log.experiment_type]}</span>
                        ${log.day ? `<span style="margin-left: 10px; color: #6c757d;">Day ${log.day}</span>` : ''}
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">${date}</div>
                </div>
                ${log.scenario_title ? `<div style="margin-bottom: 10px;"><strong>シナリオ:</strong> ${log.scenario_title}</div>` : ''}
                ${content}
            `;
            list.appendChild(item);
        });
    }

    function exportData() {
        if (experimentLogs.length === 0) {
            alert('出力するデータがありません');
            return;
        }
        
        let csv = 'ID,参加者ID,実験日,実験タイプ,シナリオ,データ,タイムスタンプ\n';
        
        experimentLogs.forEach(log => {
            let data = '';
            if (log.experiment_type === 'self_analysis') {
                data = log.data?.analysis?.replace(/"/g, '""') || '';
            } else if (log.experiment_type === 'agent_assisted') {
                data = log.data?.chatHistory?.map(msg => `${msg.sender}: ${msg.content}`).join(' | ') || '';
            }
            
            csv += `"${log.id}","${log.participant_id}","${log.day || ''}","${log.experiment_type}","${log.scenario_title || ''}","${data}","${log.created_at}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `mentalize_experiment_data_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    // 参加者の過去のログを確認する関数
    async function checkPreviousLogs(participantId, selectedDay) {
        const participantLogs = experimentLogs.filter(log => 
            log.participant_id === participantId && log.day !== selectedDay
        );
        
        if (participantLogs.length > 0) {
            // 過去のログがある場合は確認ダイアログを表示
            const previousDays = [...new Set(participantLogs.map(log => log.day))].sort();
            const daysList = previousDays.map(day => `${day}日目`).join('、');
            
            const confirmed = confirm(
                `参加者ID「${participantId}」の過去の実験記録が見つかりました。\n` +
                `過去の参加日: ${daysList}\n\n` +
                `過去の会話ログを確認しますか？\n` +
                `「OK」で過去ログ表示、「キャンセル」で実験を続行します。`
            );
            
            if (confirmed) {
                showPreviousLogsModal(participantLogs);
                return false; // 実験開始を中断
            }
        }
        return true; // 実験開始を続行
    }
    
    // 過去ログを表示するモーダル
    function showPreviousLogsModal(logs) {
        const modal = document.createElement('div');
        modal.id = 'previousLogsModal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 1000; display: flex; 
            align-items: center; justify-content: center;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white; padding: 20px; border-radius: 10px; 
            max-width: 80%; max-height: 80%; overflow-y: auto;
            min-width: 600px;
        `;
        
        let logsHtml = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>過去の実験ログ（参加者: ${participantId}）</h3>
                <button onclick="closePreviousLogsModal()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">✕ 閉じる</button>
            </div>
        `;
        
        // 日付順にソート
        logs.sort((a, b) => a.day - b.day);
        
        logs.forEach(log => {
            const date = new Date(log.created_at).toLocaleString('ja-JP');
            logsHtml += `
                <div style="border: 1px solid #e9ecef; margin-bottom: 15px; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong style="color: #495057;">${log.day}日目 - ${log.experiment_type === 'self_analysis' ? '自力メンタライズ' : 'エージェント支援'}</strong>
                        <span style="color: #6c757d; font-size: 14px;">${date}</span>
                    </div>
                    <div style="margin-bottom: 10px;"><strong>シナリオ:</strong> ${log.scenario_title}</div>
            `;
            
            if (log.data && log.data.chatHistory && log.data.chatHistory.length > 0) {
                logsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>会話ログ:</strong>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; max-height: 200px; overflow-y: auto;">
                `;
                log.data.chatHistory.forEach(msg => {
                    const isUser = msg.role === 'user';
                    logsHtml += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: ${isUser ? '#007bff' : '#28a745'};">${isUser ? '参加者' : 'AI'}:</strong>
                            <span style="margin-left: 8px;">${msg.content}</span>
                        </div>
                    `;
                });
                logsHtml += '</div></div>';
            }
            
            if (log.data && log.data.analysis) {
                logsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>分析結果:</strong>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">${log.data.analysis}</div>
                    </div>
                `;
            }
            
            logsHtml += '</div>';
        });
        
        logsHtml += `
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closePreviousLogsModal()" class="btn" style="margin-right: 10px;">閉じる</button>
                <button onclick="closePreviousLogsModal(); startExperiment();" class="btn" style="background: #28a745;">実験を続行</button>
            </div>
        `;
        
        content.innerHTML = logsHtml;
        modal.appendChild(content);
        document.body.appendChild(modal);
    }
    
    // モーダルを閉じる関数
    window.closePreviousLogsModal = function() {
        const modal = document.getElementById('previousLogsModal');
        if (modal) {
            document.body.removeChild(modal);
        }
    };

    // 実験機能
    async function startExperiment() {
        participantId = document.getElementById('participantId').value;
        currentDay = parseInt(document.getElementById('experimentDay').value);
        
        if (!participantId) {
            alert('参加者IDを入力してください');
            return;
        }

        if (scenarios.length === 0) {
            alert('シナリオが設定されていません');
            return;
        }
        
        // 過去のログをチェック
        const shouldContinue = await checkPreviousLogs(participantId, currentDay);
        if (!shouldContinue) {
            return; // 過去ログ表示中なので実験開始を中断
        }
        
        // 実験開始時のアンケートをチェック
        const startSurvey = surveys.find(s => s.day === currentDay && s.timing === 'start');
        if (startSurvey) {
            await showSurvey(startSurvey, 'start');
        }

        // ユーザーセッションを初期化/更新
        await initializeUserSession(participantId);

        document.getElementById('participantSetup').style.display = 'none';
        document.getElementById('experimentContent').style.display = 'block';
        
        // セッションタイマーを開始
        startSessionTimer();
        
        currentScenarioIndex = Math.floor(Math.random() * scenarios.length);
        displayScenario();
    }

    function displayScenario() {
        const scenario = scenarios[currentScenarioIndex];
        document.getElementById('currentScenarioTitle').textContent = scenario.title;
        document.getElementById('currentScenarioContent').textContent = scenario.content;
        document.getElementById('scenarioDisplay').style.display = 'block';
        
        document.getElementById('progressFill').style.width = '40%';
        
        if (currentDay === 1 || currentDay === 7) {
            document.getElementById('selfMentalize').style.display = 'block';
            document.getElementById('agentChat').style.display = 'none';
        } else {
            document.getElementById('selfMentalize').style.display = 'none';
            document.getElementById('agentChat').style.display = 'block';
            initializeChat();
        }
    }

    async function submitAnalysis() {
        const analysis = document.getElementById('userAnalysis').value;
        if (!analysis.trim()) {
            alert('分析を入力してください');
            return;
        }

        await saveExperimentLog({
            participantId,
            day: currentDay,
            scenarioIndex: currentScenarioIndex,
            scenarioTitle: scenarios[currentScenarioIndex].title,
            analysis,
            experimentType: 'self_analysis'
        });
        
        // 実験終了時のアンケートをチェック
        const endSurvey = surveys.find(s => s.day === currentDay && s.timing === 'end');
        if (endSurvey) {
            await showSurvey(endSurvey, 'end');
        }

        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('selfMentalize').style.display = 'none';
        document.getElementById('experimentComplete').style.display = 'block';
    }

    function initializeChat() {
        const messages = document.getElementById('chatMessages');
        messages.innerHTML = '';
        
        addMessage('ai', 'こんにちは！このシナリオについて、登場人物の気持ちや考えを一緒に探ってみましょう。まず、どの人物に注目しますか？');
        
        document.getElementById('progressFill').style.width = '50%';
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        addMessage('user', message);
        input.value = '';
        
        const response = await generateAIResponse(message);
        addMessage('ai', response);
    }

    function getChatHistory() {
        const messages = document.querySelectorAll('#chatMessages .message');
        return Array.from(messages).map(msg => ({
            sender: msg.classList.contains('user') ? 'user' : 'ai',
            content: msg.textContent,
            timestamp: new Date().toISOString()
        }));
    }

    function addMessage(sender, text) {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    async function generateAIResponse(userMessage) {
        const currentScenario = scenarios[currentScenarioIndex];
        let systemPrompt = adminConfig.systemPrompt;
        
        // 想定質問がある場合はプロンプトに追加
        if (currentScenario.promptQuestions && currentScenario.promptQuestions.length > 0) {
            systemPrompt += '\n\n参考用想定質問:\n' + currentScenario.promptQuestions.map(q => `- ${q}`).join('\n');
        }
        
        // 隠れたコンテキストがある場合はプロンプトに追加
        if (currentScenario.hiddenContext && currentScenario.hiddenContext.trim()) {
            systemPrompt += '\n\n背景情報・ニュアンス:\n' + currentScenario.hiddenContext;
        }
        
        // 分析ポイントがある場合はプロンプトに追加
        if (currentScenario.analysisPoints && currentScenario.analysisPoints.trim()) {
            systemPrompt += '\n\n分析時の着目点:\n' + currentScenario.analysisPoints;
        }
        
        const userContent = `シナリオ: ${currentScenario.content}\n\nユーザーの発言: ${userMessage}`;
        
        if (adminConfig.apiKey) {
            try {
                let apiUrl, headers, requestBody;
                
                if (adminConfig.apiProvider === 'openai') {
                    if (!adminConfig.apiKey.startsWith('sk-')) {
                        throw new Error('OpenAI APIキーの形式が正しくありません');
                    }
                    
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminConfig.apiKey}`
                    };
                    requestBody = {
                        model: adminConfig.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userContent }
                        ],
                        max_tokens: adminConfig.maxTokens || 300,
                        temperature: adminConfig.temperature || 0.7
                    };
                } else if (adminConfig.apiProvider === 'claude') {
                    apiUrl = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': adminConfig.apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    requestBody = {
                        model: adminConfig.model,
                        max_tokens: adminConfig.maxTokens || 300,
                        temperature: adminConfig.temperature || 0.7,
                        system: systemPrompt,
                        messages: [{ role: 'user', content: userContent }]
                    };
                } else if (adminConfig.apiProvider === 'custom') {
                    if (!adminConfig.customApiUrl) {
                        throw new Error('カスタムAPI URLが設定されていません');
                    }
                    
                    apiUrl = adminConfig.customApiUrl;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminConfig.apiKey}`
                    };
                    requestBody = {
                        model: adminConfig.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userContent }
                        ],
                        max_tokens: adminConfig.maxTokens || 300,
                        temperature: adminConfig.temperature || 0.7
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (adminConfig.apiProvider === 'claude') {
                        return data.content[0].text;
                    } else {
                        return data.choices[0].message.content;
                    }
                } else {
                    const errorData = await response.text();
                    console.error(`APIエラー (${response.status}):`, errorData);
                    throw new Error(`APIリクエストが失敗しました (${response.status})`);
                }
            } catch (error) {
                console.error('AI API エラー:', error);
                addMessage('ai', '申し訳ございません、AIサービスに接続できませんでした。デモモードで続行します。');
            }
        }

        // デモ用の応答
        const responses = [
            "なるほど、その観点は興味深いですね。登場人物の表情や行動からも何か読み取れることはありますか？",
            "とても良い分析ですね。他の登場人物はどのような気持ちでいると思いますか？",
            "その通りですね。さらに深く考えてみると、なぜそのような感情を抱いているのでしょうか？",
            "素晴らしい気づきです。そこから読み取れる人間関係はどのようなものでしょうか？",
            "興味深い指摘ですね。その状況で相手はどんなことを考えているでしょうか？",
            "良い視点ですね。もし自分がその立場だったら、どのように感じるでしょうか？"
        ];
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        return responses[Math.floor(Math.random() * responses.length)];
    }

    async function initializeUserSession(userId) {
      if (!supabase) {
        console.log('⚠️ Supabase未接続のため、セッション管理をスキップします');
        return;
      }
      
      const { data, error } = await supabase
        .from('user_sessions')
        .select('*')
        .eq('user_id', userId)
        .single();
    
      if (error && error.code === 'PGRST116') { // Not Found
        const { error: insertError } = await supabase
          .from('user_sessions')
          .insert([{ user_id: userId, start_date: new Date().toISOString() }]);
    
        if (insertError) {
          console.error('❌ セッション初期登録エラー:', insertError);
        } else {
          console.log('✅ セッション初期登録完了');
          // セッション一覧を更新
          await loadUserSessionsUI();
        }
      } else if (data) {
        // 既存セッションの最終更新時刻を更新
        const { error: updateError } = await supabase
          .from('user_sessions')
          .update({ updated_at: new Date().toISOString() })
          .eq('user_id', userId);
          
        if (updateError) {
          console.error('❌ セッション更新エラー:', updateError);
        } else {
          console.log('✅ セッション更新完了');
          // セッション一覧を更新
          await loadUserSessionsUI();
        }
        console.log('📅 既存のセッション開始日:', data.start_date);
      } else {
        console.error('❌ セッション情報取得エラー:', error);
      }
    }

    async function getCurrentExperimentDay(userId) {
      const { data, error } = await supabase
        .from('user_sessions')
        .select('start_date')
        .eq('user_id', userId)
        .single();
    
      const today = new Date();
    
      if (error || !data) {
        // start_date がまだない場合、今日を開始日に登録
        const { error: insertError } = await supabase
          .from('user_sessions')
          .insert([{ user_id: userId, start_date: today }]);
    
        if (insertError) {
          console.error('❌ セッション登録エラー:', insertError);
          return null;
        }
    
        return 1; // 今日が初日
      }
    
      const start = new Date(data.start_date);
      const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));
      return diffDays + 1;
    }



    async function finishChat() {
        await saveExperimentLog({
            participantId,
            day: currentDay,
            scenarioIndex: currentScenarioIndex,
            scenarioTitle: scenarios[currentScenarioIndex].title,
            chatHistory: getChatHistory(),
            experimentType: 'agent_assisted'
        });
        
        // 実験終了時のアンケートをチェック
        const endSurvey = surveys.find(s => s.day === currentDay && s.timing === 'end');
        if (endSurvey) {
            await showSurvey(endSurvey, 'end');
        }

        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('agentChat').style.display = 'none';
        document.getElementById('experimentComplete').style.display = 'block';
    }

    // セッションタイマー関連の変数
    let sessionStartTime = null;
    let timerInterval = null;
    
    // セッションタイマーを開始する関数
    function startSessionTimer() {
        // 管理者設定でタイマー表示が有効な場合のみ表示
        if (adminConfig.showSessionTimer) {
            document.getElementById('sessionTimer').style.display = 'block';
        } else {
            document.getElementById('sessionTimer').style.display = 'none';
            return; // タイマー表示が無効な場合は処理を終了
        }
        
        sessionStartTime = new Date();
        
        // 既存のタイマーがあれば停止
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // 1秒ごとにタイマーを更新
        timerInterval = setInterval(() => {
            if (sessionStartTime) {
                const elapsed = new Date() - sessionStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timerDisplay').textContent = timeString;
            }
        }, 1000);
    }
    
    // セッションタイマーを停止する関数
    function stopSessionTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        sessionStartTime = null;
        document.getElementById('sessionTimer').style.display = 'none';
    }
    
    function resetExperiment() {
        // セッションタイマーを停止
        stopSessionTimer();
        
        document.getElementById('experimentContent').style.display = 'none';
        document.getElementById('participantSetup').style.display = 'block';
        document.getElementById('userAnalysis').value = '';
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('progressFill').style.width = '0%';
        
        ['scenarioDisplay', 'selfMentalize', 'agentChat', 'experimentComplete'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }
    
    // 実験セットアップ画面に戻る関数
    window.goBackToExperimentSetup = function() {
        const confirmed = confirm(
            '実験を中断して、最初の画面に戻りますか？\n' +
            '未保存のデータは失われる可能性があります。'
        );
        
        if (confirmed) {
            resetExperiment();
        }
    };

    // 初期化とイベントリスナー設定
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('🚀 システム開始');
    　  
   　 loadFromLocalStorage();  

      try {
        await initializeSupabase();  // Supabaseの初期化
        console.log('✅ Supabase 同期完了');
        

        await fetchAdminConfig();     // 管理設定の取得（adminConfig に読み込み）
        loadAdminConfigUI();          // UIへの反映
        if (supabase) await loadUserSessionsUI();
        // アンケート系は参加者モード時に処理するように変更
        await loadSurveys(); // アンケートデータを読み込み
        console.log('📋 アンケート機能が初期化されました');
        
        // アンケート結果の読み込みを強制実行
        await loadSurveyResultsForDisplay();
        console.log('📊 アンケート結果の読み込みが完了しました');
    
      } catch (err) {
        console.error('❌ 初期化中にエラー:', err);
      }
      // 多分ここで切らせるとまずいかも});      

    // ✅ 管理設定のリアルタイム監視を開始
        supabase.channel('admin-config-watch')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'admin_settings',
              filter: 'id=eq.admin_config'  // 固定IDの設定レコードのみを対象
            },
            (payload) => {
              if (payload.new) {
                adminConfig = payload.new.settings;
                loadAdminConfigUI(); // UIを即時更新
              }
             }
           )
           .subscribe();
       //}
       // try {
       // } catch (err) {
       //   console.error('❌ Supabase 初期化エラー:', err);
       // }
     //});
        // initializeSupabase().then(() => {
        //   console.log('✅ Supabase 同期完了');
        // }).catch(err => {
        //   console.error('❌ Supabase 初期化エラー:', err);
        // });
        // Supabase初期化
        
        
        // ローカルデータ読み込み
        
        
        // イベントリスナー設定
        document.getElementById('participantBtn').addEventListener('click', () => selectMode('participant'));
        document.getElementById('adminAccessBtn').addEventListener('click', attemptAdminAccess);
        document.getElementById('backToModeBtn').addEventListener('click', () => selectMode('none'));
        // APIプロバイダー変更イベント
        document.getElementById('apiProvider').addEventListener('change', updateApiProviderUI);
        
        // アンケート関連イベント
        document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
        document.getElementById('saveSurveyBtn').addEventListener('click', saveSurvey);
        document.getElementById('loadSurveyResultsBtn').addEventListener('click', loadSurveyResults);
        document.getElementById('resultParticipant').addEventListener('change', displaySurveyResults);
        document.getElementById('resultDay').addEventListener('change', displaySurveyResults);
        
        // 管理者ナビゲーションイベント
        document.getElementById('adminSurveysNav').addEventListener('click', () => {
            showAdminScreen('adminSurveys');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminSurveysNav').classList.add('active');
            loadSurveys();
        });
        document.getElementById('showUserSessionsBtn').addEventListener('click', function() {
            const section = document.getElementById('userSessionsSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadUserSessionsUI();
                this.textContent = 'ユーザーセッション一覧を非表示';
            } else {
                section.style.display = 'none';
                this.textContent = 'ユーザーセッション一覧を表示';
            }
        });
        
        // 管理者ログアウトボタン追加
        document.getElementById('adminLogoutBtn4').addEventListener('click', adminLogout);

        
        // アンケートの質問タイプ切り替えイベント
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('question-type')) {
                const container = e.target.closest('.question-item');
                const optionsContainer = container.querySelector('.options-container');
                const scaleContainer = container.querySelector('.scale-container');
                
                if (e.target.value === 'radio' || e.target.value === 'checkbox') {
                    optionsContainer.style.display = 'block';
                    scaleContainer.style.display = 'none';
                } else if (e.target.value === 'scale') {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'block';
                } else {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'none';
                }
            }
        });
        
        // 管理者イベント
        document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);
        document.getElementById('adminLogoutBtn2').addEventListener('click', adminLogout);
        document.getElementById('adminLogoutBtn3').addEventListener('click', adminLogout);
        
        document.getElementById('adminConfigNav').addEventListener('click', () => {
            showAdminScreen('adminConfig');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminConfigNav').classList.add('active');
        });
        
        document.getElementById('adminScenariosNav').addEventListener('click', () => {
            showAdminScreen('adminScenarios');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminScenariosNav').classList.add('active');
        });
        
        document.getElementById('adminLogsNav').addEventListener('click', () => {
            showAdminScreen('adminLogs');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminLogsNav').classList.add('active');
        });
        
        // 設定保存
        document.getElementById('changePasswordBtn').addEventListener('click', changeAdminPassword);
        document.getElementById('saveConfigBtn').addEventListener('click', saveAdminConfig);
        document.getElementById('savePromptBtn').addEventListener('click', savePromptConfig);
        
        // シナリオ管理
        document.getElementById('addScenarioBtn').addEventListener('click', addScenario);
        
        // データ出力
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
        document.getElementById('filterParticipant').addEventListener('change', displayFilteredLogs);
        document.getElementById('filterDay').addEventListener('change', displayFilteredLogs);
        
        // 実験イベント
        document.getElementById('startExperimentBtn').addEventListener('click', startExperiment);
        document.getElementById('submitAnalysisBtn').addEventListener('click', submitAnalysis);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('finishChatBtn').addEventListener('click', finishChat);
        document.getElementById('resetExperimentBtn').addEventListener('click', resetExperiment);
        
        // キーボードイベント
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') attemptAdminAccess();
        });
        //Java終わり
        console.log('✅ 初期化完了');
    });
    
    // アンケート表示機能
    async function showSurvey(survey, timing) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            const timingText = timing === 'start' ? '開始時' : '終了時';
            
            let questionsHtml = '';
            survey.questions.forEach((question, index) => {
                let inputHtml = '';
                
                switch (question.type) {
                    case 'text':
                        inputHtml = `<textarea id="answer_${index}" style="width: 100%; height: 80px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>`;
                        break;
                    case 'radio':
                        inputHtml = question.options.map((option, optIndex) => 
                            `<label style="display: block; margin: 5px 0;"><input type="radio" name="answer_${index}" value="${option}"> ${option}</label>`
                        ).join('');
                        break;
                    case 'checkbox':
                        inputHtml = question.options.map((option, optIndex) => 
                            `<label style="display: block; margin: 5px 0;"><input type="checkbox" name="answer_${index}" value="${option}"> ${option}</label>`
                        ).join('');
                        break;
                    case 'scale':
                        const [min, max] = question.range.split('-').map(Number);
                        inputHtml = `<div style="margin-top: 10px;">`;
                        for (let i = min; i <= max; i++) {
                            inputHtml += `<label style="margin-right: 15px;"><input type="radio" name="answer_${index}" value="${i}"> ${i}</label>`;
                        }
                        inputHtml += `</div>`;
                        break;
                }
                
                questionsHtml += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">Q${index + 1}: ${question.text}</div>
                        ${inputHtml}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #495057;">📊 ${survey.day}日目 ${timingText}アンケート</h3>
                ${questionsHtml}
                <div style="text-align: center; margin-top: 20px;">
                    <button id="submitSurveyBtn" class="btn">回答を提出</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            document.getElementById('submitSurveyBtn').addEventListener('click', async () => {
                const answers = [];
                
                survey.questions.forEach((question, index) => {
                    let answer = '';
                    
                    switch (question.type) {
                        case 'text':
                            answer = document.getElementById(`answer_${index}`).value;
                            break;
                        case 'radio':
                        case 'scale':
                            const radioSelected = document.querySelector(`input[name="answer_${index}"]:checked`);
                            answer = radioSelected ? radioSelected.value : '';
                            break;
                        case 'checkbox':
                            const checkboxes = document.querySelectorAll(`input[name="answer_${index}"]:checked`);
                            answer = Array.from(checkboxes).map(cb => cb.value).join(', ');
                            break;
                    }
                    
                    answers.push({ question: question.text, answer });
                });
                
                // 結果を保存
                await saveSurveyResult({
                    participantId,
                    day: survey.day,
                    timing: survey.timing,
                    answers
                });
                
                document.body.removeChild(overlay);
                resolve();
            });
        });
    }
    
    // アンケートデータの読み込み
    async function loadSurveys() {
        if (!supabase) {
            // ローカルストレージから読み込み
            const savedSurveys = localStorage.getItem('mentalizeSurveys');
            if (savedSurveys) {
                try {
                    surveys = JSON.parse(savedSurveys);
                } catch (error) {
                    surveys = [];
                }
            }
            updateSurveyList();
            loadSurveyResultsForDisplay();
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'surveys')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
                surveys = data.settings.surveys || [];
            } else {
                surveys = [];
                await saveSurveys(); // 空の配列で初期化
            }
            
            updateSurveyList();
            loadSurveyResultsForDisplay();
            console.log('✅ アンケートデータ読み込み完了');
        } catch (error) {
            console.error('❌ アンケートデータ読み込みエラー:', error);
            surveys = [];
        }
    }
    
    // アンケートデータの保存
    async function saveSurveys() {
        if (!supabase) {
            localStorage.setItem('mentalizeSurveys', JSON.stringify(surveys));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'surveys',
                    settings: { surveys },
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('アンケート保存エラー:', error);
            localStorage.setItem('mentalizeSurveys', JSON.stringify(surveys));
        }
    }
    
    // 質問を追加
    function addQuestion() {
        const container = document.getElementById('questionsContainer');
        const questionCount = container.querySelectorAll('.question-item').length;
        
        const questionItem = document.createElement('div');
        questionItem.className = 'question-item';
        questionItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px;';
        
        questionItem.innerHTML = `
            <div class="form-group">
                <label>質問内容</label>
                <textarea class="question-text" placeholder="質問を入力してください" style="height: 60px;"></textarea>
            </div>
            <div class="form-group">
                <label>回答形式</label>
                <select class="question-type">
                    <option value="text">自由記述</option>
                    <option value="radio">単一選択</option>
                    <option value="checkbox">複数選択</option>
                    <option value="scale">数段階評価</option>
                </select>
            </div>
            <div class="options-container" style="display: none;">
                <label>選択肢（改行区切り）</label>
                <textarea class="question-options" placeholder="選択肢1\n選択肢2\n選択肢3" style="height: 80px;"></textarea>
            </div>
            <div class="scale-container" style="display: none;">
                <label>評価範囲</label>
                <select class="scale-range">
                    <option value="1-5">1-5段階</option>
                    <option value="1-7">1-7段階</option>
                    <option value="1-10">1-10段階</option>
                </select>
            </div>
            <button type="button" class="btn remove-question" style="background: #dc3545; margin-top: 10px;">質問を削除</button>
        `;
        
        container.appendChild(questionItem);
        
        // 削除ボタンのイベントリスナー
        questionItem.querySelector('.remove-question').addEventListener('click', () => {
            if (container.querySelectorAll('.question-item').length > 1) {
                questionItem.remove();
            } else {
                alert('少なくとも1つの質問が必要です');
            }
        });
    }
    
    // アンケートを保存
    async function saveSurvey() {
        const day = Number(document.getElementById('surveyDay').value);
        const timing = document.querySelector('input[name="surveyTiming"]:checked').value;
        const questions = collectQuestionInputs();
        
        if (questions.length === 0) {
            alert('少なくとも1つの質問を追加してください');
            return;
        }
        
        const surveyExists = surveys.find(s => s.day === day && s.timing === timing);
        if (surveyExists) {
            if (!confirm(`${day}日目の${timing === 'start' ? '開始時' : '終了時'}アンケートは既に存在します。上書きしますか？`)) {
                return;
            }
            // 既存のアンケートを削除
            const index = surveys.findIndex(s => s.day === day && s.timing === timing);
            surveys.splice(index, 1);
        }
        
        surveys.push({ day, timing, questions });
        await saveSurveys();
        updateSurveyList();
        
        // フォームをリセット
        document.getElementById('surveyDay').value = '1';
        document.querySelector('input[name="surveyTiming"][value="start"]').checked = true;
        const container = document.getElementById('questionsContainer');
        const questionItems = container.querySelectorAll('.question-item');
        questionItems.forEach((item, index) => {
            if (index > 0) item.remove(); // 最初の質問以外を削除
        });
        if (questionItems.length > 0) {
            questionItems[0].querySelector('.question-text').value = '';
            questionItems[0].querySelector('.question-options').value = '';
        }
        
        alert('アンケートが保存されました！');
    }
    
    // 質問入力データを収集
    function collectQuestionInputs() {
        const questions = [];
        const questionItems = document.querySelectorAll('.question-item');
        
        questionItems.forEach(item => {
            const text = item.querySelector('.question-text').value.trim();
            const type = item.querySelector('.question-type').value;
            
            if (!text) return; // 空の質問はスキップ
            
            const question = { text, type };
            
            if (type === 'radio' || type === 'checkbox') {
                const optionsText = item.querySelector('.question-options').value.trim();
                question.options = optionsText ? optionsText.split('\n').filter(opt => opt.trim()) : [];
            } else if (type === 'scale') {
                question.range = item.querySelector('.scale-range').value;
            }
            
            questions.push(question);
        });
        
        return questions;
    }
    
    // アンケート一覧を更新
    function updateSurveyList() {
        const list = document.getElementById('surveysList');
        if (!list) return;
        
        list.innerHTML = '';
        
        if (surveys.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">アンケートがありません</p>';
            return;
        }
        
        surveys.forEach((survey, index) => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const timingText = survey.timing === 'start' ? '開始時' : '終了時';
            
            item.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #495057;">${survey.day}日目 ${timingText}アンケート</h4>
                <p style="margin-bottom: 15px; color: #6c757d;">質問数: ${survey.questions.length}問</p>
                <button class="btn deleteSurveyBtn" data-index="${index}" style="background: #dc3545; font-size: 14px; padding: 8px 16px;">削除</button>
            `;
            
            list.appendChild(item);
        });
        
        // 削除ボタンのイベントリスナー
        list.querySelectorAll('.deleteSurveyBtn').forEach(btn => {
            btn.addEventListener('click', e => {
                deleteSurvey(Number(e.currentTarget.dataset.index));
            });
        });
    }
    
    // アンケートを削除
    async function deleteSurvey(index) {
        if (!confirm('このアンケートを削除しますか？')) return;
        
        surveys.splice(index, 1);
        await saveSurveys();
        updateSurveyList();
        alert('アンケートを削除しました');
    }
    
    // アンケート結果の読み込み（表示用）
    async function loadSurveyResultsForDisplay() {
        console.log('🔄 アンケート結果を読み込み中...');
        
        if (!supabase) {
            // Supabaseが利用できない場合はローカルストレージから読み込み
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            surveyResults = results;
            updateParticipantSelect();
            console.log(`✅ ローカルストレージから${results.length}件のアンケート結果を読み込みました`);
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('survey_results')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                // survey_resultsテーブルが存在しない場合（42P01エラー）はローカルストレージにフォールバック
                if (error.code === '42P01') {
                    console.warn('⚠️ survey_resultsテーブルが存在しません。ローカルストレージを使用します。');
                    const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
                    surveyResults = results;
                    updateParticipantSelect();
                    console.log(`✅ ローカルストレージから${results.length}件のアンケート結果を読み込みました`);
                    return;
                }
                throw error;
            }
            surveyResults = data || [];
            updateParticipantSelect();
            console.log(`✅ Supabaseから${surveyResults.length}件のアンケート結果を読み込みました`);
            
            // 画面に結果があれば更新
            if (document.getElementById('surveyResults')) {
                displaySurveyResults();
            }
            
        } catch (error) {
            console.error('❌ アンケート結果読み込みエラー:', error);
            // エラーが発生した場合もローカルストレージにフォールバック
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            surveyResults = results;
            updateParticipantSelect();
            console.log(`✅ フォールバック: ローカルストレージから${results.length}件のアンケート結果を読み込みました`);
            // 画面に結果があれば更新
            if (document.getElementById('surveyResults')) {
                displaySurveyResults();
            }
        }
    }
    
    // 参加者セレクトボックス更新を別関数に分離
    function updateParticipantSelect() {
        const participants = [...new Set(surveyResults.map(result => result.participant_id))];
        const select = document.getElementById('resultParticipant');
        if (select) {
            select.innerHTML = '<option value="">全ての参加者</option>';
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }
    }
    
    // アンケート結果を読み込み
    async function loadSurveyResults() {
        await loadSurveyResultsForDisplay();
        displaySurveyResults();
    }
    
    // アンケート結果を表示
    function displaySurveyResults() {
        const resultsDiv = document.getElementById('surveyResults');
        if (!resultsDiv) return;
        
        const participantFilter = document.getElementById('resultParticipant')?.value || '';
        const dayFilter = document.getElementById('resultDay')?.value || '';
        
        let filteredResults = surveyResults.filter(result => {
            return (!participantFilter || result.participant_id === participantFilter) &&
                   (!dayFilter || result.day?.toString() === dayFilter);
        });
        
        resultsDiv.innerHTML = '';
        
        if (filteredResults.length === 0) {
            resultsDiv.innerHTML = '<p style="color: #6c757d; text-align: center;">条件に合致する結果がありません</p>';
            return;
        }
        
        filteredResults.forEach(result => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const timingText = result.timing === 'start' ? '開始時' : '終了時';
            const date = new Date(result.created_at).toLocaleString('ja-JP');
            
            let answersHtml = '';
            result.answers.forEach((answer, index) => {
                answersHtml += `<div style="margin-bottom: 10px;"><strong>Q${index + 1}:</strong> ${answer.question}<br><strong>回答:</strong> ${answer.answer}</div>`;
            });
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <span style="font-weight: 600;">参加者: ${result.participant_id}</span>
                        <span style="margin-left: 10px; background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${result.day}日目 ${timingText}</span>
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">${date}</div>
                </div>
                ${answersHtml}
            `;
            
            resultsDiv.appendChild(item);
        });
    }
    
    // アンケート結果保存
    async function saveSurveyResult(resultData) {
        if (!supabase) {
            // ローカルストレージに保存
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            const newResult = {
                id: Date.now(),
                participant_id: resultData.participantId,
                day: resultData.day,
                timing: resultData.timing,
                answers: resultData.answers,
                created_at: new Date().toISOString()
            };
            results.unshift(newResult);
            localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
            surveyResults = results;
            return;
        }
        
        try {
            const { error } = await supabase
                .from('survey_results')
                .insert({
                    participant_id: resultData.participantId,
                    day: resultData.day,
                    timing: resultData.timing,
                    answers: resultData.answers
                });
            
            if (error) {
                // survey_resultsテーブルが存在しない場合（42P01エラー）はローカルストレージにフォールバック
                if (error.code === '42P01') {
                    console.warn('⚠️ survey_resultsテーブルが存在しません。ローカルストレージに保存します。');
                    const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
                    const newResult = {
                        id: Date.now(),
                        participant_id: resultData.participantId,
                        day: resultData.day,
                        timing: resultData.timing,
                        answers: resultData.answers,
                        created_at: new Date().toISOString()
                    };
                    results.unshift(newResult);
                    localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
                    surveyResults = results;
                    console.log('✅ アンケート結果ローカル保存完了');
                    return;
                }
                throw error;
            }
            console.log('✅ アンケート結果保存完了');
        } catch (error) {
            console.error('❌ アンケート結果保存エラー:', error);
            // その他のエラーでもローカルストレージにフォールバック
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            const newResult = {
                id: Date.now(),
                participant_id: resultData.participantId,
                day: resultData.day,
                timing: resultData.timing,
                answers: resultData.answers,
                created_at: new Date().toISOString()
            };
            results.unshift(newResult);
            localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
            surveyResults = results;
            console.log('✅ アンケート結果ローカル保存完了（フォールバック）');
        }
    }
    
    // グローバル関数として公開
    window.deleteSurvey = deleteSurvey;
    window.showSurvey = showSurvey;
    window.saveSurveyResult = saveSurveyResult;
    </script>
</body>
</html>
