<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .mode-selector {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }

        .mode-btn.participant {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .nav {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .nav.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .admin-config {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .admin-config h3 {
            color: #856404;
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .participant-interface {
            max-width: 800px;
            margin: 0 auto;
        }

        .participant-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .experiment-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .scenario-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .scenario-card p {
            line-height: 1.6;
            color: #6c757d;
        }

        .chat-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background: #e9ecef;
            color: #495057;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            background: #f8f9fa;
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #e9ecef;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .mode-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ä»–è€…ã®èªçŸ¥ã¨æ„Ÿæƒ…ã‚’ç†è§£ã™ã‚‹èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†</p>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ï¼ˆæœ€åˆã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»é¢ï¼‰ -->
        <div id="modeSelector" class="mode-selector">
            <h2 style="margin-bottom: 20px; color: #495057;">å®Ÿé¨“å‚åŠ è€…ã®æ–¹ã¸</h2>
            <p style="margin-bottom: 30px; color: #6c757d; font-size: 18px;">
                ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´å®Ÿé¨“ã«ã”å‚åŠ ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
                ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å®Ÿé¨“ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            </p>
            <div class="mode-buttons">
                <button class="mode-btn participant" onclick="selectMode('participant')" style="transform: scale(1.1); margin-bottom: 30px;">
                    ğŸ¯ å®Ÿé¨“ã‚’é–‹å§‹ã™ã‚‹<br>
                    <small>ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´å®Ÿæ–½</small>
                </button>
            </div>
            
            <!-- ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e9ecef;">
                <details style="text-align: left; max-width: 400px; margin: 0 auto;">
                    <summary style="cursor: pointer; color: #6c757d; font-size: 14px; text-align: center;">
                        ç ”ç©¶è€…ãƒ»ç®¡ç†è€…ã®æ–¹ã¯ã“ã¡ã‚‰
                    </summary>
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <div class="form-group">
                            <label for="adminPassword" style="font-size: 14px;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom: 15px;">
                        </div>
                        <button class="btn" onclick="attemptAdminAccess()" style="width: 100%; font-size: 14px; padding: 10px;">
                            ğŸ”§ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
                        </button>
                        <div id="adminAccessError" style="margin-top: 10px;"></div>
                    </div>
                </details>
            </div>
        </div>

        <!-- ç®¡ç†è€…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div id="adminNav" class="nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showAdminScreen('adminConfig')">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</button>
                <button class="nav-btn" onclick="showAdminScreen('adminScenarios')">ğŸ“ ã‚·ãƒŠãƒªã‚ªç®¡ç†</button>
                <button class="nav-btn" onclick="showAdminScreen('adminLogs')">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿é–²è¦§</button>
            </div>
        </div>

        <!-- è¢«é¨“è€…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¢«é¨“è€…ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div id="participantNav" class="nav">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showParticipantScreen('participantStart')">ğŸš€ å®Ÿé¨“é–‹å§‹</button>
            </div>
        </div>

        <div class="content">
            <!-- ç®¡ç†è€…ç”»é¢ç¾¤ -->
            <div id="adminConfig" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="back-btn" onclick="adminLogout()">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
                
                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="admin-config">
                    <h3>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="newAdminPassword">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</label>
                            <input type="password" id="newAdminPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                        <div class="form-group">
                            <label for="confirmAdminPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                            <input type="password" id="confirmAdminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                        </div>
                    </div>
                    <button class="btn" onclick="changeAdminPassword()" style="background: #dc3545;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
                    <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">
                        âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰
                    </div>
                </div>

                <div class="admin-config">
                    <h3>ğŸ”‘ OpenAI API è¨­å®š</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="adminApiKey">API ã‚­ãƒ¼</label>
                            <input type="password" id="adminApiKey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label for="modelSelect">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                            <select id="modelSelect">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="saveAdminConfig()">è¨­å®šã‚’ä¿å­˜</button>
                </div>
                
                <div class="admin-config">
                    <h3>ğŸ’¬ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                    <div class="form-group">
                        <label for="systemPrompt">åŸºæœ¬æŒ‡ç¤º</label>
                        <textarea id="systemPrompt" style="height: 150px;"></textarea>
                    </div>
                    <button class="btn" onclick="savePromptConfig()">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜</button>
                </div>
                
                <div id="configStatus"></div>
            </div>

            <div id="adminScenarios" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="back-btn" onclick="adminLogout()">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ“ ã‚·ãƒŠãƒªã‚ªç®¡ç†</h2>
                
                <div class="admin-config">
                    <h3>æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ </h3>
                    <div class="form-group">
                        <label for="scenarioTitle">ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="scenarioTitle" placeholder="ä¾‹: å‹äººåŒå£«ã®ä¼šè©±">
                    </div>
                    <div class="form-group">
                        <label for="scenarioContent">ã‚·ãƒŠãƒªã‚ªå†…å®¹</label>
                        <textarea id="scenarioContent" placeholder="ç™»å ´äººç‰©ã€çŠ¶æ³ã€å¯¾è©±å†…å®¹ã‚’è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <button class="btn" onclick="addScenario()">ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ </button>
                </div>

                <div id="scenarioList">
                    <div class="loading">ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <div id="adminLogs" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="back-btn" onclick="adminLogout()">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ“‹ å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿é–²è¦§</h2>
                
                <div class="admin-config">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="filterParticipant">å‚åŠ è€…ID</label>
                            <select id="filterParticipant" onchange="filterLogs()">
                                <option value="">å…¨ã¦ã®å‚åŠ è€…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterDay">å®Ÿé¨“æ—¥</label>
                            <select id="filterDay" onchange="filterLogs()">
                                <option value="">å…¨ã¦ã®æ—¥</option>
                                <option value="1">1æ—¥ç›®</option>
                                <option value="2">2æ—¥ç›®</option>
                                <option value="3">3æ—¥ç›®</option>
                                <option value="4">4æ—¥ç›®</option>
                                <option value="5">5æ—¥ç›®</option>
                                <option value="6">6æ—¥ç›®</option>
                                <option value="7">7æ—¥ç›®</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="exportData()">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›</button>
                </div>

                <div id="experimentLogsList">
                    <div class="loading">å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- è¢«é¨“è€…ç”»é¢ -->
            <div id="participantStart" class="screen">
                <button class="back-btn" onclick="selectMode('none')">â† ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹</button>
                <div class="participant-interface">
                    <div class="participant-header">
                        <h2>ğŸ¯ ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´å®Ÿé¨“</h2>
                        <p>ä»–è€…ã®å¿ƒã‚’ç†è§£ã™ã‚‹åŠ›ã‚’ä¸€ç·’ã«å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†</p>
                    </div>

                    <div class="experiment-card">
                        <div id="participantSetup">
                            <h3>å®Ÿé¨“ã®è¨­å®š</h3>
                            <div class="form-group">
                                <label for="participantId">å‚åŠ è€…ID</label>
                                <input type="text" id="participantId" placeholder="ä¾‹: P001">
                            </div>
                            <div class="form-group">
                                <label for="experimentDay">å®Ÿé¨“æ—¥</label>
                                <select id="experimentDay">
                                    <option value="1">1æ—¥ç›®ï¼ˆè‡ªåŠ›ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼‰</option>
                                    <option value="2">2æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="3">3æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="4">4æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="5">5æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="6">6æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="7">7æ—¥ç›®ï¼ˆè‡ªåŠ›ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼‰</option>
                                </select>
                            </div>
                            <button class="btn" onclick="startExperiment()">å®Ÿé¨“é–‹å§‹</button>
                        </div>

                        <!-- å®Ÿé¨“å®Ÿè¡Œä¸­ã®ç”»é¢ -->
                        <div id="experimentContent" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            
                            <!-- ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º -->
                            <div id="scenarioDisplay" class="scenario-card" style="display: none;">
                                <h3 id="currentScenarioTitle"></h3>
                                <p id="currentScenarioContent"></p>
                            </div>

                            <!-- è‡ªåŠ›åˆ†æç”»é¢ -->
                            <div id="selfMentalize" style="display: none;">
                                <h3>ã‚ãªãŸã®åˆ†æ</h3>
                                <div class="form-group">
                                    <label for="userAnalysis">ç™»å ´äººç‰©ã®æ°—æŒã¡ã‚„è€ƒãˆã‚’åˆ†æã—ã¦ãã ã•ã„</label>
                                    <textarea id="userAnalysis" placeholder="ç™»å ´äººç‰©ã®æ„Ÿæƒ…ã€è€ƒãˆã€å‹•æ©Ÿãªã©ã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„"></textarea>
                                </div>
                                <button class="btn" onclick="submitAnalysis()">åˆ†æã‚’æå‡º</button>
                            </div>

                            <!-- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±ç”»é¢ -->
                            <div id="agentChat" style="display: none;">
                                <h3>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®å¯¾è©±</h3>
                                <div class="chat-container">
                                    <div class="chat-messages" id="chatMessages"></div>
                                    <div class="chat-input">
                                        <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                                        <button onclick="sendMessage()">é€ä¿¡</button>
                                    </div>
                                </div>
                                <button class="btn" onclick="finishChat()" style="margin-top: 15px; background: #28a745;">å¯¾è©±ã‚’çµ‚äº†ã™ã‚‹</button>
                            </div>
                            
                            <!-- å®Ÿé¨“å®Œäº†ç”»é¢ -->
                            <div id="experimentComplete" style="display: none; text-align: center;">
                                <h3>ğŸ‰ å®Ÿé¨“å®Œäº†</h3>
                                <p>æœ¬æ—¥ã®å®Ÿé¨“ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã”å‚åŠ ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
                                <button class="btn" onclick="resetExperiment()">æ–°ã—ã„å®Ÿé¨“ã‚’é–‹å§‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä»£æ›¿CDNã‹ã‚‰Supabaseã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆæœ€åˆã«å®šç¾©ï¼‰
        function loadSupabaseFromAlternative() {
            console.log('ãƒ¡ã‚¤ãƒ³CDNã‹ã‚‰èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€ä»£æ›¿CDNã‚’è©¦è¡Œä¸­...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.onload = function() {
                console.log('ä»£æ›¿CDNã‹ã‚‰Supabaseã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                if (window.initAfterSupabaseLoad) {
                    window.initAfterSupabaseLoad();
                }
            };
            script.onerror = function() {
                console.warn('ã™ã¹ã¦ã®CDNã‹ã‚‰èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚');
                if (window.initAfterSupabaseLoad) {
                    window.initAfterSupabaseLoad();
                }
            };
            document.head.appendChild(script);
        }
    </script>
    
    <!-- Supabase CDN - è¤‡æ•°ã®CDNã‚’è©¦è¡Œ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" onerror="loadSupabaseFromAlternative()"></script>
    
    <script>
        
        // Supabaseè¨­å®š
        let supabase = null;
        let isSupabaseAvailable = false;
        
        // Supabaseã®åˆæœŸåŒ–ã‚’ç¢ºèª
        function initializeSupabase() {
            try {
                // è¤‡æ•°ã®æ–¹æ³•ã§Supabaseã®å­˜åœ¨ã‚’ç¢ºèª
                const supabaseObj = window.supabase || window.Supabase || (window.globalThis && window.globalThis.supabase);
                
                if (supabaseObj && supabaseObj.createClient) {
                    const supabaseUrl = 'https://ivlmmqsdnmvzermlrger.supabase.co';
                    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bG1tcXNkbm12emVybWxyZ2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTg3MjMsImV4cCI6MjA2ODczNDcyM30.vAxSpIuxd2qQKGDM358Qlun1q0Tbh3919DLrawCB1M8';
                    
                    supabase = supabaseObj.createClient(supabaseUrl, supabaseKey);
                    isSupabaseAvailable = true;
                    console.log('âœ… SupabaseåˆæœŸåŒ–æˆåŠŸ');
                    
                    // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    testSupabaseConnection();
                    return true;
                } else {
                    console.warn('âŒ Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    isSupabaseAvailable = false;
                    return false;
                }
            } catch (error) {
                console.error('âŒ SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                isSupabaseAvailable = false;
                return false;
            }
        }
        
        // Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testSupabaseConnection() {
            if (!supabase) return;
            
            try {
                console.log('ğŸ” Supabaseæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...');
                const { data, error } = await supabase
                    .from('admin_settings')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('relation "admin_settings" does not exist')) {
                        console.warn('âš ï¸  ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ç®¡ç†è€…ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                        showTableCreationInstructions();
                    } else {
                        console.warn('âš ï¸  Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                } else {
                    console.log('âœ… Supabaseæ¥ç¶šæˆåŠŸ');
                }
            } catch (error) {
                console.warn('âš ï¸  Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæŒ‡ç¤ºã‚’è¡¨ç¤º
        function showTableCreationInstructions() {
            console.log(`
ğŸ”§ Supabaseã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„:

CREATE TABLE admin_settings (
  id text PRIMARY KEY,
  settings jsonb,
  updated_at timestamp with time zone DEFAULT now()
);

CREATE TABLE participants (
  id text PRIMARY KEY,
  last_access timestamp with time zone DEFAULT now()
);

CREATE TABLE experiment_logs (
  id bigserial PRIMARY KEY,
  participant_id text,
  day integer,
  experiment_type text,
  scenario_title text,
  data jsonb,
  created_at timestamp with time zone DEFAULT now()
);
            `);
        }
        
        // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
        function checkEnvironment() {
            const isClaudePreview = window.location.hostname === 'localhost' || 
                                   window.location.hostname.includes('claude') ||
                                   window.location.href.includes('preview');
            
            if (isClaudePreview) {
                console.log('ğŸ” Claude ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å¤–éƒ¨CDNãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            }
            
            console.log('ğŸŒ ç’°å¢ƒæƒ…å ±:', {
                hostname: window.location.hostname,
                href: window.location.href,
                userAgent: navigator.userAgent.substring(0, 50) + '...'
            });
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentMode = 'none';
        let isAdminAuthenticated = false;
        let scenarios = [];
        let experimentLogs = [];
        let adminConfig = {
            adminPassword: 'MentalizeAdmin2024!',
            apiKey: '',
            model: 'gpt-3.5-turbo',
            systemPrompt: `ã‚ãªãŸã¯å¿ƒç†å­¦ã®å°‚é–€å®¶ã¨ã—ã¦ã€ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼ˆä»–è€…ã®å¿ƒã®ç†è§£ï¼‰ã‚’æ•™ãˆã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚å­¦ç”Ÿã®è€ƒãˆã‚’è‚¯å®šçš„ã«å—ã‘æ­¢ã‚ã€ã‚ˆã‚Šæ·±ã„åˆ†æã‚’ä¿ƒã™è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚æ¸©ã‹ãæ”¯æ´çš„ãªå£èª¿ã§è©±ã—ã¦ãã ã•ã„ã€‚`
        };
        
        let currentScenarioIndex = 0;
        let currentDay = 1;
        let participantId = '';

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ª
        const defaultScenarios = [
            {
                title: "å‹äººåŒå£«ã®ä¼šè©±",
                content: "å¤§å­¦ã®å›³æ›¸é¤¨ã§ã€å¤ªéƒã¨èŠ±å­ãŒæœŸæœ«è©¦é¨“ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã€‚å¤ªéƒï¼šã€Œã‚‚ã†å…¨ç„¶åˆ†ã‹ã‚‰ãªã„ã€‚ã“ã®ã¾ã¾ã˜ã‚ƒçµ¶å¯¾ã«è½ã¡ã‚‹ã€èŠ±å­ï¼šã€Œå¤§ä¸ˆå¤«ã ã‚ˆã€ä¸€ç·’ã«å‹‰å¼·ã—ã‚ˆã†ã€å¤ªéƒï¼šã€Œå›ã¯é ­ã„ã„ã‹ã‚‰ãã†è¨€ãˆã‚‹ã‚“ã ã€å¤ªéƒã¯æœºã«çªã£ä¼ã—ã€èŠ±å­ã¯å›°ã£ãŸè¡¨æƒ…ã‚’æµ®ã‹ã¹ã¦ã„ã‚‹ã€‚"
            },
            {
                title: "è·å ´ã§ã®ä¼šè©±", 
                content: "ã‚ªãƒ•ã‚£ã‚¹ã§æ–°å…¥ç¤¾å“¡ã®Aå­ã¨å…ˆè¼©ã®Bç”·ãŒè©±ã—ã¦ã„ã‚‹ã€‚Aå­ï¼šã€Œã™ã¿ã¾ã›ã‚“ã€ã¾ã ç†è§£ã§ãã¦ã„ã¾ã›ã‚“ã€Bç”·ï¼šã€Œã‚‚ã†3å›èª¬æ˜ã—ãŸã‚ˆã­ã€Aå­ã¯ä¸‹ã‚’å‘ãã€Bç”·ã¯å°‘ã—ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸæ§˜å­ã§è…•ã‚’çµ„ã‚“ã§ã„ã‚‹ã€‚å‘¨ã‚Šã®åŒåƒšãŸã¡ã¯ãã®æ§˜å­ã‚’ã¡ã‚‰ã¡ã‚‰ã¨è¦‹ã¦ã„ã‚‹ã€‚"
            }
        ];

        // åˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰
        async function init() {
            console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
            
            // ç’°å¢ƒãƒã‚§ãƒƒã‚¯
            checkEnvironment();
            
            // Supabaseã®åˆæœŸåŒ–ã‚’ç¢ºèª
            if (!initializeSupabase()) {
                console.warn('âš ï¸  SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚');
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                loadFromLocalStorage();
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–
                if (scenarios.length === 0) {
                    scenarios = [...defaultScenarios];
                }
                updateScenarioList();
                loadAdminConfigUI();
                return;
            }
            
            try {
                await loadAdminSettings();
                await loadScenarios();
                await loadExperimentLogs();
                
                // ç®¡ç†è€…ç”»é¢ã®åˆæœŸåŒ–
                loadAdminConfigUI();
                updateScenarioList();
                updateLogsList();
                
                console.log('âœ… åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
                loadFromLocalStorage();
                if (scenarios.length === 0) {
                    scenarios = [...defaultScenarios];
                }
                updateScenarioList();
                loadAdminConfigUI();
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadFromLocalStorage() {
            console.log('ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            // ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedAdminConfig = localStorage.getItem('mentalizeAdminConfig');
            if (savedAdminConfig) {
                try {
                    adminConfig = { ...adminConfig, ...JSON.parse(savedAdminConfig) };
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch (error) {
                    console.warn('âš ï¸  ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                }
            }
            
            // ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿
            const savedScenarios = localStorage.getItem('mentalizeScenarios');
            if (savedScenarios) {
                try {
                    scenarios = JSON.parse(savedScenarios);
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', scenarios.length + 'ä»¶');
                } catch (error) {
                    console.warn('âš ï¸  ãƒ­ãƒ¼ã‚«ãƒ«ã‚·ãƒŠãƒªã‚ªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                    scenarios = [...defaultScenarios];
                }
            }
            
            // å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
            const savedLogs = localStorage.getItem('mentalizeExperimentLogs');
            if (savedLogs) {
                try {
                    experimentLogs = JSON.parse(savedLogs);
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', experimentLogs.length + 'ä»¶');
                } catch (error) {
                    console.warn('âš ï¸  ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿé¨“ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                    experimentLogs = [];
                }
            }
        }

        // Supabaseã‹ã‚‰ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿
        async function loadAdminSettings() {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                return;
            }
            
            try {
                console.log('ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const { data, error } = await supabase
                    .from('admin_settings')
                    .select('*')
                    .eq('id', 'admin_config')
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                        console.log('ç®¡ç†è€…è¨­å®šãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ä½œæˆã—ã¾ã™');
                        await saveAdminSettings();
                        return;
                    }
                    throw error;
                }
                
                if (data && data.settings) {
                    adminConfig = { ...adminConfig, ...data.settings };
                    console.log('ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ç®¡ç†è€…è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        }

        // Supabaseã«ç®¡ç†è€…è¨­å®šã‚’ä¿å­˜
        async function saveAdminSettings() {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
                return;
            }
            
            try {
                console.log('ç®¡ç†è€…è¨­å®šã‚’ä¿å­˜ä¸­...');
                const { error } = await supabase
                    .from('admin_settings')
                    .upsert({
                        id: 'admin_config',
                        settings: adminConfig,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                console.log('ç®¡ç†è€…è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ç®¡ç†è€…è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
                throw error;
            }
        }

        // Supabaseã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿
        async function loadScenarios() {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                scenarios = [...defaultScenarios];
                return;
            }
            
            try {
                console.log('ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const { data, error } = await supabase
                    .from('admin_settings')
                    .select('*')
                    .eq('id', 'scenarios')
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('ã‚·ãƒŠãƒªã‚ªãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ªã§ä½œæˆã—ã¾ã™');
                        scenarios = [...defaultScenarios];
                        await saveScenarios();
                        return;
                    }
                    throw error;
                }
                
                if (data && data.settings && data.settings.scenarios) {
                    scenarios = data.settings.scenarios;
                    console.log('ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', scenarios.length + 'ä»¶');
                } else {
                    scenarios = [...defaultScenarios];
                    await saveScenarios();
                }
            } catch (error) {
                console.error('ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                scenarios = [...defaultScenarios];
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ªã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        }

        // Supabaseã«ã‚·ãƒŠãƒªã‚ªã‚’ä¿å­˜
        async function saveScenarios() {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
                return;
            }
            
            try {
                console.log('ã‚·ãƒŠãƒªã‚ªã‚’ä¿å­˜ä¸­...');
                const { error } = await supabase
                    .from('admin_settings')
                    .upsert({
                        id: 'scenarios',
                        settings: { scenarios },
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                console.log('ã‚·ãƒŠãƒªã‚ªã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚·ãƒŠãƒªã‚ªä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
                throw error;
            }
        }

        // Supabaseã‹ã‚‰å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        async function loadExperimentLogs() {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
                const logs = localStorage.getItem('mentalizeExperimentLogs');
                experimentLogs = logs ? JSON.parse(logs) : [];
                return;
            }
            
            try {
                console.log('å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const { data, error } = await supabase
                    .from('experiment_logs')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                experimentLogs = data || [];
                console.log('å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', experimentLogs.length + 'ä»¶');
            } catch (error) {
                console.error('å®Ÿé¨“ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const logs = localStorage.getItem('mentalizeExperimentLogs');
                experimentLogs = logs ? JSON.parse(logs) : [];
            }
        }

        // Supabaseã«å®Ÿé¨“ãƒ­ã‚°ã‚’ä¿å­˜
        async function saveExperimentLog(logData) {
            if (!supabase) {
                console.log('SupabaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                const logs = JSON.parse(localStorage.getItem('mentalizeExperimentLogs') || '[]');
                const newLog = {
                    id: Date.now(),
                    participant_id: logData.participantId,
                    day: logData.day,
                    experiment_type: logData.experimentType,
                    scenario_title: logData.scenarioTitle,
                    data: {
                        analysis: logData.analysis,
                        chatHistory: logData.chatHistory,
                        model: adminConfig.model,
                        scenarioIndex: logData.scenarioIndex
                    },
                    created_at: new Date().toISOString()
                };
                logs.unshift(newLog);
                localStorage.setItem('mentalizeExperimentLogs', JSON.stringify(logs));
                experimentLogs = logs;
                
                if (document.getElementById('experimentLogsList')) {
                    updateLogsList();
                }
                return;
            }
            
            try {
                console.log('å®Ÿé¨“ãƒ­ã‚°ã‚’ä¿å­˜ä¸­...', logData.participantId);
                
                // å‚åŠ è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                await supabase
                    .from('participants')
                    .upsert({
                        id: logData.participantId,
                        last_access: new Date().toISOString()
                    });

                // å®Ÿé¨“ãƒ­ã‚°ã‚’ä¿å­˜
                const { error } = await supabase
                    .from('experiment_logs')
                    .insert({
                        participant_id: logData.participantId,
                        day: logData.day,
                        experiment_type: logData.experimentType,
                        scenario_title: logData.scenarioTitle,
                        data: {
                            analysis: logData.analysis,
                            chatHistory: logData.chatHistory,
                            model: adminConfig.model,
                            scenarioIndex: logData.scenarioIndex
                        }
                    });
                
                if (error) throw error;
                
                console.log('å®Ÿé¨“ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                
                // ãƒ­ã‚°ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                await loadExperimentLogs();
                if (document.getElementById('experimentLogsList')) {
                    updateLogsList();
                }
            } catch (error) {
                console.error('å®Ÿé¨“ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
            }
        }

        // ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
        function attemptAdminAccess() {
            const inputPassword = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminAccessError');
            
            if (!inputPassword) {
                errorDiv.innerHTML = '<div class="status error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            if (inputPassword === adminConfig.adminPassword) {
                isAdminAuthenticated = true;
                errorDiv.innerHTML = '<div class="status success">èªè¨¼æˆåŠŸï¼ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™...</div>';
                
                document.getElementById('adminPassword').value = '';
                
                setTimeout(() => {
                    selectMode('admin');
                }, 1000);
            } else {
                errorDiv.innerHTML = '<div class="status error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™</div>';
                
                setTimeout(() => {
                    errorDiv.innerHTML = '';
                }, 3000);
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            if (mode === 'admin' && !isAdminAuthenticated) {
                alert('ç®¡ç†è€…èªè¨¼ãŒå¿…è¦ã§ã™');
                return;
            }
            
            currentMode = mode;
            document.getElementById('modeSelector').style.display = mode === 'none' ? 'block' : 'none';
            document.getElementById('adminNav').classList.toggle('active', mode === 'admin');
            document.getElementById('participantNav').classList.toggle('active', mode === 'participant');

            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            if (mode === 'admin') {
                showAdminScreen('adminConfig');
            } else if (mode === 'participant') {
                showParticipantScreen('participantStart');
            }
        }

        // ç®¡ç†è€…ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showAdminScreen(screenId) {
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // è¢«é¨“è€…ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showParticipantScreen(screenId) {
            document.querySelectorAll('#participantNav .nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function adminLogout() {
            isAdminAuthenticated = false;
            selectMode('none');
        }

        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
        async function changeAdminPassword() {
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('ä¸¡æ–¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                adminConfig.adminPassword = newPassword;
                await saveAdminSettings();
                
                document.getElementById('newAdminPassword').value = '';
                document.getElementById('confirmAdminPassword').value = '';
                
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚');
            } catch (error) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ç®¡ç†è€…è¨­å®šä¿å­˜
        async function saveAdminConfig() {
            try {
                adminConfig.apiKey = document.getElementById('adminApiKey').value;
                adminConfig.model = document.getElementById('modelSelect').value;

                await saveAdminSettings();
                
                document.getElementById('configStatus').innerHTML = '<div class="status success">è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼</div>';
                
                setTimeout(() => {
                    document.getElementById('configStatus').innerHTML = '';
                }, 3000);
            } catch (error) {
                document.getElementById('configStatus').innerHTML = '<div class="status error">è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</div>';
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šä¿å­˜
        async function savePromptConfig() {
            try {
                adminConfig.systemPrompt = document.getElementById('systemPrompt').value;
                await saveAdminSettings();
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
            } catch (error) {
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ç®¡ç†è€…è¨­å®šUIã«èª­ã¿è¾¼ã¿
        function loadAdminConfigUI() {
            if (document.getElementById('adminApiKey')) {
                document.getElementById('adminApiKey').value = adminConfig.apiKey || '';
            }
            if (document.getElementById('modelSelect')) {
                document.getElementById('modelSelect').value = adminConfig.model || 'gpt-3.5-turbo';
            }
            if (document.getElementById('systemPrompt')) {
                document.getElementById('systemPrompt').value = adminConfig.systemPrompt || '';
            }
        }

        // ã‚·ãƒŠãƒªã‚ªè¿½åŠ 
        async function addScenario() {
            const title = document.getElementById('scenarioTitle').value;
            const content = document.getElementById('scenarioContent').value;

            if (!title || !content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                scenarios.push({ title, content });
                await saveScenarios();
                updateScenarioList();
                
                document.getElementById('scenarioTitle').value = '';
                document.getElementById('scenarioContent').value = '';
                
                alert('ã‚·ãƒŠãƒªã‚ªãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
            } catch (error) {
                alert('ã‚·ãƒŠãƒªã‚ªã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
                scenarios.pop();
            }
        }

        // ã‚·ãƒŠãƒªã‚ªãƒªã‚¹ãƒˆæ›´æ–°
        function updateScenarioList() {
            const list = document.getElementById('scenarioList');
            if (!list) return;
            
            list.innerHTML = '';
            
            if (scenarios.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center;">ã‚·ãƒŠãƒªã‚ªãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            scenarios.forEach((scenario, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease;';
                item.innerHTML = `
                    <h4 style="margin-bottom: 10px; color: #495057;">${scenario.title}</h4>
                    <p style="margin-bottom: 15px; color: #6c757d; line-height: 1.5;">${scenario.content.substring(0, 200)}${scenario.content.length > 200 ? '...' : ''}</p>
                    <button class="btn" onclick="deleteScenario(${index})" style="background: #dc3545; font-size: 14px; padding: 8px 16px;">å‰Šé™¤</button>
                `;
                list.appendChild(item);
            });
        }

        // ã‚·ãƒŠãƒªã‚ªå‰Šé™¤
        async function deleteScenario(index) {
            if (!confirm('ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const deletedScenario = scenarios[index];
                scenarios.splice(index, 1);
                await saveScenarios();
                updateScenarioList();
                alert('ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                alert('ã‚·ãƒŠãƒªã‚ªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
                scenarios.splice(index, 0, deletedScenario);
                updateScenarioList();
            }
        }

        // ãƒ­ã‚°ãƒªã‚¹ãƒˆæ›´æ–°
        function updateLogsList() {
            updateParticipantFilter();
            displayFilteredLogs();
        }

        // å‚åŠ è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateParticipantFilter() {
            const filterSelect = document.getElementById('filterParticipant');
            if (!filterSelect) return;
            
            const participants = [...new Set(experimentLogs.map(log => log.participant_id))];
            filterSelect.innerHTML = '<option value="">å…¨ã¦ã®å‚åŠ è€…</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                filterSelect.appendChild(option);
            });
        }

        // ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterLogs() {
            displayFilteredLogs();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ­ã‚°ã‚’è¡¨ç¤º
        function displayFilteredLogs() {
            const list = document.getElementById('experimentLogsList');
            if (!list) return;
            
            const participantFilter = document.getElementById('filterParticipant')?.value || '';
            const dayFilter = document.getElementById('filterDay')?.value || '';
            
            let filteredLogs = experimentLogs.filter(log => {
                return (!participantFilter || log.participant_id === participantFilter) &&
                       (!dayFilter || log.day?.toString() === dayFilter);
            });
            
            list.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center;">æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            filteredLogs.forEach(log => {
                const item = document.createElement('div');
                item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
                
                const date = new Date(log.created_at).toLocaleString('ja-JP');
                const typeLabels = {
                    'self_analysis': 'è‡ªåŠ›åˆ†æ',
                    'agent_assisted': 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´'
                };
                
                let content = '';
                if (log.experiment_type === 'self_analysis') {
                    content = `<div><strong>åˆ†æå†…å®¹:</strong><br>${log.data?.analysis || ''}</div>`;
                } else if (log.experiment_type === 'agent_assisted') {
                    const chatHistory = log.data?.chatHistory || [];
                    content = `<div><strong>ä¼šè©±å±¥æ­´:</strong><br>${chatHistory.map(msg => `${msg.sender}: ${msg.content}`).join('<br>')}</div>`;
                }
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <span style="font-weight: 600;">å‚åŠ è€…: ${log.participant_id}</span>
                            <span style="margin-left: 10px; background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${typeLabels[log.experiment_type]}</span>
                            ${log.day ? `<span style="margin-left: 10px; color: #6c757d;">Day ${log.day}</span>` : ''}
                        </div>
                        <div style="font-size: 14px; color: #6c757d;">${date}</div>
                    </div>
                    ${log.scenario_title ? `<div style="margin-bottom: 10px;"><strong>ã‚·ãƒŠãƒªã‚ª:</strong> ${log.scenario_title}</div>` : ''}
                    ${content}
                `;
                list.appendChild(item);
            });
        }

        // ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›
        function exportData() {
            if (experimentLogs.length === 0) {
                alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let csv = 'ID,å‚åŠ è€…ID,å®Ÿé¨“æ—¥,å®Ÿé¨“ã‚¿ã‚¤ãƒ—,ã‚·ãƒŠãƒªã‚ª,ãƒ‡ãƒ¼ã‚¿,ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—\n';
            
            experimentLogs.forEach(log => {
                let data = '';
                if (log.experiment_type === 'self_analysis') {
                    data = log.data?.analysis?.replace(/"/g, '""') || '';
                } else if (log.experiment_type === 'agent_assisted') {
                    data = log.data?.chatHistory?.map(msg => `${msg.sender}: ${msg.content}`).join(' | ') || '';
                }
                
                csv += `"${log.id}","${log.participant_id}","${log.day || ''}","${log.experiment_type}","${log.scenario_title || ''}","${data}","${log.created_at}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `mentalize_experiment_data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // å®Ÿé¨“é–‹å§‹
        async function startExperiment() {
            participantId = document.getElementById('participantId').value;
            currentDay = parseInt(document.getElementById('experimentDay').value);
            
            if (!participantId) {
                alert('å‚åŠ è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (scenarios.length === 0) {
                alert('ã‚·ãƒŠãƒªã‚ªãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            document.getElementById('participantSetup').style.display = 'none';
            document.getElementById('experimentContent').style.display = 'block';
            
            startMainExperiment();
        }

        // ãƒ¡ã‚¤ãƒ³å®Ÿé¨“é–‹å§‹
        function startMainExperiment() {
            currentScenarioIndex = Math.floor(Math.random() * scenarios.length);
            displayScenario();
        }

        // ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º
        function displayScenario() {
            const scenario = scenarios[currentScenarioIndex];
            document.getElementById('currentScenarioTitle').textContent = scenario.title;
            document.getElementById('currentScenarioContent').textContent = scenario.content;
            document.getElementById('scenarioDisplay').style.display = 'block';
            
            document.getElementById('progressFill').style.width = '40%';
            
            if (currentDay === 1 || currentDay === 7) {
                document.getElementById('selfMentalize').style.display = 'block';
                document.getElementById('agentChat').style.display = 'none';
            } else {
                document.getElementById('selfMentalize').style.display = 'none';
                document.getElementById('agentChat').style.display = 'block';
                initializeChat();
            }
        }

        // åˆ†ææå‡º
        async function submitAnalysis() {
            const analysis = document.getElementById('userAnalysis').value;
            if (!analysis.trim()) {
                alert('åˆ†æã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            await saveExperimentLog({
                participantId,
                day: currentDay,
                scenarioIndex: currentScenarioIndex,
                scenarioTitle: scenarios[currentScenarioIndex].title,
                analysis,
                experimentType: 'self_analysis'
            });

            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('selfMentalize').style.display = 'none';
            document.getElementById('experimentComplete').style.display = 'block';
        }

        // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
        function initializeChat() {
            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';
            
            addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼ã“ã®ã‚·ãƒŠãƒªã‚ªã«ã¤ã„ã¦ã€ç™»å ´äººç‰©ã®æ°—æŒã¡ã‚„è€ƒãˆã‚’ä¸€ç·’ã«æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¾ãšã€ã©ã®äººç‰©ã«æ³¨ç›®ã—ã¾ã™ã‹ï¼Ÿ');
            
            document.getElementById('progressFill').style.width = '50%';
        }

        // ãƒãƒ£ãƒƒãƒˆçµ‚äº†
        async function finishChat() {
            await saveExperimentLog({
                participantId,
                day: currentDay,
                scenarioIndex: currentScenarioIndex,
                scenarioTitle: scenarios[currentScenarioIndex].title,
                chatHistory: getChatHistory(),
                experimentType: 'agent_assisted'
            });

            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('agentChat').style.display = 'none';
            document.getElementById('experimentComplete').style.display = 'block';
        }

        // å®Ÿé¨“ãƒªã‚»ãƒƒãƒˆ
        function resetExperiment() {
            document.getElementById('experimentContent').style.display = 'none';
            document.getElementById('participantSetup').style.display = 'block';
            document.getElementById('userAnalysis').value = '';
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            
            ['scenarioDisplay', 'selfMentalize', 'agentChat', 'experimentComplete'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            
            const response = await generateAIResponse(message);
            addMessage('ai', response);
        }

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´å–å¾—
        function getChatHistory() {
            const messages = document.querySelectorAll('#chatMessages .message');
            return Array.from(messages).map(msg => ({
                sender: msg.classList.contains('user') ? 'user' : 'ai',
                content: msg.textContent,
                timestamp: new Date().toISOString()
            }));
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addMessage(sender, text) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // AIå¿œç­”ç”Ÿæˆ
        async function generateAIResponse(userMessage) {
            if (adminConfig.apiKey && adminConfig.apiKey.startsWith('sk-')) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: adminConfig.model,
                            messages: [
                                {
                                    role: 'system',
                                    content: adminConfig.systemPrompt
                                },
                                {
                                    role: 'user',
                                    content: `ã‚·ãƒŠãƒªã‚ª: ${scenarios[currentScenarioIndex].content}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€: ${userMessage}`
                                }
                            ],
                            max_tokens: 300,
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API request failed');
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('OpenAI API ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // ãƒ‡ãƒ¢ç”¨ã®å¿œç­”
            const responses = [
                "ãªã‚‹ã»ã©ã€ãã®è¦³ç‚¹ã¯èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚ç™»å ´äººç‰©ã®è¡¨æƒ…ã‚„è¡Œå‹•ã‹ã‚‰ã‚‚ä½•ã‹èª­ã¿å–ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                "ã¨ã¦ã‚‚è‰¯ã„åˆ†æã§ã™ã­ã€‚ä»–ã®ç™»å ´äººç‰©ã¯ã©ã®ã‚ˆã†ãªæ°—æŒã¡ã§ã„ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
                "ãã®é€šã‚Šã§ã™ã­ã€‚ã•ã‚‰ã«æ·±ãè€ƒãˆã¦ã¿ã‚‹ã¨ã€ãªãœãã®ã‚ˆã†ãªæ„Ÿæƒ…ã‚’æŠ±ã„ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                "ç´ æ™´ã‚‰ã—ã„æ°—ã¥ãã§ã™ã€‚ãã“ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹äººé–“é–¢ä¿‚ã¯ã©ã®ã‚ˆã†ãªã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                "èˆˆå‘³æ·±ã„æŒ‡æ‘˜ã§ã™ã­ã€‚ãã®çŠ¶æ³ã§ç›¸æ‰‹ã¯ã©ã‚“ãªã“ã¨ã‚’è€ƒãˆã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                "è‰¯ã„è¦–ç‚¹ã§ã™ã­ã€‚ã‚‚ã—è‡ªåˆ†ãŒãã®ç«‹å ´ã ã£ãŸã‚‰ã€ã©ã®ã‚ˆã†ã«æ„Ÿã˜ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
            ];
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            // SupabaseåˆæœŸåŒ–å¾Œã®å‡¦ç†
            window.initAfterSupabaseLoad = init;
            
            // ã™ã§ã«SupabaseãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«åˆæœŸåŒ–
            if (window.supabase || window.Supabase) {
                init();
            } else {
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ã‚’è©¦è¡Œ
                setTimeout(init, 100);
            }
            
            // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã§Enterã‚­ãƒ¼
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã§Enterã‚­ãƒ¼
            const adminPasswordInput = document.getElementById('adminPassword');
            if (adminPasswordInput) {
                adminPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        attemptAdminAccess();
                    }
                });
            }
        });
    </script>
</body>
</html>
