

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- â‘  Import Map  : è£¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§è§£æ±º  -->
  <script type="importmap">
  {
  "imports": {
    "@supabase/supabase-js"  : "https://esm.sh/@supabase/supabase-js@2",
    "@supabase/auth-js"      : "https://esm.sh/@supabase/auth-js@2",
    "@supabase/postgrest-js" : "https://esm.sh/@supabase/postgrest-js@1",
    "@supabase/realtime-js"  : "https://esm.sh/@supabase/realtime-js@2",
    "@supabase/storage-js"   : "https://esm.sh/@supabase/storage-js@2",
    "@supabase/functions-js" : "https://esm.sh/@supabase/functions-js@2"
  }
}

  </script>
<!--   <div id="surveyContainer" style="display: none; padding: 1em; background: #f9f9f9;"></div> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            overflow: hidden;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .mode-selector {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: #374151;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 200px;
        }

        .mode-btn:hover {
            background: #4b5563;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .mode-btn.participant {
            background: #059669;
        }
        
        .mode-btn.participant:hover {
            background: #047857;
        }

        .nav {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .nav.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .nav-btn:hover {
            background: #9ca3af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .nav-btn.active {
            background: #dc2626;
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .admin-config {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .admin-config h3 {
            color: #856404;
            margin-bottom: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .participant-interface {
            max-width: 800px;
            margin: 0 auto;
        }

        .participant-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .experiment-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .scenario-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 100px;
            max-height: 60vh;
            overflow-y: auto;
            resize: vertical;
            position: relative;
        }
        
        .scenario-card::after {
            content: 'â‹®â‹®â‹®';
            position: absolute;
            bottom: 8px;
            right: 12px;
            color: #adb5bd;
            font-size: 12px;
            pointer-events: none;
            opacity: 0.6;
        }

        .scenario-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .scenario-card p {
            line-height: 1.6;
            color: #6c757d;
        }

        .chat-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            height: 400px;
            min-height: 200px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resize: vertical;
            position: relative;
        }
        
        .chat-container::after {
            content: 'â‹®â‹®â‹®';
            position: absolute;
            bottom: 2px;
            right: 6px;
            color: #adb5bd;
            font-size: 12px;
            pointer-events: none;
            opacity: 0.6;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background: #e9ecef;
            color: #495057;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .chat-input {
            background: #f8f9fa;
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #e9ecef;
        }

        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            min-height: 60px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-input button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .mode-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 100%;
                max-width: 300px;
            }
            
            /* ãƒãƒ£ãƒƒãƒˆç”»é¢ã®æ”¹å–„ */
            .chat-container {
                min-height: 300px;
                max-height: 60vh;
            }
            
            .chat-messages {
                min-height: 250px;
                max-height: 50vh;
                padding: 10px;
            }
            
            .chat-input {
                flex-direction: column;
                gap: 10px;
                padding: 15px 10px;
            }
            
            .chat-input textarea {
                width: 100% !important;
                min-height: 60px;
                max-height: 120px;
                font-size: 16px;
                padding: 12px;
                border-radius: 8px;
            }
            
            .chat-input button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                max-width: none;
            }
            
            /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„ */
            .message {
                max-width: 90%;
                font-size: 14px;
                padding: 10px 12px;
                margin-bottom: 8px;
                line-height: 1.4;
            }
            
            /* è‡ªåŠ›åˆ†æç”»é¢ã®æ”¹å–„ */
            #userAnalysis {
                width: 100% !important;
                min-height: 150px;
                font-size: 16px;
                padding: 12px;
                border-radius: 8px;
                line-height: 1.4;
            }
            
            /* ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºã®æ”¹å–„ */
            .scenario-card {
                padding: 15px;
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
            .btn {
                font-size: 16px;
                padding: 12px 20px;
                min-height: 44px;
            }
            
            /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æ”¹å–„ */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
                display: block;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                padding: 12px;
                border-radius: 8px;
            }
        }
        
        /* ã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰ */
        .compact-mode {
            padding: 2px !important;
            margin: 0 !important;
            max-width: 100% !important;
            width: 100vw !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            box-sizing: border-box !important;
        }
        
        .compact-mode .header {
            padding: 8px !important;
            font-size: 0.9em;
            margin: 0 !important;
        }
        
        .compact-mode .header h1 {
            font-size: 1.4em !important;
            margin-bottom: 5px !important;
        }
        
        .compact-mode .participant-interface {
            padding: 2px !important;
            margin: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        .compact-mode #experimentContent {
            padding: 5px !important;
            margin: 0 !important;
        }
        
        .compact-mode .chat-container {
            border: 1px solid #e9ecef !important;
            border-radius: 6px !important;
            margin: 3px 0 !important;
            padding: 5px !important;
        }
        
        .compact-mode .scenario-card {
            padding: 8px !important;
            margin: 3px 0 !important;
            border-radius: 6px !important;
        }
        
        .compact-mode .chat-input {
            padding: 5px !important;
        }
        
        .compact-mode .content {
            padding: 8px !important;
        }
        
        body.compact-body {
            padding: 2px !important;
            margin: 0 !important;
            background: white;
            overflow-x: hidden !important;
            }
            
            /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
            .admin-config.editing-mode {
                background: #e8f4fd !important;
                border-color: #007bff !important;
                box-shadow: 0 0 15px rgba(0, 123, 255, 0.2) !important;
            }
            
            .admin-config.editing-mode h3 {
                color: #007bff !important;
            }
            
            .admin-config.editing-mode h3:before {
                content: "âœï¸ ç·¨é›†ä¸­ - ";
            }
            
            /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®èª¿æ•´ */
            #sessionTimer {
                font-size: 14px;
                padding: 8px;
            }
            
            /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®èª¿æ•´ */
            .progress-bar {
                margin: 15px 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
    <div id="surveyContainer" style="display: none; padding: 1em; background: #f9f9f9;"></div>
        <div class="header">
            <h1>ğŸ§  ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ä»–è€…ã®èªçŸ¥ã¨æ„Ÿæƒ…ã‚’ç†è§£ã™ã‚‹èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†</p>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
        <div id="modeSelector" class="mode-selector">
            <h2 style="margin-bottom: 20px; color: #495057;">å®Ÿé¨“å‚åŠ è€…ã®æ–¹ã¸</h2>
            <p style="margin-bottom: 30px; color: #6c757d; font-size: 18px;">
                ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´å®Ÿé¨“ã«ã”å‚åŠ ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
                ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å®Ÿé¨“ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            </p>
            <div class="mode-buttons">
                <button id="participantBtn" class="mode-btn participant" style="transform: scale(1.1); margin-bottom: 30px;">
                    ğŸ¯ å®Ÿé¨“ã‚’é–‹å§‹ã™ã‚‹<br>
                    <small>ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºè¨“ç·´å®Ÿæ–½</small>
                </button>
            </div>
            
            <!-- ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #e9ecef;">
                <details style="text-align: left; max-width: 400px; margin: 0 auto;">
                    <summary style="cursor: pointer; color: #6c757d; font-size: 14px; text-align: center;">
                        ç ”ç©¶è€…ãƒ»ç®¡ç†è€…ã®æ–¹ã¯ã“ã¡ã‚‰
                    </summary>
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <div class="form-group">
                            <label for="adminPassword" style="font-size: 14px;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom: 15px;">
                        </div>
                        <button id="adminAccessBtn" class="btn" style="width: 100%; font-size: 14px; padding: 10px;">
                            ğŸ”§ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹
                        </button>
                        <div id="adminAccessError" style="margin-top: 10px;"></div>
                    </div>
                </details>
            </div>
        </div>

        <!-- ç®¡ç†è€…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div id="adminNav" class="nav">
            <div class="nav-buttons">
                <button id="adminConfigNav" class="nav-btn active">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</button>
                <button id="adminScenariosNav" class="nav-btn">ğŸ“ ã‚·ãƒŠãƒªã‚ªç®¡ç†</button>
                <button id="adminAssignmentsNav" class="nav-btn">ğŸ“Š å‰²ã‚Šå½“ã¦çŠ¶æ³</button>
                <button id="adminLogsNav" class="nav-btn">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿é–²è¦§</button>
                <button id="adminSurveysNav" class="nav-btn">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</button>

            </div>
        </div>

        <!-- è¢«é¨“è€…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div id="participantNav" class="nav">
            <div class="nav-buttons">
                <!-- å®Ÿé¨“é–‹å§‹ãƒœã‚¿ãƒ³ã¯æ©Ÿèƒ½ã—ãªã„ãŸã‚å‰Šé™¤ -->
            </div>
        </div>

        <div class="content">
            <!-- ç®¡ç†è€…ç”»é¢ -->
            <div id="adminConfig" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn" class="back-btn">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
                
                <div class="admin-config">
                    <h3>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="newAdminPassword">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</label>
                            <input type="password" id="newAdminPassword" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        </div>
                        <div class="form-group">
                            <label for="confirmAdminPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                            <input type="password" id="confirmAdminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›">
                        </div>
                    </div>
                    <button id="changePasswordBtn" class="btn" style="background: #dc3545;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
                </div>

                <div class="admin-config">
                    <h3>ğŸ¤– AI API è¨­å®š</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="apiProvider">APIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</label>
                            <select id="apiProvider">
                                <option value="openai">OpenAI</option>
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ URL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adminApiKey">API ã‚­ãƒ¼</label>
                            <input type="password" id="adminApiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
                        </div>
                        <div class="form-group" id="customUrlGroup" style="display: none;">
                            <label for="customApiUrl">ã‚«ã‚¹ã‚¿ãƒ API URL</label>
                            <input type="text" id="customApiUrl" placeholder="https://api.example.com/v1/chat/completions">
                        </div>
                        <div class="form-group">
                            <label for="modelSelect">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</label>
                            <select id="modelSelect">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                            </select>
                            <button type="button" id="validateModelBtn" class="btn" style="margin-top: 5px; background: #17a2b8; color: white; padding: 5px 10px; font-size: 12px;">âœ… ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œè¨¼</button>
                            <div id="modelValidationResult" style="margin-top: 5px; font-size: 12px;"></div>
                        </div>
                        <div class="form-group" id="customModelGroup" style="display: none;">
                            <label for="customModelName">ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å</label>
                            <input type="text" id="customModelName" placeholder="ä¾‹: gpt-4-turbo, claude-4-sonnet, gemini-pro">
                        </div>
                        <div class="form-group">
                          <label for="maxTokens">æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°</label>
                          <input type="number" id="maxTokens" value="300" min="1">
                        </div>
                        <div class="form-group">
                          <label for="temperature">Temperature</label>
                          <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2">
                        </div>
                        <div class="form-group">
                          <label for="sessionTimeout">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (åˆ†)</label>
                          <input type="number" id="sessionTimeout" value="30" min="1">
                        </div>
                        <div class="form-group">
                          <label for="showTimer">ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒéæ™‚é–“ã®è¡¨ç¤º</label><br>
                          <input type="checkbox" id="showTimer" checked>
                          <span>è¡¨ç¤ºã™ã‚‹</span>
                         </div>

                    </div>
                    <button id="saveConfigBtn" class="btn">è¨­å®šã‚’ä¿å­˜</button>
                </div>
                
                <div class="admin-config">
                    <h3>ğŸ’¬ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                    <div class="form-group">
                        <label for="systemPrompt">åŸºæœ¬æŒ‡ç¤º</label>
                        <textarea id="systemPrompt" style="height: 150px;"></textarea>
                    </div>
                    <button id="savePromptBtn" class="btn">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜</button>
                </div>

                <div class="admin-config">
                    <h3>ğŸ“ ç®¡ç†è€…ãƒ¡ãƒ¢</h3>
                    <div class="form-group">
                        <label for="adminMemo">ç®¡ç†è€…ç”¨ãƒ¡ãƒ¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ URLã€å®Ÿé¨“è¨­å®šç­‰ï¼‰</label>
                        <textarea id="adminMemo" style="height: 100px;" placeholder="ã‚«ã‚¹ã‚¿ãƒ URLã®è¨­å®šæ–¹æ³•ã€å®Ÿé¨“ã®æ³¨æ„äº‹é …ã€ãã®ä»–ãƒ¡ãƒ¢..."></textarea>
                    </div>
                    <button id="saveMemoBtn" class="btn">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
                </div>

                <div class="admin-config">
                    <h3>ğŸ‘¥ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†</h3>
                    <div class="form-group">
                        <label for="minimumSessionTime">æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                        <input type="number" id="minimumSessionTime" min="1" max="60" value="5" placeholder="æœ€ä½å®Ÿé¨“æ™‚é–“ã‚’åˆ†ã§å…¥åŠ›">
                        <small style="color: #6c757d;">ã“ã®æ™‚é–“ã«é”ã™ã‚‹ã¾ã§åˆ†ææå‡ºãƒ»å¯¾è©±çµ‚äº†ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™</small>
                    </div>
                    <button id="saveSessionConfigBtn" class="btn" style="margin-bottom: 20px;">ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã‚’ä¿å­˜</button>
                    <button id="showUserSessionsBtn" class="btn">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º</button>
                    <div id="userSessionsSection" style="display: none; margin-top: 20px;">
                        <h4>ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</h4>
                        <table id="userSessionsTable" border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">é–‹å§‹æ—¥</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">æœ€çµ‚æ›´æ–°</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="configStatus"></div>
            </div>

            <div id="adminScenarios" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn2" class="back-btn">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ“ ã‚·ãƒŠãƒªã‚ªç®¡ç†</h2>
                
                <div class="admin-config">
                    <h3>æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ </h3>
                    <div class="form-group">
                        <label for="scenarioTitle">ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="scenarioTitle" placeholder="ä¾‹: å‹äººåŒå£«ã®ä¼šè©±">
                    </div>
                    <div class="form-group">
                        <label for="scenarioContent">ã‚·ãƒŠãƒªã‚ªå†…å®¹</label>
                        <textarea id="scenarioContent" placeholder="ç™»å ´äººç‰©ã€çŠ¶æ³ã€å¯¾è©±å†…å®¹ã‚’è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="scenarioPromptQuestions">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨æƒ³å®šè³ªå•ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                        <textarea id="scenarioPromptQuestions" placeholder="æƒ³å®šã•ã‚Œã‚‹è³ªå•1\næƒ³å®šã•ã‚Œã‚‹è³ªå•2\næƒ³å®šã•ã‚Œã‚‹è³ªå•3" style="height: 120px;"></textarea>
                        <small style="color: #6c757d;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‚è€ƒã«ã™ã‚‹æƒ³å®šè³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                    </div>
                    <div class="form-group">
                        <label for="scenarioHiddenContext">éš ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
                        <textarea id="scenarioHiddenContext" placeholder="æ–‡ç« ä¸­ã«ã¯æ›¸ã‹ã‚Œã¦ã„ãªã„ãŒèª­ã¿å–ã‚Œã‚‹èƒŒæ™¯æƒ…å ±ã€ç™»å ´äººç‰©ã®å¿ƒç†çŠ¶æ…‹ã€çŠ¶æ³ã®è©³ç´°ã€æš—é»™ã®å‰æãªã©ã€AIãŒç†è§£ã™ã¹ãéš ã‚ŒãŸæƒ…å ±ã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚" style="height: 100px;"></textarea>
                        <small style="color: #6c757d;">ã‚·ãƒŠãƒªã‚ªã®æ·±å±¤çš„ãªæ„å‘³ã‚„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’æŸ”è»Ÿã«è¨˜è¿°ã§ãã¾ã™</small>
                    </div>
                    <div class="form-group">
                        <label for="scenarioAnalysisPoints">åˆ†ææ™‚ã®ç€ç›®ç‚¹ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
                        <textarea id="scenarioAnalysisPoints" placeholder="æ„Ÿæƒ…å¤‰åŒ–ã€äººé–“é–¢ä¿‚ã®å‹•ãã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã€å¿ƒç†çš„ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãªã©ã€ç‰¹ã«æ³¨æ„æ·±ãåˆ†æã™ã¹ãè¦ç´ ã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚" style="height: 100px;"></textarea>
                        <small style="color: #6c757d;">AIãŒåˆ†æã™ã‚‹éš›ã«é‡ç‚¹çš„ã«è€ƒæ…®ã™ã¹ããƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã§ãã¾ã™</small>
                    </div>
                    <button id="addScenarioBtn" class="btn">ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ </button>
                    <button id="cancelEditBtn" class="btn" style="background: #6c757d; display: none; margin-left: 10px;">ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>

                <div id="scenarioList">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <div id="adminAssignments" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn3" class="back-btn">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <h2>ğŸ“Š ã‚·ãƒŠãƒªã‚ªå‰²ã‚Šå½“ã¦çŠ¶æ³</h2>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <p style="margin-bottom: 20px; color: #6c757d;">å‚åŠ è€…ã”ã¨ã®ã‚·ãƒŠãƒªã‚ªå‰²ã‚Šå½“ã¦çŠ¶æ³ã¨é€²è¡ŒçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                    
                    <div id="assignmentsList">
                        <div style="text-align: center; padding: 20px; color: #6c757d;">å‰²ã‚Šå½“ã¦æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <div id="adminSurveys" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn4" class="back-btn">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†</h2>
                
                <div class="admin-config">
                    <h3>æ–°ã—ã„ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¿½åŠ </h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="surveyDay">å®Ÿé¨“æ—¥</label>
                            <select id="surveyDay">
                                <option value="1">1æ—¥ç›®</option>
                                <option value="2">2æ—¥ç›®</option>
                                <option value="3">3æ—¥ç›®</option>
                                <option value="4">4æ—¥ç›®</option>
                                <option value="5">5æ—¥ç›®</option>
                                <option value="6">6æ—¥ç›®</option>
                                <option value="7">7æ—¥ç›®</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label><br>
                            <input type="radio" name="surveyTiming" value="start" checked> å®Ÿé¨“é–‹å§‹æ™‚<br>
                            <input type="radio" name="surveyTiming" value="end"> å®Ÿé¨“çµ‚äº†æ™‚
                        </div>
                    </div>
                    
                    <div id="questionsContainer">
                        <h4>è³ªå•è¨­å®š</h4>
                        <div class="question-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <div class="form-group">
                                <label>è³ªå•å†…å®¹</label>
                                <textarea class="question-text" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="height: 60px;"></textarea>
                            </div>
                            <div class="form-group">
                                <label>å›ç­”å½¢å¼</label>
                                <select class="question-type">
                                    <option value="text">è‡ªç”±è¨˜è¿°</option>
                                    <option value="radio">å˜ä¸€é¸æŠ</option>
                                    <option value="checkbox">è¤‡æ•°é¸æŠ</option>
                                    <option value="scale">æ•°æ®µéšè©•ä¾¡</option>
                                </select>
                            </div>
                            <div class="options-container" style="display: none;">
                                <label>é¸æŠè‚¢ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                                <textarea class="question-options" placeholder="é¸æŠè‚¢1\né¸æŠè‚¢2\né¸æŠè‚¢3" style="height: 80px;"></textarea>
                            </div>
                            <div class="scale-container" style="display: none;">
                                <label>è©•ä¾¡ç¯„å›²</label>
                                <select class="scale-range">
                                    <option value="1-5">1-5æ®µéš</option>
                                    <option value="1-7">1-7æ®µéš</option>
                                    <option value="1-10">1-10æ®µéš</option>
                                </select>
                            </div>
                            <button type="button" class="btn remove-question" style="background: #dc3545; margin-top: 10px;">è³ªå•ã‚’å‰Šé™¤</button>
                        </div>
                    </div>
                    
                    <button id="addQuestionBtn" class="btn" style="background: #28a745;">è³ªå•ã‚’è¿½åŠ </button>
                    <button id="saveSurveyBtn" class="btn">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ä¿å­˜</button>
                </div>
                
                <div class="admin-config">
                    <h3>æ—¢å­˜ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
                    <div id="surveysList"></div>
                </div>
                
                <div class="admin-config">
                    <h3>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="resultParticipant">å‚åŠ è€…ID</label>
                            <select id="resultParticipant">
                                <option value="">å…¨ã¦ã®å‚åŠ è€…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultDay">å®Ÿé¨“æ—¥</label>
                            <select id="resultDay">
                                <option value="">å…¨ã¦ã®æ—¥</option>
                                <option value="1">1æ—¥ç›®</option>
                                <option value="2">2æ—¥ç›®</option>
                                <option value="3">3æ—¥ç›®</option>
                                <option value="4">4æ—¥ç›®</option>
                                <option value="5">5æ—¥ç›®</option>
                                <option value="6">6æ—¥ç›®</option>
                                <option value="7">7æ—¥ç›®</option>
                            </select>
                        </div>
                    </div>
                    <button id="loadSurveyResultsBtn" class="btn">çµæœã‚’èª­ã¿è¾¼ã¿</button>
                    <div id="surveyResults" style="margin-top: 20px;"></div>
                </div>
            </div>
            <div id="adminLogs" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="adminLogoutBtn3" class="back-btn">â† ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    <div style="background: #d4edda; color: #155724; padding: 8px 15px; border-radius: 20px; font-size: 14px;">
                        ğŸ” ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </div>
                </div>
                <h2>ğŸ“‹ å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿é–²è¦§</h2>
                
                <div class="admin-config">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="filterParticipant">å‚åŠ è€…ID</label>
                            <select id="filterParticipant">
                                <option value="">å…¨ã¦ã®å‚åŠ è€…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterDay">å®Ÿé¨“æ—¥</label>
                            <select id="filterDay">
                                <option value="">å…¨ã¦ã®æ—¥</option>
                                <option value="1">1æ—¥ç›®</option>
                                <option value="2">2æ—¥ç›®</option>
                                <option value="3">3æ—¥ç›®</option>
                                <option value="4">4æ—¥ç›®</option>
                                <option value="5">5æ—¥ç›®</option>
                                <option value="6">6æ—¥ç›®</option>
                                <option value="7">7æ—¥ç›®</option>
                            </select>
                        </div>
                    </div>
                    <button id="exportDataBtn" class="btn">ğŸ“ ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›</button>
                </div>
                
                <!-- å±¥æ­´å‰Šé™¤æ©Ÿèƒ½ -->
                <div class="admin-config" style="margin-top: 30px; border-top: 2px solid #dc3545;">
                    <h3 style="color: #dc3545;">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆå±é™ºãªæ“ä½œï¼‰</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="deleteParticipantId">å‰Šé™¤å¯¾è±¡ã®å‚åŠ è€…ID</label>
                            <select id="deleteParticipantId">
                                <option value="">å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å‰Šé™¤ã™ã‚‹ç¯„å›²</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #dee2e6;">
                                <label style="display: block; padding: 8px; margin: 4px 0; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #e9ecef;">
                                    <input type="radio" name="deleteScope" value="logs" style="margin-right: 10px;"> 
                                    <strong>ğŸ—„ï¸ å®Ÿé¨“ãƒ­ã‚°ã®ã¿</strong>
                                    <small style="display: block; color: #6c757d; margin-left: 25px;">ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã€å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å‰Šé™¤</small>
                                </label>
                                <label style="display: block; padding: 8px; margin: 4px 0; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #e9ecef;">
                                    <input type="radio" name="deleteScope" value="surveys" style="margin-right: 10px;"> 
                                    <strong>ğŸ“‹ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®ã¿</strong>
                                    <small style="display: block; color: #6c757d; margin-left: 25px;">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å‰Šé™¤</small>
                                </label>
                                <label style="display: block; padding: 8px; margin: 4px 0; background: #ffebee; border-radius: 6px; cursor: pointer; border: 2px solid #ffcdd2;">
                                    <input type="radio" name="deleteScope" value="all" checked style="margin-right: 10px;"> 
                                    <strong>ğŸ—‘ï¸ å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿å…¨ä½“</strong>
                                    <small style="display: block; color: #c62828; margin-left: 25px;">å‚åŠ è€…ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ï¼ˆå±é™ºï¼‰</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button id="deleteDataBtn" class="btn" style="background: #dc3545; margin-top: 15px;">
                        âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹
                    </button>
                    <p style="color: #dc3545; font-size: 12px; margin-top: 10px;">
                        âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å®Ÿè¡Œå‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
                    </p>
                </div>

                <div id="experimentLogsList">
                    <div style="text-align: center; padding: 20px; color: #6c757d;">å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- è¢«é¨“è€…ç”»é¢ -->
            <div id="participantStart" class="screen">
                <!-- å®Ÿé¨“åˆ¶å¾¡ãƒœã‚¿ãƒ³ï¼ˆå®Ÿé¨“å®Ÿè¡Œä¸­ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="experimentControls" style="display: none; text-align: center; margin-bottom: 15px;">
                    <button id="toggleCompactBtn" class="btn" style="background: #17a2b8; margin-right: 10px;" title="æ¨ªæ–¹å‘ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’æœ€å¤§åŒ–ã—ã¾ã™">
                        ğŸ“± ã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤º
                    </button>
                    <button id="pauseExperimentBtn" class="btn" style="background: #fbbf24; margin-right: 10px; display: none;" title="å®Ÿé¨“ã‚’ä¸€æ™‚ä¸­æ–­ã—ã¾ã™ã€‚ã€Œå®Ÿé¨“é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚">
                        â¸ï¸ ä¸€æ™‚ä¸­æ–­ã™ã‚‹
                    </button>
                    <button id="quitExperimentBtn" class="btn" style="background: #dc3545; display: none;">
                        âŒ å®Ÿé¨“ã‚’ã‚„ã‚ã¦æ—¥ä»˜é¸æŠã«æˆ»ã‚‹
                    </button>
                </div>
                <div class="participant-interface">
                    <div class="participant-header">
                        <h2 id="participantScreenTitle">ğŸ“… æ—¥ä»˜é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                        <p>ä»–è€…ã®å¿ƒã‚’ç†è§£ã™ã‚‹åŠ›ã‚’ä¸€ç·’ã«å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†</p>
                    </div>

                    <div class="experiment-card">
                        <div id="participantSetup">
                            <h3>å®Ÿé¨“ã®è¨­å®š</h3>
                            <div class="form-group">
                                <label for="participantId">å‚åŠ è€…ID</label>
                                <input type="text" id="participantId" placeholder="ä¾‹: P001">
                            </div>
                            <div class="form-group">
                                <label for="experimentDay">å®Ÿé¨“æ—¥</label>
                                <select id="experimentDay">
                                    <option value="1">1æ—¥ç›®ï¼ˆè‡ªåŠ›ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼‰</option>
                                    <option value="2">2æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="3">3æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="4">4æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="5">5æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="6">6æ—¥ç›®ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´ï¼‰</option>
                                    <option value="7">7æ—¥ç›®ï¼ˆè‡ªåŠ›ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼‰</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                                <button id="backToModeSelectBtn" class="back-btn" style="background: #6c757d; border-color: #6c757d;">â† å‰ã®ç”»é¢ã«æˆ»ã‚‹</button>
                                <button id="startExperimentBtn" class="btn" title="å®Ÿé¨“ã‚’é–‹å§‹ã—ã¾ã™ã€‚ä¸€æ™‚ä¸­æ–­å¾Œã¯ã“ã“ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚">å®Ÿé¨“é–‹å§‹</button>
                            </div>
                        </div>

                        <!-- å®Ÿé¨“å®Ÿè¡Œä¸­ã®ç”»é¢ -->
                        <div id="experimentContent" style="display: none;">
                            <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµŒéæ™‚é–“è¡¨ç¤º -->
                            <div id="sessionTimer" style="display: none; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; font-family: monospace; font-size: 16px; font-weight: bold; color: #495057;">
                                â±ï¸ çµŒéæ™‚é–“: <span id="timerDisplay">00:00:00</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            
                            <!-- ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º -->
                            <div id="scenarioDisplay" class="scenario-card" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <h3 id="currentScenarioTitle" style="margin: 0;"></h3>
                                </div>
                                <p id="currentScenarioContent"></p>
                            </div>

                            <!-- è‡ªåŠ›åˆ†æç”»é¢ -->
                            <div id="selfMentalize" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ã‚ãªãŸã®åˆ†æ</h3>
                                </div>
                                <div class="form-group">
                                    <label for="userAnalysis">ç™»å ´äººç‰©ã®æ°—æŒã¡ã‚„è€ƒãˆã‚’åˆ†æã—ã¦ãã ã•ã„</label>
                                    <textarea id="userAnalysis" placeholder="ç™»å ´äººç‰©ã®æ„Ÿæƒ…ã€è€ƒãˆã€å‹•æ©Ÿãªã©ã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„"></textarea>
                                </div>
                                <button id="submitAnalysisBtn" class="btn">åˆ†æã‚’æå‡º</button>
                            </div>

                            <!-- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾è©±ç”»é¢ -->
                            <div id="agentChat" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®å¯¾è©±</h3>
                                </div>
                                <div class="chat-container">
                                    <div class="chat-messages" id="chatMessages"></div>
                                    <div class="chat-input">
                                        <textarea id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...ï¼ˆEnterã§æ”¹è¡Œã€é€ä¿¡ãƒœã‚¿ãƒ³ã§é€ä¿¡ï¼‰" rows="3"></textarea>
                                        <button id="sendMessageBtn">é€ä¿¡</button>
                                    </div>
                                </div>
                                <button id="finishChatBtn" class="btn" style="margin-top: 15px; background: #28a745;">å¯¾è©±ã‚’çµ‚äº†ã™ã‚‹</button>
                            </div>
                            
                            <!-- å®Ÿé¨“å®Œäº†ç”»é¢ -->
                            <div id="experimentComplete" style="display: none; text-align: center;">
                                <h3>ğŸ‰ å®Ÿé¨“å®Œäº†</h3>
                                <p>æœ¬æ—¥ã®å®Ÿé¨“ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã”å‚åŠ ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
                                <button id="completeExperimentBtn" class="btn" style="margin-top: 20px; background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer;">å®Ÿé¨“ã‚’å®Œäº†ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentMode = 'none';
    let isAdminAuthenticated = false;
    let scenarios = [];
    let experimentLogs = [];
    let supabase = null;
    let isSupabaseAvailable = false;
    
    let adminConfig = {
        adminPassword: 'MentalizeAdmin2024!',
        apiProvider: 'openai',
        apiKey: '',
        customApiUrl: '',
        model: 'gpt-3.5-turbo',
        maxTokens: 1000,
        temperature: 0.7,
        sessionTimeout: 60,
        showSessionTimer: true,
        minimumSessionTime: 300, // æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆç§’ï¼‰- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
        systemPrompt: 'ã‚ãªãŸã¯å¿ƒç†å­¦ã®å°‚é–€å®¶ã¨ã—ã¦ã€ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚ºï¼ˆä»–è€…ã®å¿ƒã®ç†è§£ï¼‰ã‚’æ•™ãˆã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚å­¦ç”Ÿã®è€ƒãˆã‚’è‚¯å®šçš„ã«å—ã‘æ­¢ã‚ã€ã‚ˆã‚Šæ·±ã„åˆ†æã‚’ä¿ƒã™è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚æ¸©ã‹ãæ”¯æ´çš„ãªå£èª¿ã§è©±ã—ã¦ãã ã•ã„ã€‚'
    };
    
    let currentScenarioIndex = 0;
    let currentDay = 1;
    let participantId = '';
    let isEditingMode = false;  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’è¿½è·¡
    let editingScenarioIndex = -1;  // ç·¨é›†ä¸­ã®ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ª
    const defaultScenarios = [
        {
            title: "å‹äººåŒå£«ã®ä¼šè©±",
            content: "å¤§å­¦ã®å›³æ›¸é¤¨ã§ã€å¤ªéƒã¨èŠ±å­ãŒæœŸæœ«è©¦é¨“ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã€‚å¤ªéƒï¼šã€Œã‚‚ã†å…¨ç„¶åˆ†ã‹ã‚‰ãªã„ã€‚ã“ã®ã¾ã¾ã˜ã‚ƒçµ¶å¯¾ã«è½ã¡ã‚‹ã€èŠ±å­ï¼šã€Œå¤§ä¸ˆå¤«ã ã‚ˆã€ä¸€ç·’ã«å‹‰å¼·ã—ã‚ˆã†ã€å¤ªéƒï¼šã€Œå›ã¯é ­ã„ã„ã‹ã‚‰ãã†è¨€ãˆã‚‹ã‚“ã ã€å¤ªéƒã¯æœºã«çªã£ä¼ã—ã€èŠ±å­ã¯å›°ã£ãŸè¡¨æƒ…ã‚’æµ®ã‹ã¹ã¦ã„ã‚‹ã€‚",
            promptQuestions: [
                "å¤ªéƒã¯ãªãœä¸å®‰ã«ãªã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                "èŠ±å­ã®æ”¯æ´ã«å¯¾ã—ã¦å¤ªéƒã¯ã©ã†åå¿œã™ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
                "ã“ã®çŠ¶æ³ã§ä¸¡è€…ã®é–¢ä¿‚ã¯ã©ã†å¤‰åŒ–ã™ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
            ],
            hiddenContext: "å¤ªéƒã¯éå»ã«ãƒ†ã‚¹ãƒˆã§å¤±æ•—ã—ãŸçµŒé¨“ãŒã‚ã‚Šã€è‡ªä¿¡ã‚’å¤±ã£ã¦ã„ã‚‹ã€‚èŠ±å­ã¯å¤ªéƒã®æ€§æ ¼ã‚’ç†è§£ã—ã¦ãŠã‚Šã€å„ªã—ãã‚µãƒãƒ¼ãƒˆã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã€‚èŠ±å­ã¯è‡ªåˆ†ã®åŠªåŠ›ã‚’éå°è©•ä¾¡ã—ãŒã¡ã§ã€å¤ªéƒã®ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’ç„¡æ„è­˜ã«åˆºæ¿€ã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã€‚",
            analysisPoints: "ç™»å ´äººç‰©ã®æ„Ÿæƒ…å¤‰åŒ–ã€è‡ªå°Šå¿ƒã¨ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã®ç›¸äº’ä½œç”¨ã€æ”¯æ´ã®æ„å›³ã¨å—ã‘æ‰‹ã®åå¿œã®ã‚ºãƒ¬ã€å‹äººé–¢ä¿‚ã«ãŠã‘ã‚‹ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å›°é›£ã•"
        },
        {
            title: "è·å ´ã§ã®ä¼šè©±", 
            content: "ã‚ªãƒ•ã‚£ã‚¹ã§æ–°å…¥ç¤¾å“¡ã®Aå­ã¨å…ˆè¼©ã®Bç”·ãŒè©±ã—ã¦ã„ã‚‹ã€‚Aå­ï¼šã€Œã™ã¿ã¾ã›ã‚“ã€ã¾ã ç†è§£ã§ãã¦ã„ã¾ã›ã‚“ã€Bç”·ï¼šã€Œã‚‚ã†3å›èª¬æ˜ã—ãŸã‚ˆã­ã€Aå­ã¯ä¸‹ã‚’å‘ãã€Bç”·ã¯å°‘ã—ã‚¤ãƒ©ã‚¤ãƒ©ã—ãŸæ§˜å­ã§è…•ã‚’çµ„ã‚“ã§ã„ã‚‹ã€‚å‘¨ã‚Šã®åŒåƒšãŸã¡ã¯ãã®æ§˜å­ã‚’ã¡ã‚‰ã¡ã‚‰ã¨è¦‹ã¦ã„ã‚‹ã€‚",
            promptQuestions: [
                "Aå­ã¯ãªãœç†è§£ã§ããªã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
                "Bç”·ã®ã‚¤ãƒ©ã‚¤ãƒ©ã®èƒŒæ™¯ã«ã¯ä½•ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
                "å‘¨ã‚Šã®åŒåƒšãŸã¡ã¯ã©ã‚“ãªæ°—æŒã¡ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
            ],
            hiddenContext: "Aå­ã¯æ–°å’ã§ç·Šå¼µã—ã‚„ã™ãã€ç†è§£åŠ›ãŒäººã‚ˆã‚Šã‚‚æ™‚é–“ãŒã‹ã‹ã‚‹ã‚¿ã‚¤ãƒ—ã ãŒã€é ‘å¼µã‚Šå±‹ã§ã‚ã‚‹ã€‚Bç”·ã¯ä¸­å …æ‰‹ã§æ•™ãˆã‚‹ã®ãŒä¸Šæ‰‹ã§ã¯ãªã„ãŒã€ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã€‚å‘¨ã‚Šã®åŒåƒšãŸã¡ã¯ä¸¡è€…ã‚’å¿ƒé…ã—ã¦ã„ã‚‹ãŒã€ä»‹å…¥ã™ã¹ãã‹è¿·ã£ã¦ã„ã‚‹ã€‚",
            analysisPoints: "æ–°äººç‰¹æœ‰ã®ã‚¹ãƒˆãƒ¬ã‚¹ã¨å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã€æŒ‡å°ã™ã‚‹å´ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã¨æ•™è‚²ã‚¹ã‚­ãƒ«ã®ä¸ä¸€è‡´ã€è·å ´ã®é›°å›²æ°—ã¨ç¬¬ä¸‰è€…ã®å¿ƒç†ã€æ¨©åŠ›é–¢ä¿‚ãŒä¸ãˆã‚‹å½±éŸ¿"
        }
    ];
    
    // ã‚µãƒ¼ãƒ™ã‚¤ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨
    let surveys = [];
    let surveyResults = [];


    // SupabaseåˆæœŸåŒ–
    // --- æ–¹æ³•Bï¼šESâ€¯Modules ã‚’ import() ã§èª­ã¿è¾¼ã‚€ç‰ˆ ---
   
//     async function initializeSupabase () {
//       if (globalThis.__supabase) {
//         supabase = globalThis.__supabase;          // ã™ã§ã«ä½œæˆæ¸ˆã¿
//         return loadDataFromSupabase();
//       }
//       try {
//         const mod          = await import('@supabase/supabase-js');
//         // ImportMap ã«ã‚ˆã‚Š URL ãŒè§£æ±ºã•ã‚Œã‚‹
        
//         const createClient =
//               mod.createClient           // é€šå¸¸ã®åå‰ä»˜ã
//            ?? mod.default?.createClient  // default ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
//            ?? mod.default;               // default ãŒé–¢æ•°
//         if (typeof createClient !== 'function') {
//           throw new Error('createClient not found in module');
//         }
        
//         const supabaseUrl  = 'https://ivlmmqsdnmvzermlrger.supabase.co';
//         const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bG1tcXNkbm12emVybWxyZ2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTg3MjMsImV4cCI6MjA2ODczNDcyM30.vAxSpIuxd2qQKGDM358Qlun1q0Tbh3919DLrawCB1M8'; // â˜… anon ã‚­ãƒ¼ã‚’å¿…ãšä½¿ç”¨

//         supabase            = createClient(supabaseUrl, supabaseAnonKey);

        
//         globalThis.__supabase = supabase; 
        
//         isSupabaseAvailable = true;
//         console.log('âœ… Supabase åˆæœŸåŒ–æˆåŠŸ');
// // âœ… admin_configã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–è¨­å®š
// // âœ… å„è¨­å®šã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–è¨­å®š
//         const settingsToWatch = ['admin_config', 'scenarios', 'surveys'];
        
//         settingsToWatch.forEach((settingId) => {
//           supabase
//             .channel(`watch-${settingId}`)
//             .on(
//               'postgres_changes',
//               {
//                 event: '*',
//                 schema: 'public',
//                 table: 'admin_settings',
//                 filter: `id=eq.${settingId}`
//               },
//               async (payload) => {
//                 console.log(`ğŸ”„ ${settingId} ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ`);
//                 await loadDataFromSupabase(); // ã™ã¹ã¦å†å–å¾—ãƒ»å†åæ˜ 
//               }
//             )
//             .subscribe();
//         });



        

    //     await loadDataFromSupabase();
    //   } catch (err) {
    //     console.error('âŒ Supabase åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
    //     loadFromLocalStorage();
    //   }
    // }



    // Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadDataFromSupabase() {
        if (!supabase) {
            loadFromLocalStorage();
            return;
        }
        
        try {
            await loadAdminSettings();
            await loadScenarios();
            await loadExperimentLogs();
            
            loadAdminConfigUI();
            updateScenarioList();
            updateLogsList();
            
            console.log('âœ… Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
        } catch (error) {
            console.error('âŒ Supabaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            loadFromLocalStorage();
        }
    }
    async function initializeSupabase () {
      if (globalThis.__supabase) {
        supabase = globalThis.__supabase;
        return loadDataFromSupabase();
      }
    
      try {
        const mod = await import('@supabase/supabase-js');
    
        const createClient =
              mod.createClient
           ?? mod.default?.createClient
           ?? mod.default;
    
        if (typeof createClient !== 'function') {
          throw new Error('createClient not found in module');
        }
    
        const supabaseUrl = 'https://ivlmmqsdnmvzermlrger.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bG1tcXNkbm12emVybWxyZ2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNTg3MjMsImV4cCI6MjA2ODczNDcyM30.vAxSpIuxd2qQKGDM358Qlun1q0Tbh3919DLrawCB1M8'; // anon key ã‚’ä½¿ç”¨
    
        supabase = createClient(supabaseUrl, supabaseAnonKey);
        globalThis.__supabase = supabase;
        isSupabaseAvailable = true;
    
        console.log('âœ… Supabase åˆæœŸåŒ–æˆåŠŸ');
    
        // ğŸ¯ 3ç¨®é¡ã®è¨­å®šã‚’è³¼èª­
        const settingsToWatch = ['admin_config', 'scenarios', 'surveys'];
    
        settingsToWatch.forEach((settingId) => {
          supabase
            .channel(`watch-${settingId}`)
            .on(
              'postgres_changes',
              {
                event: '*',
                schema: 'public',
                table: 'admin_settings',
                filter: `id=eq.${settingId}`
              },
              async (payload) => {
                console.log(`ğŸ”„ ${settingId} ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ`);
                await loadDataFromSupabase(); // æœ€æ–°çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿
              }
            )
            .subscribe();
        });
    
        await loadDataFromSupabase(); // åˆæœŸèª­ã¿è¾¼ã¿
      } catch (err) {
        console.error('âŒ Supabase åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
        loadFromLocalStorage();
      }
    }

      //ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
    async function loadUserSessionsUI() {
      if (!supabase) {
        console.log('âš ï¸ Supabaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('user_sessions')
          .select('*')
          .order('updated_at', { ascending: false }); // æœ€æ–°æ›´æ–°é †ã«å¤‰æ›´
      
        if (error) {
          console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—å¤±æ•—:', error);
          return;
        }
      
        const tbody = document.getElementById('userSessionsTable')?.querySelector('tbody');
        if (!tbody) {
          console.warn('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        tbody.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢
      
        if (data && data.length > 0) {
          data.forEach(session => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="padding: 8px; border: 1px solid #ddd;">${session.user_id}</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${new Date(session.start_date).toLocaleString()}</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${new Date(session.updated_at).toLocaleString()}</td>
            `;
            tbody.appendChild(row);
          });
          console.log(`âœ… ${data.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="3" style="padding: 20px; text-align: center; color: #6c757d; border: 1px solid #ddd;">ã¾ã ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
          `;
          tbody.appendChild(row);
        }
      } catch (err) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼:', err);
      }
    }

    // ç®¡ç†è€…è¨­å®šã‚’å–å¾—ï¼ˆfetchAdminConfigã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
    async function fetchAdminConfig() {
        return await loadAdminSettings();
    }

    // Supabaseã‹ã‚‰ç®¡ç†è€…è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadAdminSettings() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'admin_config')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
                adminConfig = { ...adminConfig, ...data.settings };
              } else {
                console.log('admin_config è¡ŒãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        } catch (error) {
            console.error('ç®¡ç†è€…è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // Supabaseã«ç®¡ç†è€…è¨­å®šã‚’ä¿å­˜
    async function saveAdminSettings() {
        if (!supabase) {
            localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'admin_config',
                    settings: adminConfig,
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('ç®¡ç†è€…è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            localStorage.setItem('mentalizeAdminConfig', JSON.stringify(adminConfig));
        }
    }

    // Supabaseã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã¿
    async function loadScenarios() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'scenarios')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
     // è¡ŒãŒã‚ã‚‹ â†’ å–å¾—ã—ãŸã‚·ãƒŠãƒªã‚ªã‚’ä½¿ç”¨
              scenarios = data.settings.scenarios;
            } else {
       // è¡ŒãŒç„¡ã„ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒŠãƒªã‚ªã§åˆæœŸåŒ–ã—ã€DB ã«ä¿å­˜
              scenarios = [...defaultScenarios];
              await saveScenarios();   // ã“ã“ã§è¡ŒãŒä½œæˆã•ã‚Œã‚‹
            }
            
        } catch (error) {
            console.error('ã‚·ãƒŠãƒªã‚ªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            scenarios = [...defaultScenarios];
        }
    }

    // Supabaseã«ã‚·ãƒŠãƒªã‚ªã‚’ä¿å­˜
    async function saveScenarios() {
        if (!supabase) {
            localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'scenarios',
                    settings: { scenarios },
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('ã‚·ãƒŠãƒªã‚ªä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            localStorage.setItem('mentalizeScenarios', JSON.stringify(scenarios));
        }
    }

    // Supabaseã‹ã‚‰å®Ÿé¨“ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
    async function loadExperimentLogs() {
        if (!supabase) return;
        
        try {
            const { data, error } = await supabase
                .from('experiment_logs')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            experimentLogs = data || [];
        } catch (error) {
            console.error('å®Ÿé¨“ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // Supabaseã«å®Ÿé¨“ãƒ­ã‚°ã‚’ä¿å­˜
    async function saveExperimentLog(logData) {
        if (!supabase) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const logs = JSON.parse(localStorage.getItem('mentalizeExperimentLogs') || '[]');
            const newLog = {
                id: Date.now(),
                participant_id: logData.participantId,
                day: logData.day,
                experiment_type: logData.experimentType,
                scenario_title: logData.scenarioTitle,
                data: {
                    analysis: logData.analysis,
                    chatHistory: logData.chatHistory,
                    model: adminConfig.model,
                    scenarioIndex: logData.scenarioIndex
                },
                created_at: new Date().toISOString()
            };
            logs.unshift(newLog);
            localStorage.setItem('mentalizeExperimentLogs', JSON.stringify(logs));
            experimentLogs = logs;
            updateLogsList();
            return;
        }
        
        try {
            await supabase
                .from('participants')
                .upsert({
                    id: logData.participantId,
                    last_access: new Date().toISOString()
                });

            const { error } = await supabase
                .from('experiment_logs')
                .insert({
                    participant_id: logData.participantId,
                    day: logData.day,
                    experiment_type: logData.experimentType,
                    scenario_title: logData.scenarioTitle,
                    data: {
                        analysis: logData.analysis,
                        chatHistory: logData.chatHistory,
                        model: adminConfig.model,
                        scenarioIndex: logData.scenarioIndex
                    }
                });
            
            if (error) throw error;
            await loadExperimentLogs();
            updateLogsList();
        } catch (error) {
            console.error('å®Ÿé¨“ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
    function loadFromLocalStorage() {
        // ç®¡ç†è€…è¨­å®š
        const savedConfig = localStorage.getItem('mentalizeAdminConfig');
        if (savedConfig) {
            try {
                adminConfig = { ...adminConfig, ...JSON.parse(savedConfig) };
            } catch (error) {
                console.warn('ç®¡ç†è€…è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚·ãƒŠãƒªã‚ª
        const savedScenarios = localStorage.getItem('mentalizeScenarios');
        if (savedScenarios) {
            try {
                scenarios = JSON.parse(savedScenarios);
            } catch (error) {
                scenarios = [...defaultScenarios];
            }
        } else {
            scenarios = [...defaultScenarios];
        }
        
        // å®Ÿé¨“ãƒ­ã‚°
        const savedLogs = localStorage.getItem('mentalizeExperimentLogs');
        if (savedLogs) {
            try {
                experimentLogs = JSON.parse(savedLogs);
            } catch (error) {
                experimentLogs = [];
            }
        }
        
        // UIã‚’æ›´æ–°
        loadAdminConfigUI();
        updateScenarioList();
        updateLogsList();
    }

    // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
    function selectMode(mode) {
        if (mode === 'admin' && !isAdminAuthenticated) {
            alert('ç®¡ç†è€…èªè¨¼ãŒå¿…è¦ã§ã™');
            return;
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ï¼šä¸€æ™‚ä¸­æ–­æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã€å‚åŠ è€…ãƒ¢ãƒ¼ãƒ‰å¾©å¸°æ™‚ã¯å†é–‹
        if (mode === 'none') {
            pauseSessionTimer(); // ä¸€æ™‚ä¸­æ–­æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        } else if (mode === 'participant' && isPaused) {
            resumeSessionTimer(); // å‚åŠ è€…ãƒ¢ãƒ¼ãƒ‰å¾©å¸°æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
        }
        
        currentMode = mode;
        document.getElementById('modeSelector').style.display = mode === 'none' ? 'block' : 'none';
        document.getElementById('adminNav').classList.toggle('active', mode === 'admin');
        document.getElementById('participantNav').classList.toggle('active', mode === 'participant');


        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });

        if (mode === 'admin') {
            showAdminScreen('adminConfig');
        } else if (mode === 'participant') {
            showParticipantScreen('participantStart');
        }
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showAdminScreen(screenId) {
        document.querySelectorAll('#adminNav .nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    function showParticipantScreen(screenId) {
        document.querySelectorAll('#participantNav .nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    // ç®¡ç†è€…èªè¨¼
    function attemptAdminAccess() {
        const inputPassword = document.getElementById('adminPassword').value;
        const errorDiv = document.getElementById('adminAccessError');
        
        if (!inputPassword) {
            errorDiv.innerHTML = '<div class="status error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
        }
        
        if (inputPassword === adminConfig.adminPassword) {
            isAdminAuthenticated = true;
            errorDiv.innerHTML = '<div class="status success">èªè¨¼æˆåŠŸï¼</div>';
            document.getElementById('adminPassword').value = '';
            setTimeout(() => selectMode('admin'), 1000);
        } else {
            errorDiv.innerHTML = '<div class="status error">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™</div>';
            setTimeout(() => errorDiv.innerHTML = '', 3000);
        }
    }

    function adminLogout() {
        isAdminAuthenticated = false;
        selectMode('none');
    }

    // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    async function changeAdminPassword() {
        const newPassword = document.getElementById('newAdminPassword').value;
        const confirmPassword = document.getElementById('confirmAdminPassword').value;
        
        if (!newPassword || !confirmPassword) {
            alert('ä¸¡æ–¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„');
            return;
        }
        
        adminConfig.adminPassword = newPassword;
        await saveAdminSettings();
        
        document.getElementById('newAdminPassword').value = '';
        document.getElementById('confirmAdminPassword').value = '';
        
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼');
    }

    // ç®¡ç†è€…è¨­å®šä¿å­˜
    async function saveAdminConfig() {
        adminConfig.apiProvider = document.getElementById('apiProvider').value;
        adminConfig.apiKey = document.getElementById('adminApiKey').value;
        adminConfig.customApiUrl = document.getElementById('customApiUrl').value;
        
        // ãƒ¢ãƒ‡ãƒ«é¸æŠã®å‡¦ç†
        const selectedModel = document.getElementById('modelSelect').value;
        if (selectedModel === 'custom-model') {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            adminConfig.model = document.getElementById('customModelName').value || 'custom-model';
            adminConfig.useCustomModel = true;
        } else {
            // æ—¢å®šãƒ¢ãƒ‡ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            adminConfig.model = selectedModel;
            adminConfig.useCustomModel = false;
        }
        
        adminConfig.maxTokens = Number(document.getElementById('maxTokens').value);
        adminConfig.temperature = Number(document.getElementById('temperature').value);
        adminConfig.sessionTimeout = Number(document.getElementById('sessionTimeout').value);
        adminConfig.showSessionTimer = document.getElementById('showTimer').checked;
        await saveAdminSettings();
        
        document.getElementById('configStatus').innerHTML = '<div class="status success">è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼</div>';
        setTimeout(() => document.getElementById('configStatus').innerHTML = '', 3000);
    }

    // ç®¡ç†è€…ãƒ¡ãƒ¢ä¿å­˜
    async function saveMemo() {
        adminConfig.adminMemo = document.getElementById('adminMemo').value;
        await saveAdminSettings();
        alert('ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
    function toggleCustomModelInput() {
        const useCustomModel = document.getElementById('useCustomModel')?.checked;
        const customModelGroup = document.getElementById('customModelGroup');
        
        if (useCustomModel) {
            customModelGroup.style.display = 'block';
        } else {
            customModelGroup.style.display = 'none';
        }
    }

    // ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼æ©Ÿèƒ½ï¼ˆã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§ä½¿ç”¨å¯èƒ½ï¼‰
    async function validateModel() {
        const modelSelect = document.getElementById('modelSelect');
        const customModelNameInput = document.getElementById('customModelName');
        const resultDiv = document.getElementById('modelValidationResult');
        
        let modelName;
        if (modelSelect.value === 'custom-model') {
            modelName = customModelNameInput.value.trim();
            if (!modelName) {
                resultDiv.innerHTML = '<span style="color: #dc3545;">âš ï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
                return;
            }
        } else {
            modelName = modelSelect.value;
        }
        
        resultDiv.innerHTML = '<span style="color: #6c757d;">ğŸ”„ æ¤œè¨¼ä¸­...</span>';
        
        try {
            const testMessage = 'ã“ã‚“ã«ã¡ã¯';
            let apiUrl, headers, requestBody;
            
            // APIè¨­å®šã‚’å–å¾—
            if (adminConfig.apiProvider === 'openai') {
                apiUrl = 'https://api.openai.com/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminConfig.apiKey}`
                };
                requestBody = {
                    model: modelName,
                    messages: [{ role: 'user', content: testMessage }],
                    ...(modelName && modelName.startsWith('gpt-5') ? { max_completion_tokens: 10 } : { max_tokens: 10 })
                };
            } else if (adminConfig.apiProvider === 'claude') {
                apiUrl = 'https://api.anthropic.com/v1/messages';
                headers = {
                    'Content-Type': 'application/json',
                    'x-api-key': adminConfig.apiKey,
                    'anthropic-version': '2023-06-01'
                };
                requestBody = {
                    model: modelName,
                    max_tokens: 10,
                    messages: [{ role: 'user', content: testMessage }]
                };
            } else if (adminConfig.apiProvider === 'gemini') {
                // Google Gemini APIã®æ¤œè¨¼
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${adminConfig.apiKey}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                requestBody = {
                    contents: [{
                        parts: [{ text: testMessage }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 10
                    }
                };
            } else {
                resultDiv.innerHTML = '<span style="color: #dc3545;">âš ï¸ ã‚«ã‚¹ã‚¿ãƒ APIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã¯ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
                return;
            }
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers,
                body: JSON.stringify(requestBody)
            });
            
            if (response.ok) {
                resultDiv.innerHTML = '<span style="color: #28a745;">âœ… ãƒ¢ãƒ‡ãƒ«ãŒæœ‰åŠ¹ã§ã™</span>';
            } else {
                const errorData = await response.json();
                let errorMsg = 'ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç„¡åŠ¹ã§ã™';
                if (errorData.error?.message) {
                    errorMsg += `: ${errorData.error.message}`;
                }
                resultDiv.innerHTML = `<span style="color: #dc3545;">âŒ ${errorMsg}</span>`;
            }
        } catch (error) {
            console.error('Model validation error:', error);
            resultDiv.innerHTML = '<span style="color: #dc3545;">âŒ æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>';
        }
    }


    //ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã€ä¿å­˜
    async function loadSurveyConfig() {
      const { data, error } = await supabase
        .from('admin_settings')
        .select('settings')
        .eq('id', 'surveys')
        .single();
  
      if (error) {
          console.error('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          return;
      }
  
      document.getElementById('surveyJsonEditor').value = JSON.stringify(data.settings, null, 2);
    }

    async function saveSurveyConfig() {
        const newSettings = document.getElementById('surveyJsonEditor').value;
        try {
            const parsed = JSON.parse(newSettings);
            const { error } = await supabase
                .from('admin_settings')
                .upsert({ id: 'surveys', settings: parsed });
    
            if (error) throw error;
    
            alert('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        } catch (e) {
            alert('JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: ' + e.message);
        }
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šä¿å­˜
    async function savePromptConfig() {
        adminConfig.systemPrompt = document.getElementById('systemPrompt').value;
        await saveAdminSettings();
        alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
    }

    async function saveSessionConfig() {
        const minimumTimeMinutes = parseInt(document.getElementById('minimumSessionTime').value);
        adminConfig.minimumSessionTime = minimumTimeMinutes * 60; // åˆ†ã‚’ç§’ã«å¤‰æ›
        await saveAdminSettings();
        alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
    }

    // æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ãŒçµŒéã—ãŸã‹ãƒã‚§ãƒƒã‚¯
    function hasMinimumTimeElapsed() {
        if (!adminConfig.minimumSessionTime) {
            return true; // æœ€ä½æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¨±å¯
        }
        
        let totalElapsed = accumulatedTime; // è“„ç©ã•ã‚ŒãŸæ™‚é–“
        if (sessionStartTime && !isPaused) {
            totalElapsed += new Date() - sessionStartTime; // ç¾åœ¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ™‚é–“
        }
        
        const elapsedSeconds = totalElapsed / 1000; // çµŒéæ™‚é–“ã‚’ç§’ã§è¨ˆç®—
        return elapsedSeconds >= adminConfig.minimumSessionTime;
    }

    // æ®‹ã‚Šæ™‚é–“ã‚’å–å¾—ï¼ˆç§’ï¼‰
    function getRemainingTime() {
        if (!adminConfig.minimumSessionTime) {
            return 0;
        }
        
        let totalElapsed = accumulatedTime; // è“„ç©ã•ã‚ŒãŸæ™‚é–“
        if (sessionStartTime && !isPaused) {
            totalElapsed += new Date() - sessionStartTime; // ç¾åœ¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ™‚é–“
        }
        
        const elapsedSeconds = totalElapsed / 1000;
        const remaining = adminConfig.minimumSessionTime - elapsedSeconds;
        return Math.max(0, Math.ceil(remaining));
    }

    // ç®¡ç†è€…è¨­å®šUIã«èª­ã¿è¾¼ã¿
    function loadAdminConfigUI() {
        const apiProviderSelect = document.getElementById('apiProvider');
        if (apiProviderSelect) {
            apiProviderSelect.value = adminConfig.apiProvider || 'openai';
            updateApiProviderUI();
        }

        const apiKeyInput = document.getElementById('adminApiKey');
        if (apiKeyInput) apiKeyInput.value = adminConfig.apiKey || '';
        
        const customUrlInput = document.getElementById('customApiUrl');
        if (customUrlInput) customUrlInput.value = adminConfig.customApiUrl || '';

        const modelSelect = document.getElementById('modelSelect');
        const customModelNameInput = document.getElementById('customModelName');
        
        if (modelSelect) {
            updateModelOptions();
            
            // ãƒ¢ãƒ‡ãƒ«é¸æŠã®è¨­å®š
            if (adminConfig.useCustomModel && adminConfig.model) {
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                modelSelect.value = 'custom-model';
                if (customModelNameInput) customModelNameInput.value = adminConfig.model;
            } else {
                // æ—¢å®šãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                modelSelect.value = adminConfig.model || 'gpt-3.5-turbo';
            }
            updateCustomModelVisibility();
        }

        const maxTokensInput = document.getElementById('maxTokens');
        if (maxTokensInput) maxTokensInput.value = adminConfig.maxTokens ?? 300;

        const tempInput = document.getElementById('temperature');
        if (tempInput) tempInput.value = adminConfig.temperature ?? 0.7;

        const timeoutInput = document.getElementById('sessionTimeout');
        if (timeoutInput) timeoutInput.value = adminConfig.sessionTimeout ?? 30;

        const showTimerCheckbox = document.getElementById('showTimer');
        if (showTimerCheckbox) showTimerCheckbox.checked = adminConfig.showSessionTimer ?? true;
        
        const systemPromptInput = document.getElementById('systemPrompt');
        if (systemPromptInput) systemPromptInput.value = adminConfig.systemPrompt || '';

        const minimumSessionTimeInput = document.getElementById('minimumSessionTime');
        if (minimumSessionTimeInput) minimumSessionTimeInput.value = Math.floor((adminConfig.minimumSessionTime || 300) / 60); // ç§’ã‚’åˆ†ã«å¤‰æ›
        
        const adminMemoInput = document.getElementById('adminMemo');
        if (adminMemoInput) adminMemoInput.value = adminConfig.adminMemo || '';
    }
    
    // APIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼UIã®æ›´æ–°
    function updateApiProviderUI() {
        const provider = document.getElementById('apiProvider')?.value;
        const customUrlGroup = document.getElementById('customUrlGroup');
        
        if (customUrlGroup) {
            customUrlGroup.style.display = provider === 'custom' ? 'block' : 'none';
        }
        
        updateModelOptions();
    }
    
    // ãƒ¢ãƒ‡ãƒ«é¸æŠè‚¢ã®æ›´æ–°
    function updateModelOptions() {
        const provider = document.getElementById('apiProvider')?.value;
        const modelSelect = document.getElementById('modelSelect');
        
        if (modelSelect) {
            modelSelect.innerHTML = '';
            
            if (provider === 'openai') {
                const openaiModels = [
                    { value: 'gpt-5', text: 'GPT-5' },
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' },
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4o', text: 'GPT-4o' },
                    { value: 'gpt-4o-mini', text: 'GPT-4o Mini' },
                    { value: 'gpt-4-turbo-preview', text: 'GPT-4 Turbo Preview' },
                    { value: 'custom-model', text: 'ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«' }
                ];
                openaiModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            } else if (provider === 'claude') {
                const claudeModels = [
                    { value: 'claude-3-5-sonnet-20241022', text: 'Claude 3.5 Sonnet' },
                    { value: 'claude-3-sonnet-20240229', text: 'Claude 3 Sonnet' },
                    { value: 'claude-3-opus-20240229', text: 'Claude 3 Opus' },
                    { value: 'claude-3-haiku-20240307', text: 'Claude 3 Haiku' },
                    { value: 'claude-4-sonnet', text: 'Claude 4 Sonnet' },
                    { value: 'custom-model', text: 'ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«' }
                ];
                claudeModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            } else if (provider === 'gemini') {
                const geminiModels = [
                    { value: 'gemini-1.5-pro', text: 'Gemini 1.5 Pro' },
                    { value: 'gemini-1.5-flash', text: 'Gemini 1.5 Flash' },
                    { value: 'gemini-1.0-pro', text: 'Gemini 1.0 Pro' },
                    { value: 'gemini-pro-vision', text: 'Gemini Pro Vision' },
                    { value: 'gemini-2.0-flash-exp', text: 'Gemini 2.0 Flash (Experimental)' },
                    { value: 'custom-model', text: 'ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«' }
                ];
                geminiModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            } else {
                // ã‚«ã‚¹ã‚¿ãƒ ã®å ´åˆã¯åŸºæœ¬ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¤º
                const basicModels = [
                    { value: 'custom-model', text: 'ğŸ”§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«' }
                ];
                basicModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¡¨ç¤ºåˆ¶å¾¡
            updateCustomModelVisibility();
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’é¸æŠ
            if (adminConfig.model) {
                modelSelect.value = adminConfig.model;
            }
        }
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
    function updateCustomModelVisibility() {
        const modelSelect = document.getElementById('modelSelect');
        const customModelGroup = document.getElementById('customModelGroup');
        
        if (modelSelect && customModelGroup) {
            const isCustomSelected = modelSelect.value === 'custom-model';
            customModelGroup.style.display = isCustomSelected ? 'block' : 'none';
        }
    }

    async function addSurvey() {
        const day = Number(document.getElementById('surveyDay').value);
        const position = document.querySelector('input[name="surveyPosition"]:checked').value;
        const questions = collectQuestionInputs();  // è¤‡æ•°è³ªå•ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«æ•´å½¢
        surveys.push({ day, position, questions });
        await saveSurveys();  // admin_settingsã«ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆ
        updateSurveyList();
       
    }

    // ã‚·ãƒŠãƒªã‚ªç®¡ç†
    async function addScenario() {
        const title = document.getElementById('scenarioTitle').value;
        const content = document.getElementById('scenarioContent').value;
        const promptQuestionsText = document.getElementById('scenarioPromptQuestions').value;
        const hiddenContext = document.getElementById('scenarioHiddenContext').value;
        const analysisPoints = document.getElementById('scenarioAnalysisPoints').value;

        if (!title || !content) {
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        
        const promptQuestions = promptQuestionsText ? promptQuestionsText.split('\n').filter(q => q.trim()) : [];
        const scenario = {
            title,
            content,
            promptQuestions,
            hiddenContext: hiddenContext || '',
            analysisPoints: analysisPoints || ''
        };
        
        if (editingScenarioIndex >= 0) {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
            scenarios[editingScenarioIndex] = scenario;
            alert('ã‚·ãƒŠãƒªã‚ªãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
        } else {
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
            scenarios.push(scenario);
            alert('ã‚·ãƒŠãƒªã‚ªãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
        }
        
        await saveScenarios();
        updateScenarioList();
        clearScenarioForm();
    }
    
    function editScenario(index) {
        const scenario = scenarios[index];
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
        document.getElementById('scenarioTitle').value = scenario.title;
        document.getElementById('scenarioContent').value = scenario.content;
        document.getElementById('scenarioPromptQuestions').value = scenario.promptQuestions.join('\n');
        document.getElementById('scenarioHiddenContext').value = scenario.hiddenContext || '';
        document.getElementById('scenarioAnalysisPoints').value = scenario.analysisPoints || '';
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        editingScenarioIndex = index;
        document.getElementById('addScenarioBtn').textContent = 'ã‚·ãƒŠãƒªã‚ªã‚’æ›´æ–°';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¿½åŠ 
        const formContainer = document.getElementById('addScenarioBtn').closest('.admin-config');
        formContainer.classList.add('editing-mode');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ä½ç½®ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        document.getElementById('scenarioTitle').scrollIntoView({ behavior: 'smooth' });
    }
    
    function cancelScenarioEdit() {
        clearScenarioForm();
        editingScenarioIndex = -1;
        document.getElementById('addScenarioBtn').textContent = 'ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ ';
        document.getElementById('cancelEditBtn').style.display = 'none';
    }
    
    function clearScenarioForm() {
        document.getElementById('scenarioTitle').value = '';
        document.getElementById('scenarioContent').value = '';
        document.getElementById('scenarioPromptQuestions').value = '';
        document.getElementById('scenarioHiddenContext').value = '';
        document.getElementById('scenarioAnalysisPoints').value = '';
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        editingScenarioIndex = -1;
        document.getElementById('addScenarioBtn').textContent = 'ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ ';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å‰Šé™¤
        const formContainer = document.getElementById('addScenarioBtn').closest('.admin-config');
        formContainer.classList.remove('editing-mode');
    }

    function updateScenarioList() {
        const list = document.getElementById('scenarioList');
        if (!list) return;
        
        list.innerHTML = '';
        
        if (scenarios.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">ã‚·ãƒŠãƒªã‚ªãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        scenarios.forEach((scenario, index) => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            // éš ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚„åˆ†æãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤º
            let additionalInfo = '';
            if (scenario.hiddenContext && scenario.hiddenContext.trim()) {
                additionalInfo += `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;"><strong>éš ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:</strong> ${scenario.hiddenContext.slice(0, 100)}${scenario.hiddenContext.length > 100 ? '...' : ''}</div>`;
            }
            if (scenario.analysisPoints && scenario.analysisPoints.trim()) {
                additionalInfo += `<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;"><strong>åˆ†æãƒã‚¤ãƒ³ãƒˆ:</strong> ${scenario.analysisPoints.slice(0, 100)}${scenario.analysisPoints.length > 100 ? '...' : ''}</div>`;
            }
            
            item.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #495057;">${scenario.title}</h4>
                <p style="margin-bottom: 15px; color: #6c757d; line-height: 1.5;">${scenario.content.slice(0, 200)}${scenario.content.length > 200 ? '...' : ''}</p>
                ${additionalInfo}
                <button class="btn editBtn" data-index="${index}" style="background: #007bff; font-size: 14px; padding: 8px 16px; margin-right: 10px;">ç·¨é›†</button>
                <button class="btn deleteBtn" data-index="${index}"  style="background: #dc3545; font-size: 14px; padding: 8px 16px;">å‰Šé™¤</button>
            `;
            list.appendChild(item);
        });
        list.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', e => {
            editScenario(Number(e.currentTarget.dataset.index));
          });
        });
        
        list.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', e => {
            deleteScenario(Number(e.currentTarget.dataset.index));
          });
        });
    }

    async function deleteScenario(index) {
        if (!confirm('ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        scenarios.splice(index, 1);
        await saveScenarios();
        updateScenarioList();
        alert('ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
    
    // å‰²ã‚Šå½“ã¦çŠ¶æ³è¡¨ç¤º
    function updateAssignmentsList() {
        const assignmentsList = document.getElementById('assignmentsList');
        if (!assignmentsList) return;
        
        // å®Ÿé¨“ãƒ­ã‚°ã‹ã‚‰å‚åŠ è€…ã¨ã‚·ãƒŠãƒªã‚ªä½¿ç”¨çŠ¶æ³ã‚’åˆ†æ
        const participantAssignments = {};
        
        experimentLogs.forEach(log => {
            if (!participantAssignments[log.participant_id]) {
                participantAssignments[log.participant_id] = {
                    participantId: log.participant_id,
                    days: {}
                };
            }
            
            participantAssignments[log.participant_id].days[log.day] = {
                scenario: log.scenario_title || 'ä¸æ˜',
                scenarioIndex: log.scenario_index,
                timestamp: log.timestamp,
                completed: log.session_end !== null
            };
        });
        
        if (Object.keys(participantAssignments).length === 0) {
            assignmentsList.innerHTML = '<p style="color: #6c757d; text-align: center;">ã¾ã å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
        html += '<thead><tr style="background: #f8f9fa;">';
        html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å‚åŠ è€…ID</th>';
        
        for (let day = 1; day <= 7; day++) {
            html += `<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;">${day}æ—¥ç›®</th>`;
        }
        
        html += '</tr></thead><tbody>';
        
        Object.keys(participantAssignments).sort().forEach(participantId => {
            const participant = participantAssignments[participantId];
            html += `<tr><td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">${participantId}</td>`;
            
            for (let day = 1; day <= 7; day++) {
                const dayData = participant.days[day];
                let cellContent = '<span style="color: #6c757d;">æœªå®Ÿæ–½</span>';
                let cellStyle = 'padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 12px;';
                
                if (dayData) {
                    const scenarioName = dayData.scenario.length > 15 ? 
                        dayData.scenario.substring(0, 15) + '...' : 
                        dayData.scenario;
                    
                    if (dayData.completed) {
                        cellContent = `<div style="color: #28a745;">âœ“ ${scenarioName}</div>`;
                        cellContent += `<small style="color: #6c757d;">${new Date(dayData.timestamp).toLocaleDateString()}</small>`;
                        cellStyle += ' background: #d4edda;';
                    } else {
                        cellContent = `<div style="color: #ffc107;">â³ ${scenarioName}</div>`;
                        cellContent += `<small style="color: #6c757d;">å®Ÿæ–½ä¸­</small>`;
                        cellStyle += ' background: #fff3cd;';
                    }
                }
                
                html += `<td style="${cellStyle}">${cellContent}</td>`;
            }
            
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        
        // çµ±è¨ˆæƒ…å ±ã‚’è¿½åŠ 
        const totalParticipants = Object.keys(participantAssignments).length;
        let totalSessions = 0;
        let completedSessions = 0;
        
        Object.values(participantAssignments).forEach(participant => {
            Object.values(participant.days).forEach(day => {
                totalSessions++;
                if (day.completed) completedSessions++;
            });
        });
        
        html += '<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">';
        html += '<h4 style="margin: 0 0 10px 0;">çµ±è¨ˆæƒ…å ±</h4>';
        html += `<p style="margin: 5px 0;">å‚åŠ è€…æ•°: <strong>${totalParticipants}å</strong></p>`;
        html += `<p style="margin: 5px 0;">ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: <strong>${totalSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³</strong></p>`;
        html += `<p style="margin: 5px 0;">å®Œäº†ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: <strong>${completedSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³</strong> (${totalSessions > 0 ? Math.round((completedSessions / totalSessions) * 100) : 0}%)</p>`;
        html += '</div>';
        
        assignmentsList.innerHTML = html;
    }

    // ãƒ­ã‚°ç®¡ç†
    async function updateLogsList() {
        await updateParticipantFilter();
        displayFilteredLogs();
    }

    async function updateParticipantFilter() {
        const filterSelect = document.getElementById('filterParticipant');
        const deleteSelect = document.getElementById('deleteParticipantId');
        
        // è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å‚åŠ è€…IDã‚’åé›†
        const participantSources = [];
        
        // å®Ÿé¨“ãƒ­ã‚°ã‹ã‚‰å‚åŠ è€…IDã‚’å–å¾—
        if (experimentLogs && experimentLogs.length > 0) {
            participantSources.push(...experimentLogs.map(log => log.participant_id));
        }
        
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‹ã‚‰å‚åŠ è€…IDã‚’å–å¾—
        if (surveyResults && surveyResults.length > 0) {
            participantSources.push(...surveyResults.map(result => result.participant_id));
        }
        
        // Supabaseã‹ã‚‰å…¨å‚åŠ è€…ã‚’å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿãªæ–¹æ³•ï¼‰
        if (supabase) {
            try {
                const { data: participantsData, error } = await supabase
                    .from('participants')
                    .select('id');
                    
                if (!error && participantsData) {
                    participantSources.push(...participantsData.map(p => p.id));
                }
            } catch (error) {
                console.warn('å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿å–å¾—è­¦å‘Š:', error);
            }
        }
        
        // é‡è¤‡ã‚’é™¤å»ã—ã¦ã‚½ãƒ¼ãƒˆ
        const participants = [...new Set(participantSources)].filter(Boolean).sort();
        
        // ãƒ‡ãƒ¼ã‚¿é–²è¦§ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filterSelect) {
            filterSelect.innerHTML = '<option value="">å…¨ã¦ã®å‚åŠ è€…</option>';
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                filterSelect.appendChild(option);
            });
        }
        
        // å‰Šé™¤ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
        if (deleteSelect) {
            deleteSelect.innerHTML = '<option value="">å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                deleteSelect.appendChild(option);
            });
        }
    }

    function displayFilteredLogs() {
        const list = document.getElementById('experimentLogsList');
        if (!list) return;
        
        const participantFilter = document.getElementById('filterParticipant')?.value || '';
        const dayFilter = document.getElementById('filterDay')?.value || '';
        
        let filteredLogs = experimentLogs.filter(log => {
            return (!participantFilter || log.participant_id === participantFilter) &&
                   (!dayFilter || log.day?.toString() === dayFilter);
        });
        
        list.innerHTML = '';
        
        if (filteredLogs.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        filteredLogs.forEach(log => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const date = new Date(log.created_at).toLocaleString('ja-JP');
            const typeLabels = {
                'self_analysis': 'è‡ªåŠ›åˆ†æ',
                'agent_assisted': 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´'
            };
            
            let content = '';
            if (log.experiment_type === 'self_analysis') {
                content = `<div><strong>åˆ†æå†…å®¹:</strong><br>${log.data?.analysis || ''}</div>`;
            } else if (log.experiment_type === 'agent_assisted') {
                const chatHistory = log.data?.chatHistory || [];
                content = `<div><strong>ä¼šè©±å±¥æ­´:</strong><br>${chatHistory.map(msg => `${msg.sender}: ${msg.content}`).join('<br>')}</div>`;
            }
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <span style="font-weight: 600;">å‚åŠ è€…: ${log.participant_id}</span>
                        <span style="margin-left: 10px; background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${typeLabels[log.experiment_type]}</span>
                        ${log.day ? `<span style="margin-left: 10px; color: #6c757d;">Day ${log.day}</span>` : ''}
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">${date}</div>
                </div>
                ${log.scenario_title ? `<div style="margin-bottom: 10px;"><strong>ã‚·ãƒŠãƒªã‚ª:</strong> ${log.scenario_title}</div>` : ''}
                ${content}
            `;
            list.appendChild(item);
        });
    }

    function exportData() {
        if (experimentLogs.length === 0) {
            alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        let csv = 'ID,å‚åŠ è€…ID,å®Ÿé¨“æ—¥,å®Ÿé¨“ã‚¿ã‚¤ãƒ—,ã‚·ãƒŠãƒªã‚ª,ãƒ‡ãƒ¼ã‚¿,ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—\n';
        
        experimentLogs.forEach(log => {
            let data = '';
            if (log.experiment_type === 'self_analysis') {
                data = log.data?.analysis?.replace(/"/g, '""') || '';
            } else if (log.experiment_type === 'agent_assisted') {
                data = log.data?.chatHistory?.map(msg => `${msg.sender}: ${msg.content}`).join(' | ') || '';
            }
            
            csv += `"${log.id}","${log.participant_id}","${log.day || ''}","${log.experiment_type}","${log.scenario_title || ''}","${data}","${log.created_at}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `mentalize_experiment_data_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    // å‚åŠ è€…ã®éå»ã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    async function checkPreviousLogs(participantId, selectedDay) {
        const participantLogs = experimentLogs.filter(log => 
            log.participant_id === participantId
        );
        
        if (participantLogs.length > 0) {
            // åŒã˜æ—¥ã®ãƒ­ã‚°ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const sameDayLogs = participantLogs.filter(log => log.day === selectedDay);
            const otherDayLogs = participantLogs.filter(log => log.day !== selectedDay);
            
            let messageText = `å‚åŠ è€…IDã€Œ${participantId}ã€ã®éå»ã®å®Ÿé¨“è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n`;
            
            if (sameDayLogs.length > 0) {
                messageText += `âš ï¸ ${selectedDay}æ—¥ç›®ã«æ—¢ã«å›ç­”æ¸ˆã¿ã§ã™ï¼\n`;
            }
            
            if (otherDayLogs.length > 0) {
                const previousDays = [...new Set(otherDayLogs.map(log => log.day))].sort();
                const daysList = previousDays.map(day => `${day}æ—¥ç›®`).join('ã€');
                messageText += `ãã®ä»–ã®å‚åŠ æ—¥: ${daysList}\n`;
            }
            
            // 3ãƒœã‚¿ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const choice = await showLogCheckModal(messageText, participantLogs);
            
            if (choice === 'viewLogs') {
                showPreviousLogsModal(participantLogs);
                return false; // å®Ÿé¨“é–‹å§‹ã‚’ä¸­æ–­
            } else if (choice === 'goBack') {
                return false; // å®Ÿé¨“é–‹å§‹ã‚’ä¸­æ–­ã—ã¦æ—¥ä»˜é¸æŠã«æˆ»ã‚‹
            }
            // choice === 'startWithoutViewing' ã®å ´åˆã¯å®Ÿé¨“ã‚’ç¶šè¡Œ
        }
        return true; // å®Ÿé¨“é–‹å§‹ã‚’ç¶šè¡Œ
    }
    
    // 3ãƒœã‚¿ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showLogCheckModal(messageText, logs) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.id = 'logCheckModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.7); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 10px; 
                max-width: 500px; text-align: center;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            const messageFormatted = messageText.replace(/\n/g, '<br>');
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #495057; margin-bottom: 15px;">ğŸ” éå»ã®å®Ÿé¨“è¨˜éŒ²</h3>
                    <p style="color: #6c757d; line-height: 1.5;">${messageFormatted}</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="startWithoutViewingBtn" class="btn" style="background: #28a745; color: white; padding: 12px 20px; font-size: 16px;">
                        ğŸš€ è¦‹ãšã«å®Ÿé¨“ã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                    <button id="viewLogsBtn" class="btn" style="background: #007bff; color: white; padding: 12px 20px; font-size: 16px;">
                        ğŸ“‹ ä¼šè©±ãƒ­ã‚°ã‚’è¦‹ã‚‹
                    </button>
                    <button id="goBackBtn" class="btn" style="background: #6c757d; color: white; padding: 12px 20px; font-size: 16px;">
                        â† å‰ã®ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            `;
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const startWithoutViewingBtn = content.querySelector('#startWithoutViewingBtn');
            const viewLogsBtn = content.querySelector('#viewLogsBtn');
            const goBackBtn = content.querySelector('#goBackBtn');
            
            startWithoutViewingBtn.onclick = () => {
                document.body.removeChild(modal);
                resolve('startWithoutViewing');
            };
            
            viewLogsBtn.onclick = () => {
                document.body.removeChild(modal);
                resolve('viewLogs');
            };
            
            goBackBtn.onclick = () => {
                document.body.removeChild(modal);
                resolve('goBack');
            };
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        });
    }
    
    // éå»ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showPreviousLogsModal(logs) {
        const modal = document.createElement('div');
        modal.id = 'previousLogsModal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 1000; display: flex; 
            align-items: center; justify-content: center;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white; padding: 20px; border-radius: 10px; 
            max-width: 80%; max-height: 80%; overflow-y: auto;
            min-width: 600px;
        `;
        
        let logsHtml = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>éå»ã®å®Ÿé¨“ãƒ­ã‚°ï¼ˆå‚åŠ è€…: ${participantId}ï¼‰</h3>
                <button onclick="closePreviousLogsModal()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">âœ• é–‰ã˜ã‚‹</button>
            </div>
        `;
        
        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
        logs.sort((a, b) => a.day - b.day);
        
        logs.forEach(log => {
            const date = new Date(log.created_at).toLocaleString('ja-JP');
            logsHtml += `
                <div style="border: 1px solid #e9ecef; margin-bottom: 15px; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong style="color: #495057;">${log.day}æ—¥ç›® - ${log.experiment_type === 'self_analysis' ? 'è‡ªåŠ›ãƒ¡ãƒ³ã‚¿ãƒ©ã‚¤ã‚º' : 'ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ”¯æ´'}</strong>
                        <span style="color: #6c757d; font-size: 14px;">${date}</span>
                    </div>
                    <div style="margin-bottom: 10px;"><strong>ã‚·ãƒŠãƒªã‚ª:</strong> ${log.scenario_title}</div>
            `;
            
            if (log.data && log.data.chatHistory && log.data.chatHistory.length > 0) {
                logsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>ä¼šè©±ãƒ­ã‚°:</strong>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px; max-height: 200px; overflow-y: auto;">
                `;
                log.data.chatHistory.forEach(msg => {
                    const isUser = msg.role === 'user';
                    logsHtml += `
                        <div style="margin-bottom: 8px;">
                            <strong style="color: ${isUser ? '#007bff' : '#28a745'};">${isUser ? 'å‚åŠ è€…' : 'AI'}:</strong>
                            <span style="margin-left: 8px;">${msg.content}</span>
                        </div>
                    `;
                });
                logsHtml += '</div></div>';
            }
            
            if (log.data && log.data.analysis) {
                logsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>åˆ†æçµæœ:</strong>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">${log.data.analysis}</div>
                    </div>
                `;
            }
            
            logsHtml += '</div>';
        });
        
        logsHtml += `
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closePreviousLogsModal()" class="btn" style="margin-right: 10px; background: #6c757d;">å‰ã®ç”»é¢ã«æˆ»ã‚‹</button>
                <button onclick="closePreviousLogsModal(); proceedWithExperiment();" class="btn" style="background: #28a745; margin-right: 10px;">å®Ÿé¨“ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <div style="margin-top: 10px;">
                    <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">â†‘ ä¼šè©±ãƒ­ã‚°ã¯ä¸Šè¨˜ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™</p>
                </div>
            </div>
        `;
        
        content.innerHTML = logsHtml;
        modal.appendChild(content);
        document.body.appendChild(modal);
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    window.closePreviousLogsModal = function() {
        const modal = document.getElementById('previousLogsModal');
        if (modal) {
            document.body.removeChild(modal);
        }
    };

    // ã‚·ãƒŠãƒªã‚ªãƒ©ãƒ³ãƒ€ãƒ åŒ–æ©Ÿèƒ½ï¼ˆå‚åŠ è€…IDãƒ™ãƒ¼ã‚¹ã§æ±ºå®šçš„ï¼‰
    function hashString(str) {
        let hash = 0;
        if (str.length === 0) return hash;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
        }
        return Math.abs(hash);
    }

    function shuffleArrayDeterministic(array, seed) {
        const result = [...array];
        let currentIndex = result.length;
        let temporaryValue, randomIndex;

        // seedã‚’åŸºã«ã—ãŸç–‘ä¼¼ä¹±æ•°ç”Ÿæˆå™¨
        function seededRandom() {
            seed = (seed * 9301 + 49297) % 233280;
            return seed / 233280;
        }

        while (0 !== currentIndex) {
            randomIndex = Math.floor(seededRandom() * currentIndex);
            currentIndex -= 1;

            temporaryValue = result[currentIndex];
            result[currentIndex] = result[randomIndex];
            result[randomIndex] = temporaryValue;
        }

        return result;
    }

    function getDeterministicScenarioIndex(participantId, dayNumber) {
        if (scenarios.length === 0) return 0;
        
        // å‚åŠ è€…IDã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚·ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        const seed = hashString(participantId);
        
        // ã‚·ãƒŠãƒªã‚ªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é…åˆ—ã‚’ä½œæˆ
        const scenarioIndices = Array.from({length: scenarios.length}, (_, i) => i);
        
        // æ±ºå®šçš„ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        const shuffledIndices = shuffleArrayDeterministic(scenarioIndices, seed);
        
        // 7æ—¥é–“ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«é¸æŠ
        if (scenarios.length >= 7) {
            // 7å€‹ä»¥ä¸Šã®ã‚·ãƒŠãƒªã‚ªãŒã‚ã‚‹å ´åˆã¯ã€æœ€åˆã®7å€‹ã‚’ä½¿ç”¨
            return shuffledIndices[(dayNumber - 1) % 7];
        } else {
            // 7å€‹æœªæº€ã®å ´åˆã¯ã€åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŠãƒªã‚ªã‹ã‚‰å¾ªç’°çš„ã«é¸æŠ
            return shuffledIndices[(dayNumber - 1) % scenarios.length];
        }
    }

    // å®Ÿé¨“æ©Ÿèƒ½
    window.startExperiment = async function startExperiment() {
        participantId = document.getElementById('participantId').value;
        currentDay = parseInt(document.getElementById('experimentDay').value);
        
        if (!participantId) {
            alert('å‚åŠ è€…IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (scenarios.length === 0) {
            alert('ã‚·ãƒŠãƒªã‚ªãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }
        
        // éå»ã®ãƒ­ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        const shouldContinue = await checkPreviousLogs(participantId, currentDay);
        if (!shouldContinue) {
            return; // éå»ãƒ­ã‚°è¡¨ç¤ºä¸­ãªã®ã§å®Ÿé¨“é–‹å§‹ã‚’ä¸­æ–­
        }
        
        // éå»ãƒ­ã‚°ãƒã‚§ãƒƒã‚¯å¾Œã®å®Ÿé¨“é–‹å§‹å‡¦ç†
        await proceedWithExperiment();
    }
    
    // éå»ãƒ­ã‚°ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã‚ãšã«å®Ÿé¨“ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    window.proceedWithExperiment = async function proceedWithExperiment() {
        // å®Ÿé¨“é–‹å§‹æ™‚ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        const startSurvey = surveys.find(s => s.day === currentDay && s.timing === 'start');
        if (startSurvey) {
            await showSurvey(startSurvey, 'start');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–/æ›´æ–°
        await initializeUserSession(participantId);

        document.getElementById('participantSetup').style.display = 'none';
        document.getElementById('experimentContent').style.display = 'block';
        
        // å®Ÿé¨“åˆ¶å¾¡ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('experimentControls').style.display = 'block';
        document.getElementById('pauseExperimentBtn').style.display = 'inline-block';
        document.getElementById('quitExperimentBtn').style.display = 'inline-block';
        
        // å®Ÿé¨“å®Ÿè¡Œä¸­ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        document.querySelector('.participant-header').style.display = 'none';
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
        startSessionTimer();
        
        // å‚åŠ è€…IDã¨dayç•ªå·ã«åŸºã¥ã„ã¦æ±ºå®šçš„ã«ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ
        currentScenarioIndex = getDeterministicScenarioIndex(participantId, currentDay);
        displayScenario();
    }

    function displayScenario() {
        const scenario = scenarios[currentScenarioIndex];
        document.getElementById('currentScenarioTitle').textContent = scenario.title;
        document.getElementById('currentScenarioContent').textContent = scenario.content;
        document.getElementById('scenarioDisplay').style.display = 'block';
        
        document.getElementById('progressFill').style.width = '40%';
        
        if (currentDay === 1 || currentDay === 7) {
            document.getElementById('selfMentalize').style.display = 'block';
            document.getElementById('agentChat').style.display = 'none';
        } else {
            document.getElementById('selfMentalize').style.display = 'none';
            document.getElementById('agentChat').style.display = 'block';
            initializeChat();
        }
        
        // å®Ÿé¨“ä¸­ã¯ä¸€æ™‚ä¸­æ–­ãƒ»ã‚„ã‚ã‚‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('pauseExperimentBtn').style.display = 'inline-block';
        document.getElementById('quitExperimentBtn').style.display = 'inline-block';
    }

    async function submitAnalysis() {
        const analysis = document.getElementById('userAnalysis').value;
        if (!analysis.trim()) {
            alert('åˆ†æã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®ãƒã‚§ãƒƒã‚¯
        if (!hasMinimumTimeElapsed()) {
            const remainingSeconds = getRemainingTime();
            const remainingMinutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            alert(`æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚\nã‚ã¨${remainingMinutes}åˆ†${seconds}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`);
            return;
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const confirmSubmit = confirm('åˆ†æã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ\næå‡ºã™ã‚‹ã¨æœ¬æ—¥ã®å®Ÿé¨“ãŒçµ‚äº†ã—ã¾ã™ã€‚');
        if (!confirmSubmit) {
            return;
        }

        await saveExperimentLog({
            participantId,
            day: currentDay,
            scenarioIndex: currentScenarioIndex,
            scenarioTitle: scenarios[currentScenarioIndex].title,
            analysis,
            experimentType: 'self_analysis'
        });
        
        // å®Ÿé¨“çµ‚äº†æ™‚ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        const endSurvey = surveys.find(s => s.day === currentDay && s.timing === 'end');
        if (endSurvey) {
            await showSurvey(endSurvey, 'end');
        }

        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('selfMentalize').style.display = 'none';
        document.getElementById('experimentComplete').style.display = 'block';
    }

    function initializeChat() {
        const messages = document.getElementById('chatMessages');
        messages.innerHTML = '';
        
        addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼ã“ã®ã‚·ãƒŠãƒªã‚ªã«ã¤ã„ã¦ã€ç™»å ´äººç‰©ã®æ°—æŒã¡ã‚„è€ƒãˆã‚’ä¸€ç·’ã«æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¾ãšã€ã©ã®äººç‰©ã«æ³¨ç›®ã—ã¾ã™ã‹ï¼Ÿ');
        
        document.getElementById('progressFill').style.width = '50%';
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        addMessage('user', message);
        input.value = '';
        
        // AIãŒè€ƒãˆã¦ã„ã‚‹æ—¨ã‚’è¡¨ç¤º
        const loadingMessageId = addLoadingMessage();
        
        try {
            const response = await generateAIResponse(message);
            removeLoadingMessage(loadingMessageId);
            addMessage('ai', response);
        } catch (error) {
            removeLoadingMessage(loadingMessageId);
            addMessage('ai', 'AIã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
    }

    function getChatHistory() {
        const messages = document.querySelectorAll('#chatMessages .message');
        return Array.from(messages).map(msg => ({
            sender: msg.classList.contains('user') ? 'user' : 'ai',
            content: msg.textContent,
            timestamp: new Date().toISOString()
        }));
    }

    function addMessage(sender, text) {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.textContent = text;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    // AIå¿œç­”å¾…ã¡ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addLoadingMessage() {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        const loadingId = 'loading-' + Date.now();
        messageDiv.id = loadingId;
        messageDiv.className = 'message ai loading';
        messageDiv.innerHTML = 'ğŸ¤” è€ƒãˆã¦ã„ã¾ã™...';
        
        // CSS animations for the loading indicator
        messageDiv.style.opacity = '0.7';
        messageDiv.style.fontStyle = 'italic';
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
        
        return loadingId;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    function removeLoadingMessage(loadingId) {
        const loadingMessage = document.getElementById(loadingId);
        if (loadingMessage) {
            loadingMessage.remove();
        }
    }

    async function generateAIResponse(userMessage) {
        const currentScenario = scenarios[currentScenarioIndex];
        let systemPrompt = adminConfig.systemPrompt;
        
        // æƒ³å®šè³ªå•ãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
        if (currentScenario.promptQuestions && currentScenario.promptQuestions.length > 0) {
            systemPrompt += '\n\nå‚è€ƒç”¨æƒ³å®šè³ªå•:\n' + currentScenario.promptQuestions.map(q => `- ${q}`).join('\n');
        }
        
        // éš ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
        if (currentScenario.hiddenContext && currentScenario.hiddenContext.trim()) {
            systemPrompt += '\n\nèƒŒæ™¯æƒ…å ±ãƒ»ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹:\n' + currentScenario.hiddenContext;
        }
        
        // åˆ†æãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
        if (currentScenario.analysisPoints && currentScenario.analysisPoints.trim()) {
            systemPrompt += '\n\nåˆ†ææ™‚ã®ç€ç›®ç‚¹:\n' + currentScenario.analysisPoints;
        }
        
        // ä¼šè©±å±¥æ­´ã‚’å–å¾—ã—ã¦æ–‡è„ˆã‚’ä¿æŒ
        const chatHistory = getChatHistory();
        const userContent = `ã‚·ãƒŠãƒªã‚ª: ${currentScenario.content}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€: ${userMessage}`;
        
        if (adminConfig.apiKey) {
            try {
                // ãƒ‡ãƒãƒƒã‚°ç”¨: ä½¿ç”¨ä¸­ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ã‚°å‡ºåŠ›
                const requestStartTime = performance.now();
                console.log(`ğŸ¤– AI Request - Provider: ${adminConfig.apiProvider}, Model: ${adminConfig.model}, Custom: ${adminConfig.useCustomModel || false}`);
                
                let apiUrl, headers, requestBody;
                
                if (adminConfig.apiProvider === 'openai') {
                    if (!adminConfig.apiKey.startsWith('sk-')) {
                        throw new Error('OpenAI APIã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                    
                    apiUrl = 'https://api.openai.com/v1/chat/completions';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminConfig.apiKey}`
                    };
                    
                    // ä¼šè©±å±¥æ­´ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
                    const messages = [{ role: 'system', content: systemPrompt }];
                    
                    // éå»ã®ä¼šè©±å±¥æ­´ã‚’è¿½åŠ ï¼ˆç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ãï¼‰
                    chatHistory.slice(0, -1).forEach(msg => {
                        messages.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.content
                        });
                    });
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    // messages.push({ role: 'user', content: userContent });
                    
                    // requestBody = {
                    //     model: adminConfig.model,
                    //     messages: messages,
                    //     ...(adminConfig.model && adminConfig.model.startsWith('gpt-5')
                    //         ? { max_completion_tokens: adminConfig.maxTokens || 300 }
                    //         : { max_tokens: adminConfig.maxTokens || 300 }),
                    //     temperature: adminConfig.temperature || 0.7
                    // };
                  // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    messages.push({ role: 'user', content: userContent });
                  
                    if (adminConfig && typeof adminConfig.model === 'string' && adminConfig.model.indexOf('gpt-5') === 0) {
                      // GPT-5 ç³»ï¼šmax_tokensã¯ä¸å¯ã€temperatureã‚‚é€ã‚‰ãªã„ï¼ˆ=ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1ï¼‰
                      requestBody = {
                        model: adminConfig.model,
                        messages: messages,
                        max_completion_tokens: (adminConfig.maxTokens || 300)
                      };
                    } else {
                      
                      requestBody = {
                        model: adminConfig.model,
                        messages: messages,
                        max_tokens: (adminConfig.maxTokens || 300),
                        temperature: (adminConfig.temperature || 0.7)
                      };
                    }
                   //

                } else if (adminConfig.apiProvider === 'claude') {
                    apiUrl = 'https://api.anthropic.com/v1/messages';
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': adminConfig.apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    
                    // ä¼šè©±å±¥æ­´ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ï¼ˆClaudeã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒåˆ¥ï¼‰
                    const messages = [];
                    
                    // éå»ã®ä¼šè©±å±¥æ­´ã‚’è¿½åŠ ï¼ˆç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ãï¼‰
                    chatHistory.slice(0, -1).forEach(msg => {
                        messages.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.content
                        });
                    });
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    messages.push({ role: 'user', content: userContent });
                    
                    requestBody = {
                        model: adminConfig.model,
                        max_tokens: adminConfig.maxTokens || 300,
                        temperature: adminConfig.temperature || 0.7,
                        system: systemPrompt,
                        messages: messages
                    };
                } else if (adminConfig.apiProvider === 'gemini') {
                    // Google Gemini API
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${adminConfig.model}:generateContent?key=${adminConfig.apiKey}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    requestBody = {
                        contents: [{
                            parts: [{ text: `${systemPrompt}\n\n${userContent}` }]
                        }],
                        generationConfig: {
                            maxOutputTokens: adminConfig.maxTokens || 300,
                            temperature: adminConfig.temperature || 0.7
                        }
                    };
                } else if (adminConfig.apiProvider === 'custom') {
                    if (!adminConfig.customApiUrl) {
                        throw new Error('ã‚«ã‚¹ã‚¿ãƒ API URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                    
                    apiUrl = adminConfig.customApiUrl;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminConfig.apiKey}`
                    };
                    
                    // ä¼šè©±å±¥æ­´ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
                    const messages = [{ role: 'system', content: systemPrompt }];
                    
                    // éå»ã®ä¼šè©±å±¥æ­´ã‚’è¿½åŠ ï¼ˆç¾åœ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ãï¼‰
                    chatHistory.slice(0, -1).forEach(msg => {
                        messages.push({
                            role: msg.sender === 'user' ? 'user' : 'assistant',
                            content: msg.content
                        });
                    });
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                    messages.push({ role: 'user', content: userContent });
                    
                    requestBody = {
                        model: adminConfig.model,
                        messages: messages,
                        ...(adminConfig.model && adminConfig.model.startsWith('gpt-5')
                            ? { max_completion_tokens: adminConfig.maxTokens || 300 }
                            : { max_tokens: adminConfig.maxTokens || 300 }),
                        temperature: adminConfig.temperature || 0.7
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’ãƒ­ã‚°å‡ºåŠ›
                    const requestEndTime = performance.now();
                    const responseTime = Math.round(requestEndTime - requestStartTime);
                    console.log(`âš¡ AI Response - Time: ${responseTime}ms, Model: ${adminConfig.model}`);
                    
                    if (adminConfig.apiProvider === 'claude') {
                        return data.content[0].text;
                    } else if (adminConfig.apiProvider === 'gemini') {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        return data.choices[0].message.content;
                    }
                } else {
                    const errorData = await response.text();
                    console.error(`APIã‚¨ãƒ©ãƒ¼ (${response.status}):`, errorData);
                    throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ (${response.status})`);
                }
            } catch (error) {
                console.error('AI API ã‚¨ãƒ©ãƒ¼:', error);
                addMessage('ai', 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€AIã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã€‚');
            }
        }

        // ãƒ‡ãƒ¢ç”¨ã®å¿œç­”
        const responses = [
            "ãªã‚‹ã»ã©ã€ãã®è¦³ç‚¹ã¯èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚ç™»å ´äººç‰©ã®è¡¨æƒ…ã‚„è¡Œå‹•ã‹ã‚‰ã‚‚ä½•ã‹èª­ã¿å–ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
            "ã¨ã¦ã‚‚è‰¯ã„åˆ†æã§ã™ã­ã€‚ä»–ã®ç™»å ´äººç‰©ã¯ã©ã®ã‚ˆã†ãªæ°—æŒã¡ã§ã„ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
            "ãã®é€šã‚Šã§ã™ã­ã€‚ã•ã‚‰ã«æ·±ãè€ƒãˆã¦ã¿ã‚‹ã¨ã€ãªãœãã®ã‚ˆã†ãªæ„Ÿæƒ…ã‚’æŠ±ã„ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
            "ç´ æ™´ã‚‰ã—ã„æ°—ã¥ãã§ã™ã€‚ãã“ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹äººé–“é–¢ä¿‚ã¯ã©ã®ã‚ˆã†ãªã‚‚ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
            "èˆˆå‘³æ·±ã„æŒ‡æ‘˜ã§ã™ã­ã€‚ãã®çŠ¶æ³ã§ç›¸æ‰‹ã¯ã©ã‚“ãªã“ã¨ã‚’è€ƒãˆã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
            "è‰¯ã„è¦–ç‚¹ã§ã™ã­ã€‚ã‚‚ã—è‡ªåˆ†ãŒãã®ç«‹å ´ã ã£ãŸã‚‰ã€ã©ã®ã‚ˆã†ã«æ„Ÿã˜ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ"
        ];
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        return responses[Math.floor(Math.random() * responses.length)];
    }

    async function initializeUserSession(userId) {
      if (!supabase) {
        console.log('âš ï¸ Supabaseæœªæ¥ç¶šã®ãŸã‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
        return;
      }
      
      // user_idã‚’æ–‡å­—åˆ—ã¨ã—ã¦ç¢ºå®Ÿã«å‡¦ç†
      const userIdStr = String(userId);
      console.log('ğŸ“‹ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–å‡¦ç†é–‹å§‹:', userIdStr);
      
      try {
        const { data, error } = await supabase
          .from('user_sessions')
          .select('*')
          .eq('user_id', userIdStr)
          .maybeSingle();
      
        if (error) {
          console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          return;
        }
        
        if (!data) { // No record found
          try {
            const { error: insertError } = await supabase
              .from('user_sessions')
              .insert([{ user_id: userIdStr, start_date: new Date().toISOString() }]);
        
            if (insertError) {
              if (insertError.code === '42501') {
                console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼é•å: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™»éŒ²ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¶™ç¶šã—ã¾ã™');
                return;
              }
              console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸç™»éŒ²ã‚¨ãƒ©ãƒ¼:', insertError);
            } else {
              console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸç™»éŒ²å®Œäº†');
              // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æ›´æ–°
              await loadUserSessionsUI();
            }
          } catch (insertErr) {
            console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™»éŒ²ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿé¨“ã¯ç¶™ç¶šã§ãã¾ã™');
          }
        } else if (data) {
          // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
          try {
            const { error: updateError } = await supabase
              .from('user_sessions')
              .update({ updated_at: new Date().toISOString() })
              .eq('user_id', userIdStr);
              
            if (updateError) {
              if (updateError.code === '42501') {
                console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼é•å: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¶™ç¶šã—ã¾ã™');
                return;
              }
              console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateError);
            } else {
              console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†');
              // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æ›´æ–°
              await loadUserSessionsUI();
            }
          } catch (updateErr) {
            console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿé¨“ã¯ç¶™ç¶šã§ãã¾ã™');
          }
          console.log('ğŸ“… æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ—¥:', data.start_date);
        } else if (error) {
          if (error.code === '42501') {
            console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼é•å: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
            console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¶™ç¶šã—ã¾ã™');
            return;
          }
          console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }
      } catch (generalError) {
        console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã®å…¨èˆ¬çš„ã‚¨ãƒ©ãƒ¼:', generalError);
        console.log('âœ… å®Ÿé¨“ã¯ç¶™ç¶šã§ãã¾ã™');
      }
    }

    async function getCurrentExperimentDay(userId) {
      // user_idã‚’æ–‡å­—åˆ—ã¨ã—ã¦ç¢ºå®Ÿã«å‡¦ç†
      const userIdStr = String(userId);
      
      const { data, error } = await supabase
        .from('user_sessions')
        .select('start_date')
        .eq('user_id', userIdStr)
        .single();
    
      const today = new Date();
    
      if (error || !data) {
        // start_date ãŒã¾ã ãªã„å ´åˆã€ä»Šæ—¥ã‚’é–‹å§‹æ—¥ã«ç™»éŒ²
        const { error: insertError } = await supabase
          .from('user_sessions')
          .insert([{ user_id: userIdStr, start_date: today }]);
    
        if (insertError) {
          console.error('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', insertError);
          return null;
        }
    
        return 1; // ä»Šæ—¥ãŒåˆæ—¥
      }
    
      const start = new Date(data.start_date);
      const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));
      return diffDays + 1;
    }



    async function finishChat() {
        // æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®ãƒã‚§ãƒƒã‚¯
        if (!hasMinimumTimeElapsed()) {
            const remainingSeconds = getRemainingTime();
            const remainingMinutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            alert(`æœ€ä½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚\nã‚ã¨${remainingMinutes}åˆ†${seconds}ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚`);
            return;
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const confirmFinish = confirm('å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nçµ‚äº†ã™ã‚‹ã¨æœ¬æ—¥ã®å®Ÿé¨“ãŒçµ‚äº†ã—ã¾ã™ã€‚');
        if (!confirmFinish) {
            return;
        }

        await saveExperimentLog({
            participantId,
            day: currentDay,
            scenarioIndex: currentScenarioIndex,
            scenarioTitle: scenarios[currentScenarioIndex].title,
            chatHistory: getChatHistory(),
            experimentType: 'agent_assisted'
        });
        
        // å®Ÿé¨“çµ‚äº†æ™‚ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        const endSurvey = surveys.find(s => s.day === currentDay && s.timing === 'end');
        if (endSurvey) {
            await showSurvey(endSurvey, 'end');
        }

        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('agentChat').style.display = 'none';
        document.getElementById('experimentComplete').style.display = 'block';
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        stopSessionTimer();
        
        // å¯¾è©±çµ‚äº†å¾Œã¯ä¸€æ™‚ä¸­æ–­ãƒ»ã‚„ã‚ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        document.getElementById('pauseExperimentBtn').style.display = 'none';
        document.getElementById('quitExperimentBtn').style.display = 'none';
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®å¤‰æ•°
    let sessionStartTime = null;
    let timerInterval = null;
    let accumulatedTime = 0; // è“„ç©ã•ã‚ŒãŸçµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    let isPaused = false;
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
    function startSessionTimer() {
        console.log('ğŸ• ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹è¦æ±‚:', adminConfig.showSessionTimer);
        
        // ç®¡ç†è€…è¨­å®šã§ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãŒæœ‰åŠ¹ãªå ´åˆã®ã¿è¡¨ç¤º
        if (adminConfig.showSessionTimer) {
            document.getElementById('sessionTimer').style.display = 'block';
            console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™');
        } else {
            document.getElementById('sessionTimer').style.display = 'none';
            console.log('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã¯ç„¡åŠ¹ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™');
            return; // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãŒç„¡åŠ¹ãªå ´åˆã¯å‡¦ç†ã‚’çµ‚äº†
        }
        
        sessionStartTime = new Date();
        
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°åœæ­¢
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // 1ç§’ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°
        timerInterval = setInterval(() => {
            if (sessionStartTime && !isPaused) {
                const currentElapsed = new Date() - sessionStartTime;
                const totalElapsed = accumulatedTime + currentElapsed;
                const hours = Math.floor(totalElapsed / 3600000);
                const minutes = Math.floor((totalElapsed % 3600000) / 60000);
                const seconds = Math.floor((totalElapsed % 60000) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const timerElement = document.getElementById('timerDisplay');
                if (timerElement) {
                    timerElement.textContent = timeString;
                } else {
                    console.error('âŒ timerDisplayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }
        }, 1000);
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹é–¢æ•°
    function stopSessionTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        sessionStartTime = null;
        accumulatedTime = 0;
        isPaused = false;
        document.getElementById('sessionTimer').style.display = 'none';
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹é–¢æ•°
    function pauseSessionTimer() {
        if (sessionStartTime && !isPaused) {
            accumulatedTime += new Date() - sessionStartTime;
            isPaused = true;
            sessionStartTime = null;
            console.log('â¸ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãŒä¸€æ™‚åœæ­¢ã•ã‚Œã¾ã—ãŸ');
        }
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹ã™ã‚‹é–¢æ•°
    function resumeSessionTimer() {
        if (isPaused) {
            sessionStartTime = new Date();
            isPaused = false;
            console.log('â–¶ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãŒå†é–‹ã•ã‚Œã¾ã—ãŸ');
        }
    }
    
    function resetExperiment() {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        stopSessionTimer();
        
        document.getElementById('experimentContent').style.display = 'none';
        document.getElementById('participantSetup').style.display = 'block';
        
        // å®Ÿé¨“åˆ¶å¾¡ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        document.getElementById('experimentControls').style.display = 'none';
        document.getElementById('pauseExperimentBtn').style.display = 'none';
        document.getElementById('quitExperimentBtn').style.display = 'none';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å†è¡¨ç¤º
        document.querySelector('.participant-header').style.display = 'block';
        
        document.getElementById('userAnalysis').value = '';
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('progressFill').style.width = '0%';
        
        ['scenarioDisplay', 'selfMentalize', 'agentChat', 'experimentComplete'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }
    
    // ã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleCompactMode() {
        const body = document.body;
        const container = document.querySelector('.container');
        const toggleBtn = document.getElementById('toggleCompactBtn');
        
        if (body.classList.contains('compact-body')) {
            // é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
            body.classList.remove('compact-body');
            container.classList.remove('compact-mode');
            toggleBtn.innerHTML = 'ğŸ“± ã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤º';
            toggleBtn.title = 'æ¨ªæ–¹å‘ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’æœ€å¤§åŒ–ã—ã¾ã™';
        } else {
            // ã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºã«ã™ã‚‹
            body.classList.add('compact-body');
            container.classList.add('compact-mode');
            toggleBtn.innerHTML = 'ğŸ–¥ï¸ é€šå¸¸è¡¨ç¤º';
            toggleBtn.title = 'é€šå¸¸ã®è¡¨ç¤ºã«æˆ»ã—ã¾ã™';
        }
    }
    
    // å®Ÿé¨“ã‚’å®Œå…¨ã«çµ‚äº†ã—ã¦æ—¥ä»˜é¸æŠã«æˆ»ã‚‹é–¢æ•°
    function quitExperiment() {
        const confirmed = confirm(
            'å®Ÿé¨“ã‚’å®Œå…¨ã«çµ‚äº†ã—ã¦æ—¥ä»˜é¸æŠã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n' +
            'ç¾åœ¨ã®å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œãšã«å¤±ã‚ã‚Œã¾ã™ã€‚\n' +
            'ï¼ˆä¸€æ™‚ä¸­æ–­ã¨ã¯ç•°ãªã‚Šã€å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼‰'
        );
        
        if (!confirmed) {
            return;
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’å®Œå…¨ã«åœæ­¢ï¼ˆä¸€æ™‚ä¸­æ–­ã§ã¯ãªãå®Œå…¨åœæ­¢ï¼‰
        stopSessionTimer();
        isPaused = false;
        accumulatedTime = 0;
        
        // å®Ÿé¨“ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
        document.getElementById('experimentContent').style.display = 'none';
        document.getElementById('participantSetup').style.display = 'block';
        
        // å®Ÿé¨“åˆ¶å¾¡ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        document.getElementById('experimentControls').style.display = 'none';
        document.getElementById('pauseExperimentBtn').style.display = 'none';
        document.getElementById('quitExperimentBtn').style.display = 'none';
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å†è¡¨ç¤º
        document.querySelector('.participant-header').style.display = 'block';
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('participantId').value = '';
        document.getElementById('experimentDay').value = '1';
        document.getElementById('userAnalysis').value = '';
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('progressFill').style.width = '0%';
        
        // å…¨ã¦ã®å®Ÿé¨“ç”»é¢ã‚’éè¡¨ç¤º
        ['scenarioDisplay', 'selfMentalize', 'agentChat', 'experimentComplete'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
        participantId = '';
        currentDay = 1;
        sessionStartTime = null;
        
        console.log('ğŸšª å®Ÿé¨“ãŒå®Œå…¨ã«çµ‚äº†ã•ã‚Œã€æ—¥ä»˜é¸æŠç”»é¢ã«æˆ»ã‚Šã¾ã—ãŸ');
    }
    
    // å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
    async function deleteParticipantData() {
        const participantId = document.getElementById('deleteParticipantId').value.trim();
        const deleteScope = document.querySelector('input[name="deleteScope"]:checked').value;
        
        if (!participantId) {
            alert('å‰Šé™¤ã™ã‚‹å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // å‰Šé™¤å¯¾è±¡ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
        const logsCount = experimentLogs.filter(log => log.participant_id === participantId).length;
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºä¿
        let surveysCount = 0;
        if (supabase) {
            const { data: latestSurveys } = await supabase
                .from('survey_results')
                .select('*')
                .eq('participant_id', participantId);
            surveysCount = latestSurveys ? latestSurveys.length : 0;
        } else {
            surveysCount = surveyResults ? surveyResults.filter(result => result.participant_id === participantId).length : 0;
        }
        
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const scopeText = deleteScope === 'logs' ? 'å®Ÿé¨“ãƒ­ã‚°' : 
                         deleteScope === 'surveys' ? 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ' : 
                         'å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿé¨“ãƒ­ã‚°ãƒ»ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœãƒ»å‚åŠ è€…æƒ…å ±ï¼‰';
        
        let confirmMessage = `âš ï¸ å±é™ºãªæ“ä½œã§ã™ï¼\n\n` +
            `å‚åŠ è€…ID: ${participantId}\n` +
            `å‰Šé™¤ç¯„å›²: ${scopeText}\n\n`;
        
        // å‰Šé™¤ã•ã‚Œã‚‹å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿æ•°ã‚’è¡¨ç¤º
        if (deleteScope === 'logs' || deleteScope === 'all') {
            confirmMessage += `å®Ÿé¨“ãƒ­ã‚°: ${logsCount}ä»¶\n`;
        }
        if (deleteScope === 'surveys' || deleteScope === 'all') {
            confirmMessage += `ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ: ${surveysCount}ä»¶\n`;
        }
        
        confirmMessage += `\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
        
        const confirmed = confirm(confirmMessage);
        
        if (!confirmed) return;
        
        try {
            if (!supabase) {
                alert('Supabaseã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã¯Supabaseæ¥ç¶šæ™‚ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');
                return;
            }
            
            let deletedItems = [];
            
            if (deleteScope === 'logs' || deleteScope === 'all') {
                // å®Ÿé¨“ãƒ­ã‚°ã‚’å‰Šé™¤
                const { error: logsError } = await supabase
                    .from('experiment_logs')
                    .delete()
                    .eq('participant_id', participantId);
                
                if (logsError) {
                    // RLSé•åã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ä¸å­˜åœ¨ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    if (logsError.code === '42501') {
                        console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šå®Ÿé¨“ãƒ­ã‚°ã®å‰Šé™¤ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                        alert('âš ï¸ Supabaseã®è¨­å®šã«ã‚ˆã‚Šã€å®Ÿé¨“ãƒ­ã‚°ã®å‰Šé™¤ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚\n' +
                              'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†è€…ã«RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼ã®ç¢ºèªã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        throw logsError;
                    }
                } else {
                    deletedItems.push('å®Ÿé¨“ãƒ­ã‚°');
                }
            }
            
            if (deleteScope === 'surveys' || deleteScope === 'all') {
                // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’å‰Šé™¤
                const { error: surveysError } = await supabase
                    .from('survey_results')
                    .delete()
                    .eq('participant_id', participantId);
                
                if (surveysError) {
                    // RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼é•åã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ä¸å­˜åœ¨ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
                    if (surveysError.code === '42501') {
                        console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®å‰Šé™¤ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                        alert('âš ï¸ Supabaseã®è¨­å®šã«ã‚ˆã‚Šã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®å‰Šé™¤ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚\n' +
                              'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†è€…ã«RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼ã®ç¢ºèªã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚\n\n' +
                              'ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + surveysError.code + '\n' +
                              'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + surveysError.message);
                        // RLSåˆ¶é™ã®å ´åˆã¯å‡¦ç†ã‚’ç¶™ç¶šï¼ˆä»–ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤å¯èƒ½ï¼‰
                    } else if (surveysError.code === '42P01') {
                        console.warn('âš ï¸ survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                        alert('âš ï¸ survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®å‰Šé™¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                    } else {
                        // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ä¾‹å¤–ã¨ã—ã¦å‡¦ç†
                        throw surveysError;
                    }
                } else {
                    deletedItems.push('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ');
                }
            }
            
            if (deleteScope === 'all') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                const { error: sessionsError } = await supabase
                    .from('user_sessions')
                    .delete()
                    .eq('user_id', participantId);
                
                if (sessionsError) {
                    if (sessionsError.code === '42501') {
                        console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                        alert('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        throw sessionsError;
                    }
                } else {
                    deletedItems.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³');
                }
                
                // æœ€å¾Œã«å‚åŠ è€…æƒ…å ±ã‚’å‰Šé™¤
                const { error: participantsError } = await supabase
                    .from('participants')
                    .delete()
                    .eq('id', participantId);
                
                if (participantsError) {
                    if (participantsError.code === '42501') {
                        console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šå‚åŠ è€…æƒ…å ±ã®å‰Šé™¤ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                        alert('âš ï¸ å‚åŠ è€…æƒ…å ±ã®å‰Šé™¤ã¯åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        throw participantsError;
                    }
                } else {
                    deletedItems.push('å‚åŠ è€…æƒ…å ±');
                }
            }
            
            // å‰Šé™¤çµæœã®è¡¨ç¤º
            if (deletedItems.length > 0) {
                alert(`âœ… å‰Šé™¤å®Œäº†\n\nå‚åŠ è€…ID: ${participantId}\nå‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿: ${deletedItems.join('ã€')}`);
            } else {
                alert(`âš ï¸ å‰Šé™¤å‡¦ç†å®Œäº†\n\nå‚åŠ è€…ID: ${participantId}\nã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒRLSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šå‰Šé™¤åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚\nSupabaseã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
            
            // é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('deleteParticipantId').value = '';
            
            // å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            await loadExperimentLogs();
            await loadSurveyResults();
            
            // å‚åŠ è€…é¸æŠè‚¢ã‚’æ›´æ–°
            await updateParticipantFilter();
            
            displayFilteredLogs();
            
            // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœè¡¨ç¤ºã‚‚æ›´æ–°
            updateParticipantSelect();
            if (document.getElementById('surveyResults')) {
                displaySurveyResults();
            }
            
            // ç®¡ç†ç”»é¢ã®è¡¨ç¤ºã‚’æ›´æ–°
            if (currentMode === 'admin') {
                showAdminScreen('adminLogs');
            }
            
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            alert(`âŒ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
    
    // å®Ÿé¨“ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹é–¢æ•°
    window.goBackToExperimentSetup = function() {
        const confirmed = confirm(
            'å®Ÿé¨“ã‚’ä¸­æ–­ã—ã¦ã€æœ€åˆã®ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\n' +
            'æœªä¿å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
        );
        
        if (confirmed) {
            resetExperiment();
        }
    };

    // åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
    ã€€  
   ã€€ loadFromLocalStorage();  

      try {
        await initializeSupabase();  // Supabaseã®åˆæœŸåŒ–
        console.log('âœ… Supabase åŒæœŸå®Œäº†');
        

        await fetchAdminConfig();     // ç®¡ç†è¨­å®šã®å–å¾—ï¼ˆadminConfig ã«èª­ã¿è¾¼ã¿ï¼‰
        loadAdminConfigUI();          // UIã¸ã®åæ˜ 
        if (supabase) await loadUserSessionsUI();
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç³»ã¯å‚åŠ è€…ãƒ¢ãƒ¼ãƒ‰æ™‚ã«å‡¦ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        await loadSurveys(); // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        console.log('ğŸ“‹ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
        
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®èª­ã¿è¾¼ã¿ã‚’å¼·åˆ¶å®Ÿè¡Œ
        await loadSurveyResultsForDisplay();
        console.log('ğŸ“Š ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
    
        
        // âœ… ç®¡ç†è¨­å®šã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹ï¼ˆSupabaseåˆæœŸåŒ–æˆåŠŸæ™‚ã®ã¿ï¼‰
        if (supabase) {
          supabase.channel('admin-config-watch')
            .on(
              'postgres_changes',
              {
                event: '*',
                schema: 'public',
                table: 'admin_settings',
                filter: 'id=eq.admin_config'  // å›ºå®šIDã®è¨­å®šãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å¯¾è±¡
              },
              (payload) => {
                if (payload.new) {
                  adminConfig = payload.new.settings;
                  loadAdminConfigUI(); // UIã‚’å³æ™‚æ›´æ–°
                }
               }
             )
             .subscribe();
        }
        
      } catch (err) {
        console.error('âŒ åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼:', err);
      }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById('participantBtn').addEventListener('click', () => selectMode('participant'));
        document.getElementById('adminAccessBtn').addEventListener('click', attemptAdminAccess);
        document.getElementById('backToModeSelectBtn').addEventListener('click', () => selectMode('none'));
        // APIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('apiProvider').addEventListener('change', updateApiProviderUI);
        
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
        document.getElementById('saveSurveyBtn').addEventListener('click', saveSurvey);
        document.getElementById('loadSurveyResultsBtn').addEventListener('click', loadSurveyResults);
        document.getElementById('resultParticipant').addEventListener('change', displaySurveyResults);
        document.getElementById('resultDay').addEventListener('change', displaySurveyResults);
        
        // ç®¡ç†è€…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('adminSurveysNav').addEventListener('click', () => {
            showAdminScreen('adminSurveys');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminSurveysNav').classList.add('active');
            loadSurveys();
        });
        document.getElementById('showUserSessionsBtn').addEventListener('click', function() {
            const section = document.getElementById('userSessionsSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                loadUserSessionsUI();
                this.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’éè¡¨ç¤º';
            } else {
                section.style.display = 'none';
                this.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º';
            }
        });
        
        // ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³è¿½åŠ 
        document.getElementById('adminLogoutBtn4').addEventListener('click', adminLogout);

        
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è³ªå•ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('question-type')) {
                const container = e.target.closest('.question-item');
                const optionsContainer = container.querySelector('.options-container');
                const scaleContainer = container.querySelector('.scale-container');
                
                if (e.target.value === 'radio' || e.target.value === 'checkbox') {
                    optionsContainer.style.display = 'block';
                    scaleContainer.style.display = 'none';
                } else if (e.target.value === 'scale') {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'block';
                } else {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'none';
                }
            }
        });
        
        // ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('adminLogoutBtn').addEventListener('click', adminLogout);
        document.getElementById('adminLogoutBtn2').addEventListener('click', adminLogout);
        document.getElementById('adminLogoutBtn3').addEventListener('click', adminLogout);
        
        document.getElementById('adminConfigNav').addEventListener('click', () => {
            showAdminScreen('adminConfig');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminConfigNav').classList.add('active');
        });
        
        document.getElementById('adminScenariosNav').addEventListener('click', () => {
            showAdminScreen('adminScenarios');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminScenariosNav').classList.add('active');
        });
        
        document.getElementById('adminAssignmentsNav').addEventListener('click', () => {
            showAdminScreen('adminAssignments');
            updateAssignmentsList();
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminAssignmentsNav').classList.add('active');
        });
        
        document.getElementById('adminLogsNav').addEventListener('click', () => {
            showAdminScreen('adminLogs');
            document.querySelectorAll('#adminNav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('adminLogsNav').classList.add('active');
        });
        
        // è¨­å®šä¿å­˜
        document.getElementById('changePasswordBtn').addEventListener('click', changeAdminPassword);
        document.getElementById('saveConfigBtn').addEventListener('click', saveAdminConfig);
        document.getElementById('savePromptBtn').addEventListener('click', savePromptConfig);
        document.getElementById('saveSessionConfigBtn').addEventListener('click', saveSessionConfig);
        document.getElementById('saveMemoBtn').addEventListener('click', saveMemo);
        
        // ãƒ¢ãƒ‡ãƒ«é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('modelSelect').addEventListener('change', updateCustomModelVisibility);
        document.getElementById('validateModelBtn').addEventListener('click', validateModel);
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ã‹ã‚‰é‡è¤‡ã—ã¦ã„ãŸãŸã‚å‰Šé™¤ï¼‰
        
        // ã‚·ãƒŠãƒªã‚ªç®¡ç†
        document.getElementById('addScenarioBtn').addEventListener('click', addScenario);
        document.getElementById('cancelEditBtn').addEventListener('click', cancelScenarioEdit);
        
        // ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
        document.getElementById('filterParticipant').addEventListener('change', displayFilteredLogs);
        document.getElementById('filterDay').addEventListener('change', displayFilteredLogs);
        
        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        document.getElementById('deleteDataBtn').addEventListener('click', deleteParticipantData);
        
        // å®Ÿé¨“åˆ¶å¾¡ãƒœã‚¿ãƒ³
        document.getElementById('toggleCompactBtn').addEventListener('click', toggleCompactMode);
        document.getElementById('pauseExperimentBtn').addEventListener('click', function() {
            selectMode('none');
        });
        
        document.getElementById('quitExperimentBtn').addEventListener('click', quitExperiment);
        
        // å®Ÿé¨“ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('startExperimentBtn').addEventListener('click', startExperiment);
        document.getElementById('backToModeSelectBtn').addEventListener('click', () => {
            selectMode('none');
        });
        document.getElementById('submitAnalysisBtn').addEventListener('click', submitAnalysis);
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('finishChatBtn').addEventListener('click', finishChat);
        document.getElementById('completeExperimentBtn').addEventListener('click', function() {
            selectMode('none');
        });
        // resetExperimentBtn removed - no longer needed after experiment completion
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEnterã‚­ãƒ¼ã¯æ”¹è¡Œã®ã¿ã€é€ä¿¡ãƒœã‚¿ãƒ³ã§é€ä¿¡ï¼‰
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            // Enterã‚­ãƒ¼ã§ã®é€ä¿¡ã‚’ç„¡åŠ¹åŒ–ã—ã€æ”¹è¡Œæ©Ÿèƒ½ã®ã¿æä¾›
            // Shift+Enterã¯è‡ªç„¶ã«æ”¹è¡Œã¨ã—ã¦å‹•ä½œ
        });
        
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') attemptAdminAccess();
        });
        //Javaçµ‚ã‚ã‚Š
        console.log('âœ… åˆæœŸåŒ–å®Œäº†');
    });
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
    async function showSurvey(survey, timing) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            const timingText = timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚';
            
            let questionsHtml = '';
            survey.questions.forEach((question, index) => {
                let inputHtml = '';
                
                switch (question.type) {
                    case 'text':
                        inputHtml = `<textarea id="answer_${index}" style="width: 100%; height: 80px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>`;
                        break;
                    case 'radio':
                        inputHtml = question.options.map((option, optIndex) => 
                            `<label style="display: block; margin: 5px 0;"><input type="radio" name="answer_${index}" value="${option}"> ${option}</label>`
                        ).join('');
                        break;
                    case 'checkbox':
                        inputHtml = question.options.map((option, optIndex) => 
                            `<label style="display: block; margin: 5px 0;"><input type="checkbox" name="answer_${index}" value="${option}"> ${option}</label>`
                        ).join('');
                        break;
                    case 'scale':
                        const [min, max] = question.range.split('-').map(Number);
                        inputHtml = `<div style="margin-top: 10px;">`;
                        for (let i = min; i <= max; i++) {
                            inputHtml += `<label style="margin-right: 15px;"><input type="radio" name="answer_${index}" value="${i}"> ${i}</label>`;
                        }
                        inputHtml += `</div>`;
                        break;
                }
                
                questionsHtml += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">Q${index + 1}: ${question.text}</div>
                        ${inputHtml}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="position: relative;">
                    <button id="closeSurveyBtn" style="position: absolute; top: -10px; right: -10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1001;">&times;</button>
                    <h3 style="margin-bottom: 20px; color: #495057; padding-right: 40px;">ğŸ“Š ${survey.day}æ—¥ç›® ${timingText}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
                    ${questionsHtml}
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="submitSurveyBtn" class="btn">å›ç­”ã‚’æå‡º</button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            document.getElementById('submitSurveyBtn').addEventListener('click', async () => {
                const answers = [];
                
                survey.questions.forEach((question, index) => {
                    let answer = '';
                    
                    switch (question.type) {
                        case 'text':
                            answer = document.getElementById(`answer_${index}`).value;
                            break;
                        case 'radio':
                        case 'scale':
                            const radioSelected = document.querySelector(`input[name="answer_${index}"]:checked`);
                            answer = radioSelected ? radioSelected.value : '';
                            break;
                        case 'checkbox':
                            const checkboxes = document.querySelectorAll(`input[name="answer_${index}"]:checked`);
                            answer = Array.from(checkboxes).map(cb => cb.value).join(', ');
                            break;
                    }
                    
                    answers.push({ question: question.text, answer });
                });
                
                // çµæœã‚’ä¿å­˜
                await saveSurveyResult({
                    participantId,
                    day: survey.day,
                    timing: survey.timing,
                    answers
                });
                
                document.body.removeChild(overlay);
                resolve();
            });
            
            // X ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('closeSurveyBtn').addEventListener('click', () => {
                document.body.removeChild(overlay);
                // æ—¥ä»˜é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                selectMode('participant');
                // resolve()ã‚’å‘¼ã°ãªã„ - ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒå¿…é ˆãªã®ã§å®Ÿé¨“ã‚’ç¶šè¡Œã•ã›ãªã„
            });
        });
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadSurveys() {
        if (!supabase) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
            const savedSurveys = localStorage.getItem('mentalizeSurveys');
            if (savedSurveys) {
                try {
                    surveys = JSON.parse(savedSurveys);
                } catch (error) {
                    surveys = [];
                }
            }
            updateSurveyList();
            loadSurveyResultsForDisplay();
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('admin_settings')
                .select('*')
                .eq('id', 'surveys')
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            if (data) {
                surveys = data.settings.surveys || [];
            } else {
                surveys = [];
                await saveSurveys(); // ç©ºã®é…åˆ—ã§åˆæœŸåŒ–
            }
            
            updateSurveyList();
            loadSurveyResultsForDisplay();
            console.log('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
        } catch (error) {
            console.error('âŒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            surveys = [];
        }
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
    async function saveSurveys() {
        if (!supabase) {
            localStorage.setItem('mentalizeSurveys', JSON.stringify(surveys));
            return;
        }
        
        try {
            const { error } = await supabase
                .from('admin_settings')
                .upsert({
                    id: 'surveys',
                    settings: { surveys },
                    updated_at: new Date().toISOString()
                });
            
            if (error) throw error;
        } catch (error) {
            console.error('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            localStorage.setItem('mentalizeSurveys', JSON.stringify(surveys));
        }
    }
    
    // è³ªå•ã‚’è¿½åŠ 
    function addQuestion() {
        const container = document.getElementById('questionsContainer');
        const questionCount = container.querySelectorAll('.question-item').length;
        
        const questionItem = document.createElement('div');
        questionItem.className = 'question-item';
        questionItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px;';
        
        questionItem.innerHTML = `
            <div class="form-group">
                <label>è³ªå•å†…å®¹</label>
                <textarea class="question-text" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="height: 60px;"></textarea>
            </div>
            <div class="form-group">
                <label>å›ç­”å½¢å¼</label>
                <select class="question-type">
                    <option value="text">è‡ªç”±è¨˜è¿°</option>
                    <option value="radio">å˜ä¸€é¸æŠ</option>
                    <option value="checkbox">è¤‡æ•°é¸æŠ</option>
                    <option value="scale">æ•°æ®µéšè©•ä¾¡</option>
                </select>
            </div>
            <div class="options-container" style="display: none;">
                <label>é¸æŠè‚¢ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                <textarea class="question-options" placeholder="é¸æŠè‚¢1\né¸æŠè‚¢2\né¸æŠè‚¢3" style="height: 80px;"></textarea>
            </div>
            <div class="scale-container" style="display: none;">
                <label>è©•ä¾¡ç¯„å›²</label>
                <select class="scale-range">
                    <option value="1-5">1-5æ®µéš</option>
                    <option value="1-7">1-7æ®µéš</option>
                    <option value="1-10">1-10æ®µéš</option>
                </select>
            </div>
            <button type="button" class="btn remove-question" style="background: #dc3545; margin-top: 10px;">è³ªå•ã‚’å‰Šé™¤</button>
        `;
        
        container.appendChild(questionItem);
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        questionItem.querySelector('.remove-question').addEventListener('click', () => {
            if (container.querySelectorAll('.question-item').length > 1) {
                questionItem.remove();
            } else {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®è³ªå•ãŒå¿…è¦ã§ã™');
            }
        });
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ä¿å­˜
    async function saveSurvey() {
        const day = Number(document.getElementById('surveyDay').value);
        const timing = document.querySelector('input[name="surveyTiming"]:checked').value;
        const questions = collectQuestionInputs();
        
        if (questions.length === 0) {
            alert('å°‘ãªãã¨ã‚‚1ã¤ã®è³ªå•ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
            return;
        }
        
        const surveyExists = surveys.find(s => s.day === day && s.timing === timing);
        if (surveyExists) {
            let choice;
            if (isEditingMode) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ç½®æ›ã‹è¿½åŠ ã‹ã‚’é¸æŠ
                choice = confirm(`${day}æ—¥ç›®ã®${timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚'}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚\n\nã€ŒOKã€: æ—¢å­˜ã®è³ªå•ã‚’æ–°ã—ã„è³ªå•ã§ç½®æ›\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: æ—¢å­˜ã®è³ªå•ã«æ–°ã—ã„è³ªå•ã‚’è¿½åŠ `);
                
                const existingIndex = surveys.findIndex(s => s.day === day && s.timing === timing);
                if (choice) {
                    // ç½®æ›: æ—¢å­˜ã®è³ªå•ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã‚‹
                    surveys[existingIndex].questions = questions;
                } else {
                    // è¿½åŠ : æ—¢å­˜ã®è³ªå•ã«æ–°ã—ã„è³ªå•ã‚’è¿½åŠ 
                    surveys[existingIndex].questions = [...surveys[existingIndex].questions, ...questions];
                }
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å¾“æ¥é€šã‚Š
                choice = confirm(`${day}æ—¥ç›®ã®${timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚'}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\n\nã€ŒOKã€: æ—¢å­˜ã®è³ªå•ã«æ–°ã—ã„è³ªå•ã‚’è¿½åŠ \nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: æ“ä½œã‚’ä¸­æ­¢\n\nä¸Šæ›¸ãã—ãŸã„å ´åˆã¯ã€ã¾ãšã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`);
                
                if (!choice) {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                }
                
                // æ—¢å­˜ã®è³ªå•ã«æ–°ã—ã„è³ªå•ã‚’è¿½åŠ 
                const existingIndex = surveys.findIndex(s => s.day === day && s.timing === timing);
                surveys[existingIndex].questions = [...surveys[existingIndex].questions, ...questions];
            }
        } else {
            // æ–°ã—ã„ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’è¿½åŠ 
            surveys.push({ day, timing, questions });
        }
        
        await saveSurveys();
        updateSurveyList();
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
        isEditingMode = false;
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('surveyDay').value = '1';
        document.querySelector('input[name="surveyTiming"][value="start"]').checked = true;
        const container = document.getElementById('questionsContainer');
        const questionItems = container.querySelectorAll('.question-item');
        questionItems.forEach((item, index) => {
            if (index > 0) item.remove(); // æœ€åˆã®è³ªå•ä»¥å¤–ã‚’å‰Šé™¤
        });
        if (questionItems.length > 0) {
            questionItems[0].querySelector('.question-text').value = '';
            questionItems[0].querySelector('.question-options').value = '';
        }
        
        alert('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
    }
    
    // æ—¢å­˜ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†ã™ã‚‹
    function editSurvey(day, timing) {
        const survey = surveys.find(s => s.day === day && s.timing === timing);
        if (!survey) {
            alert('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
        isEditingMode = true;
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ã®å€¤ã‚’è¨­å®š
        document.getElementById('surveyDay').value = day;
        document.querySelector(`input[name="surveyTiming"][value="${timing}"]`).checked = true;
        
        // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†ç”»é¢ã‚’è¡¨ç¤º
        showAdminScreen('adminSurveys');
        
        // æ—¢å­˜ã®è³ªå•ã‚’ã‚¯ãƒªã‚¢
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        
        // æ—¢å­˜ã®è³ªå•ã‚’èª­ã¿è¾¼ã¿
        survey.questions.forEach((question, index) => {
            addQuestion();
            const questionItems = container.querySelectorAll('.question-item');
            const currentItem = questionItems[questionItems.length - 1];
            
            currentItem.querySelector('.question-text').value = question.text;
            currentItem.querySelector('.question-type').value = question.type;
            
            if (question.options && (question.type === 'radio' || question.type === 'checkbox')) {
                currentItem.querySelector('.question-options').value = question.options.join('\n');
                currentItem.querySelector('.options-container').style.display = 'block';
            } else if (question.range && question.type === 'scale') {
                currentItem.querySelector('.scale-range').value = question.range;
                currentItem.querySelector('.scale-container').style.display = 'block';
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const typeSelect = currentItem.querySelector('.question-type');
            typeSelect.addEventListener('change', function() {
                const optionsContainer = currentItem.querySelector('.options-container');
                const scaleContainer = currentItem.querySelector('.scale-container');
                
                if (this.value === 'radio' || this.value === 'checkbox') {
                    optionsContainer.style.display = 'block';
                    scaleContainer.style.display = 'none';
                } else if (this.value === 'scale') {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'block';
                } else {
                    optionsContainer.style.display = 'none';
                    scaleContainer.style.display = 'none';
                }
            });
        });
        
        alert(`${day}æ—¥ç›®ã®${timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚'}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nè³ªå•ã‚’è¿½åŠ ãƒ»ä¿®æ­£å¾Œã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
    }
    
    // è³ªå•å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    function collectQuestionInputs() {
        const questions = [];
        const questionItems = document.querySelectorAll('.question-item');
        
        questionItems.forEach(item => {
            const text = item.querySelector('.question-text').value.trim();
            const type = item.querySelector('.question-type').value;
            
            if (!text) return; // ç©ºã®è³ªå•ã¯ã‚¹ã‚­ãƒƒãƒ—
            
            const question = { text, type };
            
            if (type === 'radio' || type === 'checkbox') {
                const optionsText = item.querySelector('.question-options').value.trim();
                question.options = optionsText ? optionsText.split('\n').filter(opt => opt.trim()) : [];
            } else if (type === 'scale') {
                question.range = item.querySelector('.scale-range').value;
            }
            
            questions.push(question);
        });
        
        return questions;
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°
    function updateSurveyList() {
        const list = document.getElementById('surveysList');
        if (!list) return;
        
        list.innerHTML = '';
        
        if (surveys.length === 0) {
            list.innerHTML = '<p style="color: #6c757d; text-align: center;">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        surveys.forEach((survey, index) => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const timingText = survey.timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚';
            
            item.innerHTML = `
                <h4 style="margin-bottom: 10px; color: #495057;">${survey.day}æ—¥ç›® ${timingText}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h4>
                <p style="margin-bottom: 15px; color: #6c757d;">è³ªå•æ•°: ${survey.questions.length}å•</p>
                <button class="btn editSurveyBtn" data-day="${survey.day}" data-timing="${survey.timing}" style="background: #28a745; font-size: 14px; padding: 8px 16px; margin-right: 10px;">ç·¨é›†</button>
                <button class="btn deleteSurveyBtn" data-index="${index}" style="background: #dc3545; font-size: 14px; padding: 8px 16px;">å‰Šé™¤</button>
            `;
            
            list.appendChild(item);
        });
        
        // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        list.querySelectorAll('.editSurveyBtn').forEach(btn => {
            btn.addEventListener('click', e => {
                const day = Number(e.currentTarget.dataset.day);
                const timing = e.currentTarget.dataset.timing;
                editSurvey(day, timing);
            });
        });
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        list.querySelectorAll('.deleteSurveyBtn').forEach(btn => {
            btn.addEventListener('click', e => {
                deleteSurvey(Number(e.currentTarget.dataset.index));
            });
        });
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å‰Šé™¤
    async function deleteSurvey(index) {
        if (!confirm('ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        surveys.splice(index, 1);
        await saveSurveys();
        updateSurveyList();
        alert('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã®èª­ã¿è¾¼ã¿ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    async function loadSurveyResultsForDisplay() {
        console.log('ğŸ”„ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        if (!supabase) {
            // SupabaseãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            surveyResults = results;
            updateParticipantSelect();
            console.log(`âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰${results.length}ä»¶ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('survey_results')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                // survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆ42P01ã‚¨ãƒ©ãƒ¼ï¼‰ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (error.code === '42P01') {
                    console.warn('âš ï¸ survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                    const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
                    surveyResults = results;
                    updateParticipantSelect();
                    console.log(`âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰${results.length}ä»¶ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    return;
                }
                throw error;
            }
            surveyResults = data || [];
            updateParticipantSelect();
            console.log(`âœ… Supabaseã‹ã‚‰${surveyResults.length}ä»¶ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            
            // ç”»é¢ã«çµæœãŒã‚ã‚Œã°æ›´æ–°
            if (document.getElementById('surveyResults')) {
                displaySurveyResults();
            }
            
        } catch (error) {
            console.error('âŒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            surveyResults = results;
            updateParticipantSelect();
            console.log(`âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰${results.length}ä»¶ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            // ç”»é¢ã«çµæœãŒã‚ã‚Œã°æ›´æ–°
            if (document.getElementById('surveyResults')) {
                displaySurveyResults();
            }
        }
    }
    
    // å‚åŠ è€…ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°ã‚’åˆ¥é–¢æ•°ã«åˆ†é›¢
    function updateParticipantSelect() {
        const participants = [...new Set(surveyResults.map(result => result.participant_id))];
        const select = document.getElementById('resultParticipant');
        if (select) {
            select.innerHTML = '<option value="">å…¨ã¦ã®å‚åŠ è€…</option>';
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿
    async function loadSurveyResults() {
        await loadSurveyResultsForDisplay();
        displaySurveyResults();
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’è¡¨ç¤º
    function displaySurveyResults() {
        const resultsDiv = document.getElementById('surveyResults');
        if (!resultsDiv) return;
        
        const participantFilter = document.getElementById('resultParticipant')?.value || '';
        const dayFilter = document.getElementById('resultDay')?.value || '';
        
        let filteredResults = surveyResults.filter(result => {
            return (!participantFilter || result.participant_id === participantFilter) &&
                   (!dayFilter || result.day?.toString() === dayFilter);
        });
        
        resultsDiv.innerHTML = '';
        
        if (filteredResults.length === 0) {
            resultsDiv.innerHTML = '<p style="color: #6c757d; text-align: center;">æ¡ä»¶ã«åˆè‡´ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }
        
        filteredResults.forEach(result => {
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 15px;';
            
            const timingText = result.timing === 'start' ? 'é–‹å§‹æ™‚' : 'çµ‚äº†æ™‚';
            const date = new Date(result.created_at).toLocaleString('ja-JP');
            
            let answersHtml = '';
            result.answers.forEach((answer, index) => {
                answersHtml += `<div style="margin-bottom: 10px;"><strong>Q${index + 1}:</strong> ${answer.question}<br><strong>å›ç­”:</strong> ${answer.answer}</div>`;
            });
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <span style="font-weight: 600;">å‚åŠ è€…: ${result.participant_id}</span>
                        <span style="margin-left: 10px; background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${result.day}æ—¥ç›® ${timingText}</span>
                    </div>
                    <div style="font-size: 14px; color: #6c757d;">${date}</div>
                </div>
                ${answersHtml}
            `;
            
            resultsDiv.appendChild(item);
        });
    }
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœä¿å­˜
    async function saveSurveyResult(resultData) {
        if (!supabase) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            const newResult = {
                id: Date.now(),
                participant_id: resultData.participantId,
                day: resultData.day,
                timing: resultData.timing,
                answers: resultData.answers,
                created_at: new Date().toISOString()
            };
            results.unshift(newResult);
            localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
            surveyResults = results;
            return;
        }
        
        try {
            const { error } = await supabase
                .from('survey_results')
                .insert({
                    participant_id: resultData.participantId,
                    day: resultData.day,
                    timing: resultData.timing,
                    answers: resultData.answers
                });
            
            if (error) {
                // survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆ42P01ã‚¨ãƒ©ãƒ¼ï¼‰ã¾ãŸã¯RLSé•åï¼ˆ42501ã‚¨ãƒ©ãƒ¼ï¼‰ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (error.code === '42P01') {
                    console.warn('âš ï¸ survey_resultsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                } else if (error.code === '42501') {
                    console.warn('âš ï¸ Supabase RLSãƒãƒªã‚·ãƒ¼é•åã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                }
                
                if (error.code === '42P01' || error.code === '42501') {
                    const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
                    const newResult = {
                        id: Date.now(),
                        participant_id: resultData.participantId,
                        day: resultData.day,
                        timing: resultData.timing,
                        answers: resultData.answers,
                        created_at: new Date().toISOString()
                    };
                    results.unshift(newResult);
                    localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
                    surveyResults = results;
                    console.log('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
                    return;
                }
                throw error;
            }
            console.log('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœä¿å­˜å®Œäº†');
        } catch (error) {
            console.error('âŒ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const results = JSON.parse(localStorage.getItem('mentalizeSurveyResults') || '[]');
            const newResult = {
                id: Date.now(),
                participant_id: resultData.participantId,
                day: resultData.day,
                timing: resultData.timing,
                answers: resultData.answers,
                created_at: new Date().toISOString()
            };
            results.unshift(newResult);
            localStorage.setItem('mentalizeSurveyResults', JSON.stringify(results));
            surveyResults = results;
            console.log('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
        }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
    window.deleteSurvey = deleteSurvey;
    window.showSurvey = showSurvey;
    window.saveSurveyResult = saveSurveyResult;
    </script>
</body>
</html>

